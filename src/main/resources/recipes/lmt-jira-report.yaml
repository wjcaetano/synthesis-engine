config:
  fresh: true
  transformDefaultParams:
    jolt:
      - "${#recipe['jolts']['joltNeo4jTableToJson']}"
    neo4j:
      - "http://localhost:7474/db/neo4j/tx/commit"
      - "${@Utils.createBasicAuthHeader('neo4j', 'select-shirt-judge-miguel-antonio-46')}"

  options:
    - name: clearDatabase
      type: BOOLEAN
      label: "Clear 'JiraReports' Nodes in database before anything?"
      defaultValue: false

    - name: jiraProjectKey
      type: TEXT
      label: "Jira Project Key"
      defaultValue: "LMT"

    - name: daysBack
      type: TEXT
      label: "Days to Analyze"
      defaultValue: 14

    - name: epicFilter
      type: TEXT
      label: "Epic Key Filter (optional)"
      defaultValue: ""

    - name: assigneeFilter
      type: TEXT
      label: "Assignee Filter (optional)"
      defaultValue: ""

    - name: maxPages
      type: TEXT
      label: "Max Pages to Fetch"
      defaultValue: 50

    - name: pageSize
      type: TEXT
      label: "Items Per Page"
      defaultValue: 50

  agents:
    - name: STRATEGY_AGENT
      provider: azure
      model: gpt-4o
      deploymentName: Chatbot
      temperature: 0.2
      maxTurns: 1

    - name: DAILY_SUMMARY_AGENT
      provider: azure
      model: gpt-4o
      deploymentName: Chatbot
      temperature: 0.7
      maxTurns: 2

    - name: BLOCKER_ANALYST
      provider: azure
      model: gpt-4o
      deploymentName: Chatbot
      temperature: 0.3
      maxTurns: 1
      tools: ["neo4jQuery"]

caches:
  transforms:
    - prompt
    - neo4j

executor: ProjectModelExecutor3.java

projectModel:
  _clearDatabase: ${#recipe['templates']['clearDatabase']}
  collectJiraData: "${#recipe['templates']['collectJiraIssues']}"
  enrichChangelogs: "${#recipe['templates']['enrichChangelogData']}"
  buildGraph: "${#recipe['templates']['buildGraph']}"
  analytics.json: "${#recipe['templates']['runAnalyticsQueries']}"
  llmInsights.json: "${#recipe['templates']['generateLLMInsights']}"
  daily-report.html: "${#recipe['templates']['generateHTMLReport']}"

vars:
  jiraHeaders:
    Authorization: "${@Utils.getEnvVariable('JIRA_AUTH_HEADER')}"
    Content-Type: "application/json"
    Accept: "application/json"
    X-Atlassian-Token: "no-check"
  jiraBaseURL: "https://ilabs-capco.atlassian.net/rest/api/3/search/jql"

models:
  JiraUser:
    "": "${#user}"
    labels: ["User", "JiraReport"]
    key: "${#self['accountId']}"
    name: "${#self['name']}"
    email: "${#self['email']}"

  JiraEpic:
    "": "${#epic}"
    labels: ["Epic", "JiraReport"]
    key: "${#self['key']}"
    name: "${#self['name']}"
    summary: "${#self['summary']}"
    status: "${#self['status']}"

  JiraStatusChange:
    "": "${#change}"
    labels: ["StatusChange", "JiraReport"]
    key: "${#self['issueKey'] + '|' + #self['date'] + '|' + #self['from'] + '->' + #self['to']}"
    issueKey: "${#self['issueKey']}"
    from: "${#self['from']}"
    to: "${#self['to']}"
    timestamp: "${#self['date']}"
    author: "${#self['author']}"

  JiraIssue:
    "": "${#issue}"
    labels: ["Issue", "JiraReport"]
    key: "${#self['issueKey']}"
    issueId: "${#self['issueId']}"
    issueUrl: "${#self['issueUrl']}"
    summary: "${#self['summary']}"
    description: "${#self['description']}"
    status: "${#self['status']}"
    type: "${#self['issueType']}"
    priority: "${#self['priority']}"
    createdDate: "${#self['createdDate']}"
    updatedDate: "${#self['updatedDate']}"
    duedate: "${#self['duedate']}"
    resolutiondate: "${#self['resolutiondate']}"
    storyPoints: "${#self['storyPoints']}"
    timeSpent: "${#self['timeSpent']}"
    originalEstimate: "${#self['originalEstimate']}"
    relationships: |-
      @@@freemarker
      <#assign rels = []>
      <#if issue.assignee?? && issue.assignee.accountId??>
        <#assign rels = rels + [{"label": "ASSIGNED_TO", "endKey": issue.assignee.accountId}]>
      </#if>
      <#if issue.reporter?? && issue.reporter.accountId??>
        <#assign rels = rels + [{"label": "REPORTED_BY", "endKey": issue.reporter.accountId}]>
      </#if>
      <#if issue.epicKey?? && issue.epicKey?has_content>
        <#assign rels = rels + [{"label": "BELONGS_TO_EPIC", "endKey": issue.epicKey}]>
      </#if>
      <#if issue.parentKey?? && issue.parentKey?has_content>
        <#assign rels = rels + [{"label": "CHILD_OF", "endKey": issue.parentKey}]>
      </#if>
      [<#list rels as rel>{"label":"${rel.label}","endKey":"${rel.endKey}"}<#if rel?has_next>,</#if></#list>]


jolts:
  joltNeo4jTableToJson: |-
    [
      {
        "operation": "shift",
        "spec": {
          "results": {
            "*": {
              "data": {
                "*": {
                  "row": {
                    "*": "[&2].@(4,columns[&0])"
                  }
                }
              }
            }
          }
        }
      }
    ]

  joltJiraToNormalized: |-
    [
      {
        "operation":"shift",
        "spec":{
          "*":{
            "id":"[&1].issueId",
            "key":"[&1].issueKey",
            "self":"[&1].issueUrl",
            "fields":{
              "summary":"[&2].summary",
              "issuetype":{
                "name":"[&2].issueType",
                "id":"[&2].issueTypeId"
              },
              "project":{
                "key":"[&2].projectKey",
                "name":"[&2].projectName",
                "id":"[&2].projectId"
              },
              "status":{
                "name":"[&2].status",
                "statusCategory":{
                  "name":"[&2].statusCategory"
                }
              },
              "priority":{
                "name":"[&2].priority"
              },
              "created":"[&2].createdDate",
              "updated":"[&2].updatedDate",
              "duedate":"[&2].duedate",
              "resolutiondate":"[&2].resolutiondate",
              "reporter":{
                "displayName":"[&2].reporter.name",
                "emailAddress":"[&2].reporter.email",
                "accountId":"[&2].reporter.accountId"
              },
              "assignee":{
                "displayName":"[&2].assignee.name",
                "emailAddress":"[&2].assignee.email",
                "accountId":"[&2].assignee.accountId"
              },
              "parent":{
                "key":"[&2].parentKey"
              },
              "customfield_10014":"[&2].epicKey",
              "customfield_10016":"[&2].storyPoints",
              "timetracking":{
                "timeSpentSeconds":"[&2].timeSpent",
                "originalEstimateSeconds":"[&2].originalEstimate"
              },
              "issuelinks":"[&2].links",
              "comment":{
                "comments":"[&2].comments"
              },
              "description":{
                "content":{
                  "*":{
                    "content":{
                      "*":{
                        "text":"[&5].description[]"
                      }
                    }
                  }
                }
              }
            },
            "changelog":{
              "histories":{
                "*":{
                  "created":"[&4].changeHistory[&1].date",
                  "author":{
                    "displayName":"[&5].changeHistory[&2].author"
                  },
                  "items":{
                    "*":{
                      "field":"[&6].changeHistory[&3].changes[&2].field",
                      "fromString":"[&6].changeHistory[&3].changes[&2].oldValue",
                      "toString":"[&6].changeHistory[&3].changes[&2].newValue"
                    }
                  }
                }
              }
            }
          }
        }
      },
      {
        "operation":"default",
        "spec":{
          "*":{
            "description":"No description provided.",
            "comments":[],
            "links":[],
            "storyPoints":"0",
            "timeSpent":"0",
            "originalEstimate":"0",
            "duedate":"",
            "resolutiondate":"",
            "assignee": {},
            "reporter": {}
          }
        }
      }
    ]


  joltEnrichChangelog: |-
    [
      {
        "operation":"shift",
        "spec":{
          "*":{
            "@":"[&1]",
            "changeHistory":{
              "*":{
                "changes":{
                  "*":{
                    "field":{
                      "status":{
                        "@(3,date)":"[&6].dailyStatusChanges[&3].date",
                        "@(2,oldValue)":"[&6].dailyStatusChanges[&3].from",
                        "@(2,newValue)":"[&6].dailyStatusChanges[&3].to",
                        "@(3,author)":"[&6].dailyStatusChanges[&3].author"
                      }
                    }
                  }
                }
              }
            }
          }
        }
      },
      {
        "operation":"shift",
        "spec":{
          "*":{
            "*":"[&1].&",
            "dailyStatusChanges":{
              "*":"[&3].dailyStatusChanges[&1]"
            }
          }
        }
      }
    ]
templates:
  jiraResolvedHeaders: |-
    @@@log("#00FF00Resolving Jira API headers...")
    @@@spel("${#recipe['vars']['jiraHeaders']}")
    @@@set("jiraHeaders")
    @@@jsonify
    @@@objectify
    @@@exec(${#jiraHeaders['Authorization']})
    @@@set("auth")
    @@@spel("${#jiraHeaders['Authorization'] = #auth}")
  jiraPaginationConfig: |-
    @@@log("#00FF00Setting up Jira pagination configuration...")
    @@@freemarker
    @@@objectify
    @@@set("paginationConfig")
    {
      "type": "CURSOR",
      "nextTokenField": "nextPageToken",
      "isLastField": "isLast",
      "itemsPath": "$.issues",
      "pageSize": ${$api.configs.options.pageSize!50},
      "maxPages": ${$api.configs.options.maxPages!50},
      "rateLimitDelaysMs": 200
    }
  jqlBuild: |-
    @@@log("#00FF00Building JQL query...")
    @@@freemarker
    @@@set("jqlQueryParts")
    @@@spel("${#jqlQueryParts.trim()}")
    @@@set("jqlQuery")
    <#assign projectKey = $api.configs.options.jiraProjectKey!"LMT">
    <#assign daysBack = $api.configs.options.daysBack!14>
    <#assign parts = []>
    <#assign parts = parts + ["project = " + projectKey]>
    <#assign parts = parts + ["updated >= '-" + daysBack + "d'"]>

    <#if ($api.configs.options.epicFilter)?? && $api.configs.options.epicFilter?has_content>
    <#assign parts = parts + ["'Epic Link' = " + $api.configs.options.epicFilter]>
    </#if>

    <#if ($api.configs.options.assigneeFilter)?? && $api.configs.options.assigneeFilter?has_content>
    <#assign parts = parts + ["assignee = " + $api.configs.options.assigneeFilter]>
    </#if>

    ${parts?join(" AND ")} ORDER BY updated DESC
  jqlBuildEpics: |-
    @@@log("#00FF00Building JQL query for Epics...")
    @@@freemarker
    @@@set("jqlQueryEpicsParts")
    @@@spel("${#jqlQueryEpicsParts.trim()}")
    @@@set("jqlQueryEpics")
    <#assign projectKey = $api.configs.options.jiraProjectKey!"LMT">
    <#assign daysBack = $api.configs.options.daysBack!14>
    <#assign parts = []>
    <#assign parts = parts + ["project = " + projectKey]>
    <#assign parts = parts + ["issuetype = Epic"]>
    <#assign parts = parts + ["updated >= '-" + daysBack + "d'"]>

    <#if ($api.configs.options.epicFilter)?? && $api.configs.options.epicFilter?has_content>
    <#assign parts = parts + ["key = " + $api.configs.options.epicFilter]>
    </#if>

    ${parts?join(" AND ")} ORDER BY updated DESC
  jiraPayloadBuild: |-
    @@@freemarker
    @@@objectify
    @@@set("jiraPayloadTemplate")
    {
      "jql": "${jqlQuery}",
      "fields": [
        "summary",
        "description",
        "status",
        "assignee",
        "project",
        "reporter",
        "issuetype",
        "priority",
        "duedate",
        "resolutiondate",
        "parent",
        "timetracking",
        "issuelinks",
        "created",
        "updated",
        "comment",
        "customfield_10016",
        "customfield_10014"
      ],
      "expand": "names, changelog, renderedFields",
      "maxResults": ${$api.configs.options.pageSize!50}
    }
  collectJiraIssues: |-
    @@@log("#00FF00Starting Jira data collection using Template pagination...")
    @@@exec("${#recipe['templates']['jqlBuild']}")
    @@@log("${'JQL Query: ' + #jqlQuery}")
    @@@exec("${#recipe['templates']['jiraResolvedHeaders']}")
    @@@log("${'Jira Headers: ' + #jiraHeaders}")
    @@@exec("${#recipe['templates']['jiraPayloadBuild']}")
    @@@log("${'Jira Payload: ' + #jiraPayloadTemplate}")
    @@@exec("${#recipe['templates']['jiraPaginationConfig']}")
    @@@log("${'Pagination Config: ' + #paginationConfig}")
    @@@api("${#recipe['vars']['jiraBaseURL']}", "POST", "${#jiraPayloadTemplate}", "${#jiraHeaders}", "${#paginationConfig}")
    @@@objectify
    @@@set("rawApiResult")
    @@@log("${'#00FFFFPagination finished. Total items: ' + #rawApiResult['totalItems']}")
    @@@spel("${#rawApiResult['items']}")
    @@@jsonify
    @@@set("rawIssues")
    @@@jolt("${#recipe['jolts']['joltJiraToNormalized']}")
    @@@set("normalizedIssues")
    @@@jsonify
  enrichChangelogData: |-
    @@@log("#00FF00Enriching changelog data with daily status changes...")
    @@@spel("${#normalizedIssues}")
    @@@jsonify
    @@@jolt("${#recipe['jolts']['joltEnrichChangelog']}")
    @@@set("enrichedIssues")

  clearDatabase: |-
    @@@log("#00FF00Clearing JiraReports nodes from Neo4j database...")
    @@@neo4j
    @@@jsonify
    MATCH (n)
    WHERE n:JiraReport
    DETACH DELETE n;
  persistStatusChanges: |-
    @@@log("#00FF00Persisting status changes...")
    @@@spel("${#enrichedIssues}")
    @@@freemarker
    @@@jsonify
    @@@set("allStatusChanges")
    @@@repeat("${#allStatusChanges}", "change", "${#recipe['templates']['enrichStatusChange']}")
    @@@jsonify
    <#assign allChanges = []>
    <#list enrichedIssues as issue>
      <#if issue.dailyStatusChanges?? && issue.dailyStatusChanges?has_content>
        <#list issue.dailyStatusChanges as change>
          <#assign allChanges = allChanges + [{
            "issueKey": issue.issueKey,
            "date": change.date,
            "from": change.from,
            "to": change.to,
            "author": change.author
          }]>
        </#list>
      </#if>
    </#list>
    ${allChanges}
  enrichStatusChange: |-
    @@@objectify("${#recipe['models']['JiraStatusChange']}")
    @@@set("enrichedStatusChange")
    @@@nodify
    @@@neo4j
    @@@jsonify
  buildGraph: |-
    @@@log("#00FF00Starting Neo4j Graph Build with new strategy...")
    @@@exec("${#recipe['templates']['persistUsers']}")
    @@@exec("${#recipe['templates']['persistEpics']}")
    @@@exec("${#recipe['templates']['persistStatusChanges']}")
    @@@exec("${#recipe['templates']['persistIssues']}")
    @@@set("graphBuildResult")
    @@@jsonify
  persistUsers: |-
    @@@log("#00FF00Extracting and persisting unique users...")
    @@@spel("${#enrichedIssues}")
    @@@freemarker
    @@@jsonify
    @@@set("allUsers")
    @@@repeat("${#allUsers}", "user", "${#recipe['templates']['enrichUser']}")
    @@@jsonify
    <#assign users = []>
    <#list enrichedIssues as issue>
      <#if issue.assignee?? && issue.assignee.accountId??>
        <#assign found = false>
        <#list users as u>
          <#if u.accountId?? && u.accountId == issue.assignee.accountId>
            <#assign found = true>
            <#break>
          </#if>
        </#list>
        <#if !found>
          <#assign users = users + [issue.assignee]>
        </#if>
      </#if>
      <#if issue.reporter?? && issue.reporter.accountId??>
        <#assign found = false>
        <#list users as u>
          <#if u.accountId?? && u.accountId == issue.reporter.accountId>
            <#assign found = true>
            <#break>
          </#if>
        </#list>
        <#if !found>
          <#assign users = users + [issue.reporter]>
        </#if>
      </#if>
    </#list>
    ${users}
  enrichUser: |-
    @@@objectify("${#recipe['models']['JiraUser']}")
    @@@set("enrichedUser")
    @@@nodify
    @@@neo4j
    @@@jsonify
  persistEpics: |-
    @@@log("#00FF00Extracting and persisting unique epics...")
    @@@spel("${#enrichedIssues}")
    @@@freemarker
    @@@jsonify
    @@@set("allEpics")
    @@@repeat("${#allEpics}", "epic", "${#recipe['templates']['enrichEpic']}")
    @@@jsonify
    <#assign epics = []>
    <#list enrichedIssues as issue>
      <#if issue.epicKey?? && issue.epicKey?has_content>
        <#assign found = false>
        <#list epics as e>
          <#if e.key?? && e.key == issue.epicKey>
            <#assign found = true>
            <#break>
          </#if>
        </#list>
        <#if !found>
          <#assign epics = epics + [{
            "key": issue.epicKey,
            "name": issue.epicName!'Unknown Epic',
            "summary": issue.epicSummary!'',
            "status": issue.epicStatus!'Unknown'
          }]>
        </#if>
      </#if>
    </#list>
    ${epics}

  enrichEpic: |-
    @@@objectify("${#recipe['models']['JiraEpic']}")
    @@@set("enrichedEpic")
    @@@nodify
    @@@neo4j
    @@@jsonify
  persistIssues: |-
    @@@log("#00FF00Persisting all issues with relationships...")
    @@@spel("${#enrichedIssues}")
    @@@repeat("${#content}", "issue", "${#recipe['templates']['enrichIssue']}")
    @@@jsonify
  enrichIssue: |-
    @@@log("${'#00FF00Enriching and persisting issue: ' + #issue['issueKey']}")
    @@@objectify("${#recipe['models']['JiraIssue']}")
    @@@set("enrichedIssue")
    @@@nodify
    @@@neo4j
    @@@jsonify
  runAnalyticsQueries: |-
    @@@log("#00FF00Running analytical queries...")
    @@@_exec("${#recipe['templates']['query.dailyTimeline']}")
    @@@_exec("${#recipe['templates']['query.blockerAnalysis']}")
    @@@_exec("${#recipe['templates']['query.userPerformance']}")
    @@@_exec("${#recipe['templates']['query.epicProgress']}")
    @@@_exec("${#recipe['templates']['query.velocityTrends']}")
    @@@exec("${#recipe['templates']['buildAnalyticsMap']}")
    @@@jsonify

  buildAnalyticsMap: |-
    @@@log("#00FF00Building analytics result map...")
    @@@spel("${new java.util.LinkedHashMap([('dailyTimeline'): (#dailyTimeline != null ? #dailyTimeline : T(java.util.Collections).emptyList())])}")
    @@@set("result")
    @@@spel("${#result.put('blockerAnalysis', #blockerAnalysis != null ? #blockerAnalysis : T(java.util.Collections).emptyList())}")
    @@@spel("${#result.put('userPerformance', #userPerformance != null ? #userPerformance : T(java.util.Collections).emptyList())}")
    @@@spel("${#result.put('epicProgress', #epicProgress != null ? #epicProgress : T(java.util.Collections).emptyList())}")
    @@@spel("${#result.put('velocityTrends', #velocityTrends != null ? #velocityTrends : T(java.util.Map).of())}")
    @@@get("result")
  query.dailyTimeline: |-
    @@@log("#00FF00Executing Daily Timeline Query...")
    @@@freemarker
    @@@set("cypherQuery")
    @@@neo4j
    @@@jolt("${#recipe['jolts']['joltNeo4jTableToJson']}")
    @@@set("dailyTimeline")
    @@@jsonify
    MATCH (sc:StatusChange)-[:CHANGED]->(i:Issue)
    WHERE date(sc.timestamp) >= date() - duration({days: ${$api.configs.options.daysBack!14}})
    WITH date(sc.timestamp) AS day,
         sc.to AS toStatus,
         sc.from AS fromStatus,
         i.key AS issueKey,
         i.summary AS issueSummary,
         sc.author AS author
    ORDER BY day DESC
    WITH day,
         collect({
           issueKey: issueKey,
           summary: issueSummary,
           fromStatus: fromStatus,
           toStatus: toStatus,
           author: author
         }) AS changes
    RETURN day AS date,
           size([c IN changes WHERE c.toStatus = 'Done']) AS doneCount,
           size([c IN changes WHERE c.toStatus = 'In Progress' AND c.fromStatus = 'To Do']) AS startedCount,
           size([c IN changes WHERE c.toStatus CONTAINS 'Block']) AS blockerCount,
           changes AS issues,
           size(changes) AS totalChanges
    ORDER BY day DESC
    LIMIT ${$api.configs.options.daysBack!14}
  query.blockerAnalysis: |-
    @@@log("#00FF00Executing Blocker Analysis Query...")
    @@@neo4j
    @@@jolt
    @@@set("blockerAnalysis")
    @@@jsonify
    MATCH (i:Issue)
    WHERE i.status IN ['Blocked', 'On Hold']
    RETURN i.key AS blockedKey,
           i.summary AS blockedSummary,
           i.status AS blockedStatus,
           [] AS blockerIssues,
           0 AS daysBlocked,
           'LOW' AS severity,
           0 AS impactScore
    LIMIT 10
  query.userPerformance: |-
    @@@log("#00FF00Executing User Performance Query...")
    @@@neo4j
    @@@jolt
    @@@set("userPerformance")
    @@@jsonify
    MATCH (u:User)<-[:ASSIGNED_TO]-(i:Issue)
    WITH u,
         count(DISTINCT i) AS totalIssues,
         count(DISTINCT CASE WHEN i.status = 'Done' THEN i END) AS completedIssues,
         count(DISTINCT CASE WHEN i.status = 'In Progress' THEN i END) AS inProgress,
         count(DISTINCT CASE WHEN i.status = 'To Do' THEN i END) AS todoIssues,
         sum(CASE WHEN i.storyPoints IS NOT NULL THEN toInteger(i.storyPoints) ELSE 0 END) AS totalPoints,
         sum(CASE WHEN i.status = 'Done' AND i.storyPoints IS NOT NULL THEN toInteger(i.storyPoints) ELSE 0 END) AS completedPoints
    RETURN u.accountId AS userId,
           u.name AS displayName,
           totalIssues,
           completedIssues,
           inProgress,
           todoIssues,
           totalPoints,
           completedPoints,
           round(completedPoints * 1.0 / CASE WHEN 30 > 0 THEN 30 ELSE 1 END, 2) AS avgVelocity,
           0 AS activeDaysCount
    ORDER BY completedPoints DESC
  query.epicProgress: |-
    @@@log("#00FF00Executing Epic Progress Query...")
    @@@neo4j
    @@@jolt
    @@@set("epicProgress")
    @@@jsonify
    MATCH (e:Epic)<-[:BELONGS_TO_EPIC]-(i:Issue)
    WITH e,
         count(i) AS total,
         count(CASE WHEN i.status = 'Done' THEN 1 END) AS done,
         count(CASE WHEN i.status = 'In Progress' THEN 1 END) AS inProgress,
         count(CASE WHEN i.status = 'To Do' THEN 1 END) AS todo,
         sum(CASE WHEN i.storyPoints IS NOT NULL THEN toInteger(i.storyPoints) ELSE 0 END) AS totalPoints,
         sum(CASE WHEN i.status = 'Done' AND i.storyPoints IS NOT NULL THEN toInteger(i.storyPoints) ELSE 0 END) AS donePoints
    WITH e, total, done, inProgress, todo, totalPoints, donePoints,
         round(100.0 * done / CASE WHEN total > 0 THEN total ELSE 1 END, 2) AS completionPct,
         round(100.0 * donePoints / CASE WHEN totalPoints > 0 THEN totalPoints ELSE 1 END, 2) AS pointsPct
    RETURN e.key AS epicKey,
           e.name AS epicName,
           e.status AS epicStatus,
           total AS totalIssues,
           done AS doneCount,
           inProgress AS inProgressCount,
           todo AS todoCount,
           totalPoints,
           donePoints,
           completionPct,
           pointsPct,
           0.0 AS avgCycleTimeDays,
           CASE
             WHEN completionPct >= 90 THEN 'ON_TRACK'
             WHEN completionPct >= 70 THEN 'AT_RISK'
             ELSE 'DELAYED'
           END AS healthStatus
    ORDER BY completionPct ASC
  query.velocityTrends: |-
    @@@log("#00FF00Executing Velocity Trends Query...")
    @@@neo4j
    @@@jolt
    @@@set("velocityTrends")
    @@@jsonify
    MATCH (sc:StatusChange)-[:CHANGED]->(i:Issue)
    WHERE sc.to = 'Done'
      AND date(sc.timestamp) >= date() - duration({days: 30})
    WITH date(sc.timestamp) AS completionDate,
         sum(CASE WHEN i.storyPoints IS NOT NULL THEN toInteger(i.storyPoints) ELSE 1 END) AS pointsCompleted,
         count(DISTINCT i) AS issuesCompleted
    WITH collect({
           date: completionDate,
           points: pointsCompleted,
           issues: issuesCompleted
         }) AS dailyData
    RETURN dailyData,
           reduce(total = 0, d IN dailyData | total + d.points) AS totalPoints,
           reduce(total = 0, d IN dailyData | total + d.issues) AS totalIssues,
           round(reduce(total = 0, d IN dailyData | total + d.points) * 1.0 / 30, 2) AS avgDailyVelocity
  generateLLMInsights: |-
    @@@log("#00FF00Generating LLM insights...")
    @@@freemarker
    @@@agent("STRATEGY_AGENT")
    @@@extractMarkdownCode
    @@@objectify
    @@@set("strategyInsights")
    @@@_exec("${#recipe['templates']['llm.dailySummaries']}")
    @@@_exec("${#recipe['templates']['llm.blockerRecommendations']}")
    @@@_exec("${#recipe['templates']['llm.executiveSummary']}")
    @@@spel("${T(java.util.Map).of(
      'strategy', #strategyInsights,
      'dailySummaries', #dailySummaries,
      'blockerRecommendations', #blockerRecommendations,
      'executiveSummary', #executiveSummary
      )}")
    @@@jsonify
    You are a senior project management consultant analyzing Jira project data.
  
    Based on the analytics data below, provide strategic insights:
    
    [ANALYTICS DATA]
    Daily Timeline: ${@JsonUtils.writeAsJsonString(#dailyTimeline, true)}
    Blockers: ${@JsonUtils.writeAsJsonString(#blockerAnalysis, true)}
    User Performance: ${@JsonUtils.writeAsJsonString(#userPerformance, true)}
    Epic Progress: ${@JsonUtils.writeAsJsonString(#epicProgress, true)}
    Velocity: ${@JsonUtils.writeAsJsonString(#velocityTrends, true)}
    
    [REQUIRED OUTPUT]
    Return a JSON object with:
      {
        "focusAreas": ["area1", "area2", "area3"],
        "criticalIssues": [
          {"key": "ISSUE-123", "reason": "Blocking 5 other issues for 8 days"}
        ],
        "recommendations": [
          {"priority": "HIGH", "action": "...", "impact": "..."}
        ],
        "positiveTrends": ["trend1", "trend2"],
        "risksIdentified": ["risk1", "risk2"]
      }
  llm.dailySummaries: |-
    @@@freemarker
    @@@repeat("{#dailyTimeline}", "day", "
    {#recipe['templates']['llm.summarizeDay']}")
    @@@set("dailySummaries")
    @@@jsonify

  llm.summarizeDay: |-
    @@@freemarker
    @@@agent("DAILY_SUMMARY_AGENT")
    @@@set("daySummary")
    @@@_spel("${#day.put('llmSummary', #daySummary)}")
    Create a concise Daily Standup summary for ${day.date}:
    
    [DAY DATA]
    ${@JsonUtils.writeAsJsonString(#day, true)}
    
    [FORMAT]
    - 3-5 bullet points maximum
    - Focus on: completions, new starts, blockers
    - Mention critical comments if any
    - Highlight anomalies (unusually high/low activity)
    - Professional, action-oriented tone
  llm.blockerRecommendations: |-
    @@@freemarker
    @@@agent("BLOCKER_ANALYST")
    @@@extractMarkdownCode
    @@@objectify
    @@@set("blockerRecommendations")
    @@@jsonify
    Analyze the blocker chain and recommend resolution order:
    
    [BLOCKERS]
    ${@JsonUtils.writeAsJsonString(#blockerAnalysis, true)}
    
    [GRAPH CONTEXT]
    You have access to the Neo4j graph. Use the neo4jQuery tool to explore:
    - Issue dependencies (DEPENDS_ON relationships)
    - Cascading impacts (issues blocked by blockers)
    - Historical blocker resolution times
    
    [OUTPUT]
    For each blocker, provide:
    {
      "issueKey": "...",
      "resolutionPriority": 1-10,
      "suggestedAction": "...",
      "estimatedImpact": "...",
      "alternativePaths": ["..."]
    }
  llm.executiveSummary: |-
    @@@freemarker
    @@@agent("STRATEGY_AGENT")
    @@@set("executiveSummary")
    Create an executive summary for management (200-300 words):
    
    [PROJECT HEALTH]
    - Overall completion: ${#epicProgress.![#this.completionPct].stream().average().orElse(0)}%
    - Active blockers: ${#blockerAnalysis.size()}
    - Velocity trend: ${#velocityTrends.avgDailyVelocity} pts/day
    
    [FULL CONTEXT]
    ${@JsonUtils.writeAsJsonString(#strategyInsights, true)}
    
    [TONE]
    - Executive-level (CEO/CTO audience)
    - Data-driven, not speculative
    - Include 2-3 specific action items
    - Mention both risks and wins
  generateHTMLReport: |-
    @@@freemarker
    <!DOCTYPE html>
    <html lang="en">
      <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Daily Project Report - {api.configs.options.jiraProjectKey}</title>
        <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0"></script>
        <script src="https://cdn.jsdelivr.net/npm/date-fns@2.30.0"></script>
        <style>
          :root {
            --primary: #0ea5e9;
            --danger: #dc2626;
            --warning: #f59e0b;
            --success: #10b981;
            --bg: #f8fafc;
            --card: #ffffff;
            --text: #1e293b;
            --border: #e2e8f0;
          }
      
          * {
              margin:
                0;
              padding:
                0;
              box-sizing: border-box;
          }
      
          body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
          }
          
          .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
          }
      
          header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            border-radius: 16px;
            margin-bottom: 2rem;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
          }
          
          header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
          }
          
          header .meta {
            opacity: 0.9;
            font-size: 1.1rem;
          }
          
          .filters {
            background: var(--card);
            padding: 1.5rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
          }
          
          .filters select,
          .filters input {
            padding: 0.75rem 1rem;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s;
          }
          
          .filters select:focus,
          .filters input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
          }
          
          .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
          }
          
          .card {
            background: var(--card);
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s, box-shadow 0.2s;
          }
          
          .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
          }
          
          .card h3 {
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #64748b;
            margin-bottom: 0.5rem;
          }
          
          .card .metric {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary);
            display: block;
            margin-bottom: 0.5rem;
          }
          
          .card .trend {
            font-size: 0.875rem;
            font-weight: 600;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            display: inline-block;
          }
          
          .trend.up {
            background: #dcfce7;
            color: #166534;
          }
          
          .trend.down {
            background: #fee2e2;
            color: #991b1b;
          }
          
          .blocker-alert {
            border-left: 4px solid var(--danger);
            animation: pulse 2s infinite;
          }
          
          @keyframes pulse {
              
            0%,
            100% {
              opacity: 1;
            }
          
            50% {
              opacity: 0.8;
            }
          }
          
          .timeline {
            background: var(--card);
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
          }
          
          .timeline h2 {
            font-size: 1.75rem;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
          }
          
          .timeline-item {
            position: relative;
            padding-left: 3rem;
            padding-bottom: 2rem;
            border-left: 3px solid var(--border);
          }
          
          .timeline-item:last-child {
            border-left: none;
          }
          
          .date-marker {
            position: absolute;
            left: -1.5rem;
            background: var(--primary);
            color: white;
            width: 3rem;
            height: 3rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.875rem;
            box-shadow: 0 4px 12px rgba(14, 165, 233, 0.3);
          }
          
          .timeline-item .summary {
            background: #f1f5f9;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            font-style: italic;
            color: #475569;
          }
          
          .badge {
            display: inline-block;
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 600;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
          }
          
          .badge.done {
            background: #dcfce7;
            color: #166534;
          }
          
          .badge.started {
            background: #dbeafe;
            color: #1e40af;
          }
          
          .badge.blocker {
            background: #fee2e2;
            color: #991b1b;
          }
          
          details {
            margin-top: 1rem;
            cursor: pointer;
          }
          
          details summary {
            font-weight: 600;
            color: var(--primary);
            user-select: none;
          }
          
          details ul {
            margin-top: 0.5rem;
            padding-left: 1.5rem;
          }
          
          details li {
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--border);
          }
          
          details li:last-child {
            border-bottom: none;
          }
          
          .status-change {
            background: #f1f5f9;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.875rem;
            margin-left: 0.5rem;
          }
          
          table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
          }
          
          th,
          td {
            text-align: left;
            padding: 1rem;
            border-bottom: 1px solid var(--border);
          }
          
          th {
            background: #f8fafc;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.05em;
            color: #64748b;
          }
          
          tr:hover {
            background: #f8fafc;
          }
          
          .severity-CRITICAL {
            background: #fef2f2 !important;
          }
          
          .severity-HIGH {
            background: #fff7ed !important;
          }
          
          .impact-badge {
            padding: 0.35rem 0.75rem;
            border-radius: 12px;
            font-weight: 700;
            font-size: 0.875rem;
          }
          
          .impact-badge.CRITICAL {
            background: #dc2626;
            color: white;
          }
          
          .impact-badge.HIGH {
            background: #f59e0b;
            color: white;
          }
          
          .impact-badge.MEDIUM {
            background: #eab308;
            color: white;
          }
          
          .impact-badge.LOW {
            background: #94a3b8;
            color: white;
          }
          
          .insight-box {
            background: var(--card);
            padding: 2rem;
            border-radius: 12px;
            margin-bottom: 1.5rem;
            border-left: 4px solid var(--primary);
          }
          
          .insight-box h3 {
            margin-bottom: 1rem;
            font-size: 1.5rem;
          }
          
          .llm-generated {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-left-color: #f59e0b;
          }
          
          .user-card {
            background: var(--card);
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
          }
          
          .user-card h4 {
            margin-bottom: 1rem;
            font-size: 1.25rem;
          }
          
          .user-card .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-bottom: 1rem;
          }
          
          .user-card .stats div {
            text-align: center;
          }
          
          .user-card .stats label {
            display: block;
            font-size: 0.75rem;
            color: #64748b;
            margin-bottom: 0.25rem;
          }
          
          .user-card .stats span {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
          }
          
          .progress-bar {
            background: #e2e8RetryWC f0;
            height: 1.5rem;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
          }
          
          .progress-bar .fill {
            background: linear-gradient(90deg, var(--success) 0%, var(--primary) 100%);
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 0.875rem;
            transition: width 0.5s ease;
          }
          
          .forecast-ON_TRACK {
            color: var(--success);
            font-weight: 600;
          }
          
          .forecast-AT_RISK {
            color: var(--warning);
            font-weight: 600;
          }
          
          .forecast-DELAYED {
            color: var(--danger);
            font-weight: 600;
          }
          
          canvas {
            max-height: 300px;
          }
          
          footer {
            text-align: center;
            padding: 2rem;
            color: #64748b;
            font-size: 0.875rem;
          }
        </style>
      </head>
      <body>
        <div class="container">
          <header>
            <h1>ðŸ“Š Daily Project Report</h1>
            <div class="meta">
              Project:
              <strong>${$api.configs.options.jiraProjectKey}</strong>
              â€¢                 Generated:
              <strong>${.now?string("yyyy-MM-dd HH:mm")}</strong>
              â€¢                 Period:
              <strong>Last ${$api.configs.options.daysBack} days</strong>
            </div>
          </header>
          <section class="filters">
            <select id="epicFilter">
              <option value="all">All Epics</option>
              <#list epicProgress as epic>
              <option value="${epic.epicKey}">${epic.epicName}</option>
            </select>
            <select id="userFilter">
              <option value="all">All Users</option>
              <#list userPerformance as user>
              <option value="${user.userId}">${user.displayName}</option>
            </select>
            <input type="date" id="dateFrom" value="${(.now?date - $api.configs.options.daysBack)?string(" yyyy-mm-dd")}"="">
            <input type="date" id="dateTo" value="${.now?string(" yyyy-mm-dd")}"="">
            <button onclick="applyFilters()" style="padding: 0.75rem 1.5rem; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
              Apply Filters
            </button>
          </section>
          <section class="grid">
            <div class="card">
              <h3>Avg Velocity (30d)</h3>
              <span class="metric">${velocityTrends.avgDailyVelocity}</span>
              <span class="detail">pts/day</span>
              <#assign velocityChange=(velocityTrends.avgDailyVelocity - 5.0) / 5.0 * 100>
              <span class="trend ${velocityChange gt 0?then('up', 'down')}">
                ${velocityChange gt 0?then('â†‘', 'â†“')} ${velocityChange?abs?string["0.0"]}%
              </span>
            </div>
            <div class="card blocker-alert">
              <h3>Active Blockers</h3>
              <span class="metric">${blockerAnalysis?size}</span>
              <span class="detail">
                ${blockerAnalysis?filter(b -> b.severity == "CRITICAL")?size} critical
              </span>
            </div>
            <div class="card">
              <h3>Team Velocity</h3>
              <span class="metric">${velocityTrends.totalPoints}</span>
              <span class="detail">${velocityTrends.totalIssues} issues completed</span>
            </div>
            <div class="card">
              <h3>Avg Epic Progress</h3>
              <#assign avgCompletion=epicProgress?map(e -> e.completionPct)?sum / epicProgress?size>
              <span class="metric">${avgCompletion?string["0.0"]}%</span>
              <canvas id="completionDonut" style="max-height: 80px; margin-top: 1rem;"></canvas>
            </div>
          </section>
          <section class="timeline">
            <h2>ðŸ“… Daily Evolution</h2>
            <#list dailyTimeline as day>
            <div class="timeline-item" data-date="${day.date}">
              <div class="date-marker">
                ${day.date?date?string("dd")}
              </div>
              <div class="events">
                <h4 style="margin-bottom: 0.5rem; font-size: 1.25rem;">
                  ${day.date?date?string("EEEE, MMMM dd, yyyy")}
                </h4>
                <#if day.llmSummary??>
                <div class="summary">
                  ${day.llmSummary}
                </div>
                <div class="changes">
                  <span class="badge done">âœ… ${day.doneCount} completed</span>
                  <span class="badge started">ðŸš€ ${day.startedCount} started</span>
                  <#if day.blockerCount gt 0>
                  <span class="badge blocker">ðŸš« ${day.blockerCount} blockers</span>
                </div>
                <details>
                  <summary>View issues (${day.totalChanges})</summary>
                  <ul>
                    <#list day.issues as issue>
                    <li>
                      <a href="https://your-jira-instance.atlassian.net/browse/${issue.issueKey}" target="_blank" style="color: var(--primary); text-decoration: none; font-weight: 600;">
                          ${issue.issueKey}
                      </a>
                      ${issue.summary}
                      <span class="status-change">
                        ${issue.fromStatus} â†’ ${issue.toStatus}
                      </span>
                      <small style="color: #64748b;">by ${issue.author}</small>
                    </li>
                    
                    <!--#list-->
                  </ul>
                </details>
              </div>
            </div>
          </section>
          <section class="card" style="margin-bottom: 2rem;">
            <h2 style="margin-bottom: 1rem;">ðŸš« Blocker Analysis</h2>
            <#if blockerAnalysis?size==0>
            <div style="padding: 2rem; text-align: center; color: #64748b;">
              <p style="font-size: 1.25rem;">ðŸŽ‰ No active blockers!</p>
              <p>All issues are unblocked and ready to progress.</p>
            </div>
            <#else><#if blockerRecommendations??><#list blockerAnalysis as blocker>   <#if blockerRecommendations??>
            <table>
              <thead>
              <tr>
                <th>Blocked Issue</th>
                <th>Blocked By</th>
                <th>Days Blocked</th>
                <th>Severity</th>
                <th>Impact Score</th>
                <th>Recommendation</th>
              </tr>
              </thead>
              <tbody>
              <tr class="severity-${blocker.severity}">
                <td>
                  <a href="https://your-jira-instance.atlassian.net/browse/${blocker.blockedKey}" target="_blank" style="color: var(--primary); font-weight: 600; text-decoration: none;">
                    ${blocker.blockedKey}
                  </a>
                  <br>
                  <small style="color: #64748b;">${blocker.blockedSummary}</small>
                </td>
                <td>
                  <#list blocker.blockerIssues as blockerIssue>
                  <div style="margin-bottom: 0.5rem;">
                    <a href="https://your-jira-instance.atlassian.net/browse/${blockerIssue.key}" target="_blank" style="color: var(--primary); text-decoration: none;">
                      ${blockerIssue.key}
                    </a>
                    <span class="badge" style="background: #f1f5f9; color: #475569;">
                      ${blockerIssue.status}
                    </span>
                  </div>
                  
                  <!--#list-->
                </td>
                <td>
                  <strong style="font-size: 1.25rem; color: var(--danger);">
                    ${blocker.daysBlocked}
                  </strong>
                  days
                </td>
                <td>
                  <span class="impact-badge ${blocker.severity}">
                    ${blocker.severity}
                  </span>
                </td>
                <td>
                  <strong>${blocker.impactScore}</strong>
                </td>
                <td>
                  <#assign recommendation=blockerRecommendations?filter(r -> r.issueKey == blocker.blockedKey)?first!"">                                                 <#if recommendation?has_content>                                                     ${recommendation.suggestedAction}
                  <!--#if-->
                </td>
                
                <!--#if-->
              </tr>
              
              <!--#list-->
              </tbody>
            </table>
            
            <!--#if-->
          </section>
          <!-- Epic Progress -->
          <section class="card" style="margin-bottom: 2rem;">
            <h2 style="margin-bottom: 1rem;">ðŸŽ¯ Epic Progress</h2>
            <div style="margin-bottom: 2rem; max-width: 600px; margin-left: auto; margin-right: auto;">
              <canvas id="epicRadar"></canvas>
            </div>
            <#list epicProgress as epic>
            <table>
              <thead>
              <tr>
                <th>Epic</th>
                <th>Issues</th>
                <th>Progress</th>
                <th>Story Points</th>
                <th>Avg Cycle Time</th>
                <th>Health</th>
              </tr>
              </thead>
              <tbody>
              <tr>
                <td>
                  <a href="https://your-jira-instance.atlassian.net/browse/${epic.epicKey}" target="_blank" style="color: var(--primary); font-weight: 600; text-decoration: none;">
                    ${epic.epicKey}
                  </a>
                  <br>
                  <strong>${epic.epicName}</strong>
                </td>
                <td>
                  <span class="badge done">${epic.doneCount}</span>
                  /
                  <span style="font-weight: 600;">${epic.totalIssues}</span>
                  <br>
                  <small style="color: #64748b;">
                    ${epic.inProgressCount} in progress, ${epic.todoCount} to do
                  </small>
                </td>
                <td>
                  <div class="progress-bar">
                    <div class="fill" style="width: ${epic.completionPct}%">
                      ${epic.completionPct}%
                    </div>
                  </div>
                </td>
                <td>
                  <strong>${epic.donePoints}</strong>
                  / ${epic.totalPoints}
                  <br>
                  <small style="color: #64748b;">${epic.pointsPct}% complete</small>
                </td>
                <td>
                  ${epic.avgCycleTimeDays} days
                </td>
                <td>
                  <span class="forecast-${epic.healthStatus}">
                    ${epic.healthStatus?replace("_", " ")}
                  </span>
                </td>
              </tr>
              
              <!--#list-->
              </tbody>
            </table>
          </section>
          
          <!-- User Performance -->
          <section style="margin-bottom: 2rem;">
            <h2 style="margin-bottom: 1rem;">ðŸ‘¥ Team Performance</h2>
            <div class="grid">
              <#list userPerformance as user>
              <div class="user-card">
                <h4>${user.displayName}</h4>
                <div class="stats">
                  <div>
                    <label>In Progress</label>
                    <span>${user.inProgress}</span>
                  </div>
                  <div>
                    <label>Completed</label>
                    <span>${user.completedIssues}</span>
                  </div>
                  <div>
                    <label>Story Points</label>
                    <span>${user.completedPoints}</span>
                  </div>
                </div>
                <div style="margin-top: 1rem;"> 
                  <small style="color: #64748b;">
                    Velocity:
                    <strong>${user.avgVelocity} pts/day</strong>
                    â€¢                                 Active Days:
                    <strong>${user.activeDaysCount}/30</strong>
                  </small>
                </div>
                <canvas id="userVelocity_${user.userId?replace(" -",="" "_"="" )}"="" style="margin-top: 1rem; max-height: 150px;"></canvas>
              </div>
              
              <!--#list-->
            </div>
          </section>
          
          <!-- LLM Insights -->
          <section style="margin-bottom: 2rem;">
            <h2 style="margin-bottom: 1rem;">ðŸ’¡ AI-Generated Insights</h2>
            <div class="insight-box llm-generated">
              <h3>ðŸ“‹ Executive Summary</h3>
              <div style="white-space: pre-line;">
                ${executiveSummary}
              </div>
            </div>
            <div class="insight-box">
              <h3>ðŸŽ¯ Focus Areas</h3>
              <ul style="padding-left: 1.5rem;">
                <#list strategyInsights.focusAreas as area>
                <li style="margin-bottom: 0.5rem;">${area}</li>
            
                <!--#list-->
              </ul>
            </div>
            <#if strategyInsights.criticalIssues?size gt 0>
            <div class="insight-box" style="border-left-color: var(--danger);">
              <h3>ðŸš¨ Critical Issues Requiring Attention</h3>
              <#list strategyInsights.criticalIssues as issue>
              <div style="margin-bottom: 1rem; padding: 1rem; background: #fef2f2; border-radius: 8px;">
                <strong style="color: var(--danger);">
                  <a href="https://your-jira-instance.atlassian.net/browse/${issue.key}" target="_blank" style="color: var(--danger); text-decoration: none;">
                    ${issue.key}
                  </a>
                </strong>
                <p style="margin-top: 0.5rem; color: #475569;">${issue.reason}</p>
              </div>
              
              <!--#list-->
            </div>
            
            <!--#if-->
            <div class="insight-box" style="border-left-color: var(--success);">
              <h3>ðŸ“ˆ Positive Trends</h3>
              <ul style="padding-left: 1.5rem;">
                <#list strategyInsights.positiveTrends as trend>
                <li style="margin-bottom:
                  0.5rem; color: var(--success);">âœ“ ${trend}</li>
          
                <!--#list-->
              </ul>
            </div>
            <div class="insight-box">
            <h3>ðŸ’¼ Recommendations</h3>
            <#list strategyInsights.recommendations as rec>
            <div style="margin-bottom: 1rem; padding: 1rem; background: #f8fafc; border-radius: 8px; border-left: 3px solid var(--primary);">
              <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                <strong>${rec.action}</strong>
                <span class="badge" style="background:
                  <#if rec.priority == 'HIGH'>#fee2e2; color: #991b1b<#else>#dbeafe; color: #1e40af</#if>;">
                    ${rec.priority}
                </span>
              </div>
              <p style="color: #64748b; font-size: 0.875rem;">${rec.impact}</p>
            </div>
            
            <!--#list-->
            </div>
          </section>
          
          <!-- Footer -->
          <footer>
            <p>Generated by Synthesis Engine â€¢ Powered by Neo4j &amp; Azure OpenAI</p>
              <p style="margin-top: 0.5rem;">
                Report ID: ${.now?long} â€¢
              <a href="#" onclick="window.print(); return false;" style="color: var(--primary);">Print Report</a>
            </p>
          </footer>
        </div>
        
        <!-- Chart.js Initialization -->
        <script>
        // Completion Donut Chart
        new Chart(document.getElementById('completionDonut'), {
          type: 'doughnut',
          data: {
            labels: [ 'Done', 'In Progress', 'To Do' ],
            datasets: [ {
              data: [
                $ {
                    epicProgress ? map(e - > e.doneCount) ? sum
                },
                $ {
                    epicProgress ? map(e - > e.inProgressCount) ? sum
                },
                $ {
                    epicProgress ? map(e - > e.todoCount) ? sum
                }
              ],
              backgroundColor: [ '#10b981', '#0ea5e9', '#e2e8f0' ]
            } ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: false
              }
            }
          }
        });
        
        // Epic Radar Chart
        new Chart(document.getElementById('epicRadar'), {
          type: 'radar',
          data: {
            labels: [ <
              #list epicProgress as epic > '${epic.epicName?js_string}' < #sep > , < /#list>
            ],
            datasets: [ {
              label: 'Completion %',
              data: [ <
                #list epicProgress as epic > $ {
                epic.completionPct
                } < #sep > , < /#list>
              ],
              fill: true,
              backgroundColor: 'rgba(14, 165, 233, 0.2)',
              borderColor: 'rgb(14, 165, 233)',
              pointBackgroundColor: 'rgb(14, 165, 233)',
              pointBorderColor: '#fff',
              pointHoverBackgroundColor: '#fff',
              pointHoverBorderColor: 'rgb(14, 165, 233)'
            }, {
              label: 'Story Points %',
              data: [ <
                #list epicProgress as epic > $ {
                epic.pointsPct
                } < #sep > , < /#list>
              ],
              fill: true,
              backgroundColor: 'rgba(16, 185, 129, 0.2)',
              borderColor: 'rgb(16, 185, 129)',
              pointBackgroundColor: 'rgb(16, 185, 129)',
              pointBorderColor: '#fff',
              pointHoverBackgroundColor: '#fff',
              pointHoverBorderColor: 'rgb(16, 185, 129)'
            } ]
          },
          options: {
            responsive: true,
            scales: {
              r: {
                beginAtZero: true,
                max: 100,
                ticks: {
                  stepSize: 20
                }
              }
            }
          }
        });
        
        // User Velocity Charts (one per user)
        <
        #list userPerformance as user >
          new Chart(document.getElementById('userVelocity_${user.userId?replace("-", "_")}'), {
            type: 'bar',
            data: {
              labels: [ 'Completed', 'In Progress', 'To Do' ],
              datasets: [ {
                label: 'Issues',
                data: [ $ {
                            user.completedIssues
                }, $ {
                       user.inProgress
                }, $ {
                       user.todoIssues
                } ],
                backgroundColor: [ '#10b981', '#0ea5e9', '#e2e8f0' ]
              } ]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  display: false
                }
              },
              scales: {
                y: {
                  beginAtZero: true
                }
              }
            }
          }); <
        /#list>
        
        // Filter functionality
        function applyFilters() {
          const epicFilter = document.getElementById('epicFilter').value;
          const userFilter = document.getElementById('userFilter').value;
          const dateFrom = document.getElementById('dateFrom').value;
          const dateTo = document.getElementById('dateTo').value;
          
          // Reload page with query parameters
          const params = new URLSearchParams({
            epic: epicFilter,
            user: userFilter,
            from: dateFrom,
            to: dateTo
          });
          
          window.location.href = window.location.pathname + '?' + params.toString();
        }
      
        // Print styling
        window.addEventListener('beforeprint', () => {
          document.querySelectorAll('details').forEach(d => d.open = true);
        });
        
        </script>
      </body>
    </html>