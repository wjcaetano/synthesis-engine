config:
  fresh: true
  transformDefaultParams:
    jolt:
      - "${#recipe['jolts']['joltNeo4jTableToJson']}"
    neo4j:
      - "http://localhost:7474/db/neo4j/tx/commit"
      - "${@Utils.createBasicAuthHeader('neo4j', 'select-shirt-judge-miguel-antonio-46')}"

  options:
    - name: clearDatabase
      type: BOOLEAN
      label: "Clear 'JiraReports' Nodes in database before anything?"
      defaultValue: false

    - name: jiraProjectKey
      type: TEXT
      label: "Jira Project Key"
      defaultValue: "LMT"

    - name: daysBack
      type: TEXT
      label: "Days to Analyze"
      defaultValue: 14

    - name: epicFilter
      type: TEXT
      label: "Epic Key Filter (optional)"
      defaultValue: ""

    - name: assigneeFilter
      type: TEXT
      label: "Assignee Filter (optional)"
      defaultValue: ""

    - name: maxPages
      type: TEXT
      label: "Max Pages to Fetch"
      defaultValue: 50

    - name: pageSize
      type: TEXT
      label: "Items Per Page"
      defaultValue: 50

  agents:
    - name: STRATEGY_AGENT
      provider: azure
      model: gpt-4o
      deploymentName: Chatbot
      temperature: 0.2
      maxTurns: 1

    - name: DAILY_SUMMARY_AGENT
      provider: azure
      model: gpt-4o
      deploymentName: Chatbot
      temperature: 0.7
      maxTurns: 2

    - name: BLOCKER_ANALYST
      provider: azure
      model: gpt-4o
      deploymentName: Chatbot
      temperature: 0.3
      maxTurns: 1
      tools: ["neo4jQuery"]

caches:
  transforms:
    - prompt
    - neo4j

executor: ProjectModelExecutor3.java

projectModel:
  _clearDatabase: ${#recipe['templates']['clearDatabase']}
  _collectEpics: "${#recipe['templates']['collectJiraEpics']}"
  _persistEpics: "${#recipe['templates']['persistEpics']}"
  _collectIssues: "${#recipe['templates']['collectJiraIssues']}"
  _enrichIssues: "${#recipe['templates']['enrichChangelogData']}"
  _buildGraph: "${#recipe['templates']['buildGraph']}"
  analytics.json: "${#recipe['templates']['runAnalyticsQueries']}"
  llmInsights.json: "${#recipe['templates']['generateLLMInsights']}"
  daily-report.html: "${#recipe['templates']['generateHTMLReport']}"

vars:
  jiraHeaders:
    Authorization: "${@Utils.getEnvVariable('JIRA_AUTH_HEADER')}"
    Content-Type: "application/json"
    Accept: "application/json"
    X-Atlassian-Token: "no-check"
  jiraBaseURL: "https://ilabs-capco.atlassian.net/rest/api/3/search"

models:
  JiraUser:
    "": "${#user}"
    labels: ["User", "JiraReport"]
    key: "${#self['accountId'] ?: 'UNASSIGNED_' + T(java.util.UUID).randomUUID().toString()}"
    name: "${#self['name'] ?: ''}"
    email: "${#self['email'] ?: ''}"

  JiraEpic:
    "": "${#epic}"
    labels: ["Epic", "JiraReport"]
    key: "${#self['epicKey']}"
    epicId: "${#self['epicId']}"
    epicUrl: "${#self['epicUrl']}"
    name: "${#self['epicName']}"
    summary: "${#self['summary']}"
    description: "${#self['description']}"
    status: "${#self['status']}"
    priority: "${#self['priority']}"
    createdDate: "${#self['createdDate']}"
    updatedDate: "${#self['updatedDate']}"
    duedate: "${#self['duedate']}"
    resolutiondate: "${#self['resolutiondate']}"
    relationships: |-
      @@@freemarker
      <#assign rels = []>
      <#if epic.assignee?? && epic.assignee.accountId??>
        <#assign rels = rels + [{"label": "ASSIGNED_TO", "endKey": epic.assignee.accountId}]>
      </#if>
      <#if epic.reporter?? && epic.reporter.accountId??>
        <#assign rels = rels + [{"label": "REPORTED_BY", "endKey": epic.reporter.accountId}]>
      </#if>
      [<#list rels as rel>{"label":"${rel.label}","endKey":"${rel.endKey}"}<#if rel?has_next>,</#if></#list>]

  JiraStatusChange:
    "": "${#change}"
    labels: ["StatusChange", "JiraReport"]
    key: "${#self['issueKey'] + '|' + #self['date'] + '|' + #self['from'] + '->' + #self['to']}"
    issueKey: "${#self['issueKey']}"
    from: "${#self['from'] ?: 'unknown'}"
    to: "${#self['to'] ?: 'unknown'}"
    timestamp: "${#self['date']}"
    author: "${#self['author'] ?: 'unknown'}"
    relationships: |-
      @@@freemarker
      [{"label":"CHANGED","endKey":"${change.issueKey}"}]

  JiraIssue:
    "": "${#issue}"
    labels: ["Issue", "JiraReport"]
    key: "${#self['issueKey']}"
    issueId: "${#self['issueId']}"
    issueUrl: "${#self['issueUrl']}"
    summary: "${#self['summary']}"
    description: "${#self['description']}"
    status: "${#self['status']}"
    type: "${#self['issueType']}"
    priority: "${#self['priority']}"
    createdDate: "${#self['createdDate']}"
    updatedDate: "${#self['updatedDate']}"
    duedate: "${#self['duedate']}"
    resolutiondate: "${#self['resolutiondate']}"
    storyPoints: "${#self['storyPoints']}"
    timeSpent: "${#self['timeSpent']}"
    originalEstimate: "${#self['originalEstimate']}"
    relationships: |-
      @@@freemarker
      <#assign rels = []>
      <#if issue.assignee?? && issue.assignee.accountId??>
        <#assign rels = rels + [{"label": "ASSIGNED_TO", "endKey": issue.assignee.accountId}]>
      </#if>
      <#if issue.reporter?? && issue.reporter.accountId??>
        <#assign rels = rels + [{"label": "REPORTED_BY", "endKey": issue.reporter.accountId}]>
      </#if>
      <#if issue.epicKey?? && issue.epicKey?has_content>
        <#assign rels = rels + [{"label": "BELONGS_TO_EPIC", "endKey": issue.epicKey}]>
      </#if>
      <#if issue.parentKey?? && issue.parentKey?has_content>
        <#assign rels = rels + [{"label": "CHILD_OF", "endKey": issue.parentKey}]>
      </#if>
      [<#list rels as rel>{"label":"${rel.label}","endKey":"${rel.endKey}"}<#if rel?has_next>,</#if></#list>]


jolts:
  joltNeo4jTableToJson: |-
    [
      {
        "operation": "shift",
        "spec": {
          "results": {
            "*": {
              "data": {
                "*": {
                  "row": {
                    "*": "[&2].@(4,columns[&0])"
                  }
                }
              }
            }
          }
        }
      }
    ]

  joltEpicToNormalized: |-
    [
      {
        "operation":"shift",
        "spec":{
          "*":{
            "id":"[&1].epicId",
            "key":"[&1].epicKey",
            "self":"[&1].epicUrl",
            "fields":{
              "summary":"[&2].summary",
              "issuetype":{
                "name":"[&2].issueType",
                "id":"[&2].issueTypeId"
              },
              "project":{
                "key":"[&2].projectKey",
                "name":"[&2].projectName",
                "id":"[&2].projectId"
              },
              "status":{
                "name":"[&2].status",
                "statusCategory":{
                  "name":"[&2].statusCategory"
                }
              },
              "priority":{
                "name":"[&2].priority"
              },
              "created":"[&2].createdDate",
              "updated":"[&2].updatedDate",
              "duedate":"[&2].duedate",
              "resolutiondate":"[&2].resolutiondate",
              "reporter":{
                "displayName":"[&2].reporter.name",
                "emailAddress":"[&2].reporter.email",
                "accountId":"[&2].reporter.accountId"
              },
              "assignee":{
                "displayName":"[&2].assignee.name",
                "emailAddress":"[&2].assignee.email",
                "accountId":"[&2].assignee.accountId"
              },
              "description":{
                "content":{
                  "*":{
                    "content":{
                      "*":{
                        "text":"[&5].description[]"
                      }
                    }
                  }
                }
              }
            }
          }
        }
      },
      {
        "operation":"modify-overwrite-beta",
        "spec":{
          "*":{
            "epicName":"=concat(@(1,summary))",
            "description":"=join(' ',@(1,description))"
          }
        }
      },
      {
        "operation":"default",
        "spec":{
          "*":{
            "description":"No description provided.",
            "duedate":"",
            "resolutiondate":"",
            "priority":"Medium",
            "assignee": {},
            "reporter": {}
          }
        }
      }
    ]

  joltJiraToNormalized: |-
    [
      {
        "operation":"shift",
        "spec":{
          "*":{
            "id":"[&1].issueId",
            "key":"[&1].issueKey",
            "self":"[&1].issueUrl",
            "fields":{
              "summary":"[&2].summary",
              "issuetype":{
                "name":"[&2].issueType",
                "id":"[&2].issueTypeId"
              },
              "project":{
                "key":"[&2].projectKey",
                "name":"[&2].projectName",
                "id":"[&2].projectId"
              },
              "status":{
                "name":"[&2].status",
                "statusCategory":{
                  "name":"[&2].statusCategory"
                }
              },
              "priority":{
                "name":"[&2].priority"
              },
              "created":"[&2].createdDate",
              "updated":"[&2].updatedDate",
              "duedate":"[&2].duedate",
              "resolutiondate":"[&2].resolutiondate",
              "reporter":{
                "displayName":"[&2].reporter.name",
                "emailAddress":"[&2].reporter.email",
                "accountId":"[&2].reporter.accountId"
              },
              "assignee":{
                "displayName":"[&2].assignee.name",
                "emailAddress":"[&2].assignee.email",
                "accountId":"[&2].assignee.accountId"
              },
              "parent":{
                "key":"[&2].parentKey",
                "id":"[&2].parentId",
                "fields":{
                  "summary":"[&4].parentSummary"
                }
              },
              "customfield_10014":"[&2].epicKey",
              "customfield_10016":"[&2].storyPoints",
              "timetracking":{
                "timeSpentSeconds":"[&2].timeSpent",
                "originalEstimateSeconds":"[&2].originalEstimate"
              },
              "issuelinks":"[&2].links",
              "comment":{
                "comments":"[&2].comments"
              },
              "description":{
                "content":{
                  "*":{
                    "content":{
                      "*":{
                        "text":"[&5].description[]"
                      }
                    }
                  }
                }
              }
            },
            "changelog":{
              "histories":{
                "*":{
                  "created":"[&4].changeHistory[&1].date",
                  "author":{
                    "displayName":"[&5].changeHistory[&2].author"
                  },
                  "items":{
                    "*":{
                      "field":"[&6].changeHistory[&3].changes[&2].field",
                      "fromString":"[&6].changeHistory[&3].changes[&2].oldValue",
                      "toString":"[&6].changeHistory[&3].changes[&2].newValue"
                    }
                  }
                }
              }
            }
          }
        }
      },
      {
        "operation":"modify-overwrite-beta",
        "spec":{
          "*":{
            "description":"=join(' ',@(1,description))"
          }
        }
      },
      {
        "operation":"default",
        "spec":{
          "*":{
            "description":"No description provided.",
            "comments":[],
            "links":[],
            "storyPoints":"0",
            "timeSpent":"0",
            "originalEstimate":"0",
            "duedate":"",
            "resolutiondate":"",
            "parentKey":"",
            "parentId":"",
            "parentSummary":"",
            "epicKey":"",
            "assignee": {},
            "reporter": {}
          }
        }
      }
    ]

  joltEnrichChangelog: |-
    [
      {
        "operation":"shift",
        "spec":{
          "*":{
            "@":"[&1]",
            "changeHistory":{
              "*":{
                "changes":{
                  "*":{
                    "field":{
                      "status":{
                        "@(3,date)":"[&6].dailyStatusChanges[&3].date",
                        "@(2,oldValue)":"[&6].dailyStatusChanges[&3].from",
                        "@(2,newValue)":"[&6].dailyStatusChanges[&3].to",
                        "@(3,author)":"[&6].dailyStatusChanges[&3].author"
                      }
                    }
                  }
                }
              }
            }
          }
        }
      },
      {
        "operation":"shift",
        "spec":{
          "*":{
            "*":"[&1].&",
            "dailyStatusChanges":{
              "*":"[&3].dailyStatusChanges[&1]"
            }
          }
        }
      },
      {
        "operation":"default",
        "spec":{
          "*":{
            "dailyStatusChanges":[]
          }
        }
      }
    ]

templates:
  jiraResolvedHeaders: |-
    @@@log("#00FF00Resolving Jira API headers...")
    @@@spel("${#recipe['vars']['jiraHeaders']}")
    @@@set("jiraHeaders")
    @@@jsonify
    @@@objectify
    @@@exec(${#jiraHeaders['Authorization']})
    @@@set("auth")
    @@@spel("${#jiraHeaders['Authorization'] = #auth}")

  jiraPaginationConfig: |-
    @@@log("#00FF00Setting up Jira pagination configuration...")
    @@@freemarker
    @@@objectify
    @@@set("paginationConfig")
    {
      "type": "OFFSET",
      "itemsPath": "$.issues",
      "pageSize": ${$api.configs.options.pageSize!50},
      "maxPages": ${$api.configs.options.maxPages!50},
      "rateLimitDelaysMs": 200
    }

  jqlBuildEpics: |-
    @@@log("#00FF00Building JQL query for EPICs...")
    @@@freemarker
    @@@set("jqlQueryParts")
    @@@spel("${#jqlQueryParts.trim()}")
    @@@set("jqlQueryEpics")
    <#assign projectKey = $api.configs.options.jiraProjectKey!"LMT">
    <#assign daysBack = $api.configs.options.daysBack!14>
    <#assign parts = []>
    <#assign parts = parts + ["project = " + projectKey]>
    <#assign parts = parts + ["issuetype in ('Epic')"]>
    <#assign parts = parts + ["updated >= '-" + daysBack + "d'"]>

    <#if ($api.configs.options.epicFilter)?? && $api.configs.options.epicFilter?has_content>
    <#assign parts = parts + ["key = " + $api.configs.options.epicFilter]>
    </#if>

    ${parts?join(" AND ")} ORDER BY updated DESC

  jqlBuildIssues: |-
    @@@log("#00FF00Building JQL query for Issues...")
    @@@freemarker
    @@@set("jqlQueryParts")
    @@@spel("${#jqlQueryParts.trim()}")
    @@@set("jqlQuery")
    <#assign projectKey = $api.configs.options.jiraProjectKey!"LMT">
    <#assign daysBack = $api.configs.options.daysBack!14>
    <#assign parts = []>
    <#assign parts = parts + ["project = " + projectKey]>
    <#assign parts = parts + ["updated >= '-" + daysBack + "d'"]>

    <#if ($api.configs.options.epicFilter)?? && $api.configs.options.epicFilter?has_content>
    <#assign parts = parts + ["'Epic Link' = " + $api.configs.options.epicFilter]>
    </#if>

    <#if ($api.configs.options.assigneeFilter)?? && $api.configs.options.assigneeFilter?has_content>
    <#assign parts = parts + ["assignee = " + $api.configs.options.assigneeFilter]>
    </#if>

    ${parts?join(" AND ")} ORDER BY updated DESC

  jiraEpicPayloadBuild: |-
    @@@freemarker
    @@@objectify
    @@@set("jiraEpicPayloadTemplate")
    {
      "jql": "${jqlQueryEpics}",
      "fields": [
        "summary",
        "description",
        "status",
        "assignee",
        "project",
        "reporter",
        "issuetype",
        "priority",
        "duedate",
        "resolutiondate",
        "created",
        "updated"
      ],
      "expand": "names,renderedFields",
      "maxResults": ${$api.configs.options.pageSize!50}
    }

  jiraPayloadBuild: |-
    @@@freemarker
    @@@objectify
    @@@set("jiraPayloadTemplate")
    {
      "jql": "${jqlQuery}",
      "fields": [
        "summary",
        "description",
        "status",
        "assignee",
        "project",
        "reporter",
        "issuetype",
        "priority",
        "duedate",
        "resolutiondate",
        "parent",
        "timetracking",
        "issuelinks",
        "created",
        "updated",
        "comment",
        "customfield_10016",
        "customfield_10014"
      ],
      "expand": "names, changelog, renderedFields",
      "maxResults": ${$api.configs.options.pageSize!50}
    }

  collectJiraEpics: |-
    @@@log("#FF00FFStarting Jira EPIC collection using Template pagination...")
    @@@exec("${#recipe['templates']['jqlBuildEpics']}")
    @@@log("${'JQL Query EPICs: ' + #jqlQueryEpics}")
    @@@exec("${#recipe['templates']['jiraResolvedHeaders']}")
    @@@log("${'Jira Headers: ' + #jiraHeaders}")
    @@@exec("${#recipe['templates']['jiraEpicPayloadBuild']}")
    @@@log("${'Jira EPIC Payload: ' + #jiraEpicPayloadTemplate}")
    @@@exec("${#recipe['templates']['jiraPaginationConfig']}")
    @@@log("${'Pagination Config: ' + #paginationConfig}")
    @@@api("${#recipe['vars']['jiraBaseURL']}", "POST", "${#jiraEpicPayloadTemplate}", "${#jiraHeaders}", "${#paginationConfig}")
    @@@objectify
    @@@set("rawApiEpicResult")
    @@@log("${'#00FFFFPagination finished. Total EPICs: ' + #rawApiEpicResult['totalItems']}")
    @@@spel("${#rawApiEpicResult['items']}")
    @@@jsonify
    @@@set("rawEpics")
    @@@jolt("${#recipe['jolts']['joltEpicToNormalized']}")
    @@@set("normalizedEpics")
    @@@jsonify
    @@@log("${'#00FF00Normalized ' + (#normalizedEpics instanceof T(java.util.List) ? #normalizedEpics.size() : 0) + ' EPICs'}")

  collectJiraIssues: |-
    @@@log("#00FF00Starting Jira ISSUES collection using Template pagination...")
    @@@exec("${#recipe['templates']['jqlBuildIssues']}")
    @@@log("${'JQL Query: ' + #jqlQuery}")
    @@@exec("${#recipe['templates']['jiraResolvedHeaders']}")
    @@@log("${'Jira Headers: ' + #jiraHeaders}")
    @@@exec("${#recipe['templates']['jiraPayloadBuild']}")
    @@@log("${'Jira Payload: ' + #jiraPayloadTemplate}")
    @@@exec("${#recipe['templates']['jiraPaginationConfig']}")
    @@@log("${'Pagination Config: ' + #paginationConfig}")
    @@@api("${#recipe['vars']['jiraBaseURL']}", "POST", "${#jiraPayloadTemplate}", "${#jiraHeaders}", "${#paginationConfig}")
    @@@objectify
    @@@set("rawApiResult")
    @@@log("${'#00FFFFPagination finished. Total items: ' + #rawApiResult['totalItems']}")
    @@@spel("${#rawApiResult['items']}")
    @@@jsonify
    @@@set("rawIssues")
    @@@jolt("${#recipe['jolts']['joltJiraToNormalized']}")
    @@@set("normalizedIssues")
    @@@jsonify
    @@@log("${'#00FF00Normalized ' + (#normalizedIssues instanceof T(java.util.List) ? #normalizedIssues.size() : 0) + ' Issues'}")

  enrichChangelogData: |-
    @@@log("#00FF00Enriching changelog data with daily status changes...")
    @@@spel("${#normalizedIssues}")
    @@@jsonify
    @@@jolt("${#recipe['jolts']['joltEnrichChangelog']}")
    @@@set("enrichedIssues")
    @@@jsonify
    @@@log("${'#00FF00Enriched ' + (#enrichedIssues instanceof T(java.util.List) ? #enrichedIssues.size() : 0) + ' Issues with changelog data'}")

  clearDatabase: |-
    @@@log("#00FF00Clearing JiraReports nodes from Neo4j database...")
    @@@neo4j
    @@@jsonify
    @@@log("#10B981Database cleared successfully!")
    MATCH (n)
    WHERE n:JiraReport
    DETACH DELETE n;

  persistEpics: |-
    @@@log("#FF00FFPersisting EPICs to Neo4j...")
    @@@spel("${#normalizedEpics}")
    @@@freemarker
    @@@jsonify
    @@@set("allEpics")
    @@@repeat("${#allEpics}", "epic", "${#recipe['templates']['enrichEpic']}")
    @@@jsonify
    @@@log("${'#10B981Persisted ' + (#allEpics instanceof T(java.util.List) ? #allEpics.size() : 0) + ' EPICs to Neo4j'}")
    <#list normalizedEpics as epic>
      <#assign enrichedEpic = {
        "epicKey": epic.epicKey,
        "epicId": epic.epicId,
        "epicUrl": epic.epicUrl,
        "epicName": epic.epicName,
        "summary": epic.summary,
        "description": epic.description,
        "status": epic.status,
        "priority": epic.priority,
        "createdDate": epic.createdDate,
        "updatedDate": epic.updatedDate,
        "duedate": epic.duedate,
        "resolutiondate": epic.resolutiondate,
        "assignee": epic.assignee,
        "reporter": epic.reporter
      }>
      ${enrichedEpic}
    </#list>

  enrichEpic: |-
    @@@objectify("${#recipe['models']['JiraEpic']}")
    @@@set("enrichedEpic")
    @@@nodify
    @@@neo4j
    @@@jsonify

  buildGraph: |-
    @@@log("#00FF00Starting Neo4j Graph Build with new strategy...")
    @@@exec("${#recipe['templates']['persistUsers']}")
    @@@exec("${#recipe['templates']['persistStatusChanges']}")
    @@@exec("${#recipe['templates']['persistIssues']}")
    @@@set("graphBuildResult")
    @@@jsonify
    @@@log("#10B981Graph build completed successfully!")

  persistUsers: |-
    @@@log("#00FF00Extracting and persisting unique users...")
    @@@spel("${#enrichedIssues}")
    @@@freemarker
    @@@jsonify
    @@@set("allUsers")
    @@@repeat("${#allUsers}", "user", "${#recipe['templates']['enrichUser']}")
    @@@jsonify
    @@@log("${'#10B981Persisted ' + (#allUsers instanceof T(java.util.List) ? #allUsers.size() : 0) + ' Users'}")
    <#assign users = []>
    <#list enrichedIssues as issue>
      <#if issue.assignee?? && issue.assignee.accountId??>
        <#assign found = false>
        <#list users as u>
          <#if u.accountId?? && u.accountId == issue.assignee.accountId>
            <#assign found = true>
            <#break>
          </#if>
        </#list>
        <#if !found>
          <#assign users = users + [issue.assignee]>
        </#if>
      </#if>
      <#if issue.reporter?? && issue.reporter.accountId??>
        <#assign found = false>
        <#list users as u>
          <#if u.accountId?? && u.accountId == issue.reporter.accountId>
            <#assign found = true>
            <#break>
          </#if>
        </#list>
        <#if !found>
          <#assign users = users + [issue.reporter]>
        </#if>
      </#if>
    </#list>
    ${users}

  enrichUser: |-
    @@@objectify("${#recipe['models']['JiraUser']}")
    @@@set("enrichedUser")
    @@@nodify
    @@@neo4j
    @@@jsonify

  persistStatusChanges: |-
    @@@log("#00FF00Persisting status changes...")
    @@@spel("${#enrichedIssues}")
    @@@freemarker
    @@@jsonify
    @@@set("allStatusChanges")
    @@@repeat("${#allStatusChanges}", "change", "${#recipe['templates']['enrichStatusChange']}")
    @@@jsonify
    @@@log("${'#10B981Persisted ' + (#allStatusChanges instanceof T(java.util.List) ? #allStatusChanges.size() : 0) + ' Status Changes'}")
    <#assign allChanges = []>
    <#list enrichedIssues as issue>
      <#if issue.dailyStatusChanges?? && issue.dailyStatusChanges?has_content>
        <#list issue.dailyStatusChanges as change>
          <#assign allChanges = allChanges + [{
            "issueKey": issue.issueKey,
            "date": change.date,
            "from": change.from,
            "to": change.to,
            "author": change.author
          }]>
        </#list>
      </#if>
    </#list>
    ${allChanges}

  enrichStatusChange: |-
    @@@objectify("${#recipe['models']['JiraStatusChange']}")
    @@@set("enrichedStatusChange")
    @@@nodify
    @@@neo4j
    @@@jsonify

  persistIssues: |-
    @@@log("#00FF00Persisting all issues with relationships...")
    @@@spel("${#enrichedIssues}")
    @@@repeat("${#content}", "issue", "${#recipe['templates']['enrichIssue']}")
    @@@jsonify
    @@@log("${'#10B981Persisted ' + (#enrichedIssues instanceof T(java.util.List) ? #enrichedIssues.size() : 0) + ' Issues'}")

  enrichIssue: |-
    @@@log("${'#00FF00Enriching and persisting issue: ' + #issue['issueKey']}")
    @@@objectify("${#recipe['models']['JiraIssue']}")
    @@@set("enrichedIssue")
    @@@nodify
    @@@neo4j
    @@@jsonify

  runAnalyticsQueries: |-
    @@@log("#00FF00Running analytical queries...")
    @@@_exec("${#recipe['templates']['query.dailyTimeline']}")
    @@@_exec("${#recipe['templates']['query.blockerAnalysis']}")
    @@@_exec("${#recipe['templates']['query.userPerformance']}")
    @@@_exec("${#recipe['templates']['query.epicProgress']}")
    @@@_exec("${#recipe['templates']['query.velocityTrends']}")
    @@@exec("${#recipe['templates']['buildAnalyticsMap']}")
    @@@jsonify
    @@@log("#10B981Analytics queries completed!")

  buildAnalyticsMap: |-
    @@@log("#00FF00Building analytics result map...")
    @@@spel("${new java.util.LinkedHashMap([('dailyTimeline'): (#dailyTimeline != null ? #dailyTimeline : T(java.util.Collections).emptyList())])}")
    @@@set("result")
    @@@spel("${#result.put('blockerAnalysis', #blockerAnalysis != null ? #blockerAnalysis : T(java.util.Collections).emptyList())}")
    @@@spel("${#result.put('userPerformance', #userPerformance != null ? #userPerformance : T(java.util.Collections).emptyList())}")
    @@@spel("${#result.put('epicProgress', #epicProgress != null ? #epicProgress : T(java.util.Collections).emptyList())}")
    @@@spel("${#result.put('velocityTrends', #velocityTrends != null ? #velocityTrends : T(java.util.Map).of())}")
    @@@get("result")

  query.dailyTimeline: |-
    @@@log("#00FF00Executing Daily Timeline Query...")
    @@@freemarker
    @@@set("cypherQuery")
    @@@neo4j
    @@@jolt("${#recipe['jolts']['joltNeo4jTableToJson']}")
    @@@set("dailyTimeline")
    @@@jsonify
    MATCH (sc:StatusChange)-[:CHANGED]->(i:Issue)
    WHERE date(sc.timestamp) >= date() - duration({days: ${$api.configs.options.daysBack!14}})
    WITH date(sc.timestamp) AS day,
         sc.to AS toStatus,
         sc.from AS fromStatus,
         i.key AS issueKey,
         i.summary AS issueSummary,
         sc.author AS author
    ORDER BY day DESC
    WITH day,
         collect({
           issueKey: issueKey,
           summary: issueSummary,
           fromStatus: fromStatus,
           toStatus: toStatus,
           author: author
         }) AS changes
    RETURN day AS date,
           size([c IN changes WHERE c.toStatus = 'Done']) AS doneCount,
           size([c IN changes WHERE c.toStatus = 'In Progress' AND c.fromStatus = 'To Do']) AS startedCount,
           size([c IN changes WHERE c.toStatus CONTAINS 'Block']) AS blockerCount,
           changes AS issues,
           size(changes) AS totalChanges
    ORDER BY day DESC
    LIMIT ${$api.configs.options.daysBack!14}

  query.blockerAnalysis: |-
    @@@log("#00FF00Executing Blocker Analysis Query...")
    @@@neo4j
    @@@jolt
    @@@set("blockerAnalysis")
    @@@jsonify
    MATCH (i:Issue)
    WHERE i.status IN ['Blocked', 'On Hold']
    RETURN i.key AS blockedKey,
           i.summary AS blockedSummary,
           i.status AS blockedStatus,
           [] AS blockerIssues,
           0 AS daysBlocked,
           'LOW' AS severity,
           0 AS impactScore
    LIMIT 10

  query.userPerformance: |-
    @@@log("#00FF00Executing User Performance Query...")
    @@@neo4j
    @@@jolt
    @@@set("userPerformance")
    @@@jsonify
    MATCH (u:User)<-[:ASSIGNED_TO]-(i:Issue)
    WITH u,
         count(DISTINCT i) AS totalIssues,
         count(DISTINCT CASE WHEN i.status = 'Done' THEN i END) AS completedIssues,
         count(DISTINCT CASE WHEN i.status = 'In Progress' THEN i END) AS inProgress,
         count(DISTINCT CASE WHEN i.status = 'To Do' THEN i END) AS todoIssues,
         sum(CASE WHEN i.storyPoints IS NOT NULL THEN toInteger(i.storyPoints) ELSE 0 END) AS totalPoints,
         sum(CASE WHEN i.status = 'Done' AND i.storyPoints IS NOT NULL THEN toInteger(i.storyPoints) ELSE 0 END) AS completedPoints
    RETURN u.key AS userId,
           u.name AS displayName,
           totalIssues,
           completedIssues,
           inProgress,
           todoIssues,
           totalPoints,
           completedPoints,
           round(completedPoints * 1.0 / CASE WHEN 30 > 0 THEN 30 ELSE 1 END, 2) AS avgVelocity,
           0 AS activeDaysCount
    ORDER BY completedPoints DESC

  query.epicProgress: |-
    @@@log("#00FF00Executing Epic Progress Query...")
    @@@neo4j
    @@@jolt
    @@@set("epicProgress")
    @@@jsonify
    MATCH (e:Epic)<-[:BELONGS_TO_EPIC]-(i:Issue)
    WITH e,
         count(i) AS total,
         count(CASE WHEN i.status = 'Done' THEN 1 END) AS done,
         count(CASE WHEN i.status = 'In Progress' THEN 1 END) AS inProgress,
         count(CASE WHEN i.status = 'To Do' THEN 1 END) AS todo,
         sum(CASE WHEN i.storyPoints IS NOT NULL THEN toInteger(i.storyPoints) ELSE 0 END) AS totalPoints,
         sum(CASE WHEN i.status = 'Done' AND i.storyPoints IS NOT NULL THEN toInteger(i.storyPoints) ELSE 0 END) AS donePoints
    WITH e, total, done, inProgress, todo, totalPoints, donePoints,
         round(100.0 * done / CASE WHEN total > 0 THEN total ELSE 1 END, 2) AS completionPct,
         round(100.0 * donePoints / CASE WHEN totalPoints > 0 THEN totalPoints ELSE 1 END, 2) AS pointsPct
    RETURN e.key AS epicKey,
           e.name AS epicName,
           e.status AS epicStatus,
           total AS totalIssues,
           done AS doneCount,
           inProgress AS inProgressCount,
           todo AS todoCount,
           totalPoints,
           donePoints,
           completionPct,
           pointsPct,
           0.0 AS avgCycleTimeDays,
           CASE
             WHEN completionPct >= 90 THEN 'ON_TRACK'
             WHEN completionPct >= 70 THEN 'AT_RISK'
             ELSE 'DELAYED'
           END AS healthStatus
    ORDER BY completionPct ASC

  query.velocityTrends: |-
    @@@log("#00FF00Executing Velocity Trends Query...")
    @@@neo4j
    @@@jolt
    @@@set("velocityTrends")
    @@@jsonify
    MATCH (sc:StatusChange)-[:CHANGED]->(i:Issue)
    WHERE sc.to = 'Done'
      AND date(sc.timestamp) >= date() - duration({days: 30})
    WITH date(sc.timestamp) AS completionDate,
         sum(CASE WHEN i.storyPoints IS NOT NULL THEN toInteger(i.storyPoints) ELSE 1 END) AS pointsCompleted,
         count(DISTINCT i) AS issuesCompleted
    WITH collect({
           date: completionDate,
           points: pointsCompleted,
           issues: issuesCompleted
         }) AS dailyData
    RETURN dailyData,
           reduce(total = 0, d IN dailyData | total + d.points) AS totalPoints,
           reduce(total = 0, d IN dailyData | total + d.issues) AS totalIssues,
           round(reduce(total = 0, d IN dailyData | total + d.points) * 1.0 / 30, 2) AS avgDailyVelocity

  generateLLMInsights: |-
    @@@log("#00FF00Generating LLM insights...")
    @@@freemarker
    @@@agent("STRATEGY_AGENT")
    @@@extractMarkdownCode
    @@@objectify
    @@@set("strategyInsights")
    @@@_exec("${#recipe['templates']['llm.dailySummaries']}")
    @@@_exec("${#recipe['templates']['llm.blockerRecommendations']}")
    @@@_exec("${#recipe['templates']['llm.executiveSummary']}")
    @@@spel("${T(java.util.Map).of(
      'strategy', #strategyInsights,
      'dailySummaries', #dailySummaries ?: T(java.util.Collections).emptyList(),
      'blockerRecommendations', #blockerRecommendations ?: T(java.util.Collections).emptyList(),
      'executiveSummary', #executiveSummary ?: 'No summary available'
      )}")
    @@@jsonify
    @@@log("#10B981LLM insights generated successfully!")
    You are a senior project management consultant analyzing Jira project data.

    Based on the analytics data below, provide strategic insights:

    [ANALYTICS DATA]
    Daily Timeline: ${@JsonUtils.writeAsJsonString(#dailyTimeline, true)}
    Blockers: ${@JsonUtils.writeAsJsonString(#blockerAnalysis, true)}
    User Performance: ${@JsonUtils.writeAsJsonString(#userPerformance, true)}
    Epic Progress: ${@JsonUtils.writeAsJsonString(#epicProgress, true)}
    Velocity: ${@JsonUtils.writeAsJsonString(#velocityTrends, true)}

    [REQUIRED OUTPUT]
    Return a JSON object with:
      {
        "focusAreas": ["area1", "area2", "area3"],
        "criticalIssues": [
          {"key": "ISSUE-123", "reason": "Blocking 5 other issues for 8 days"}
        ],
        "recommendations": [
          {"priority": "HIGH", "action": "...", "impact": "..."}
        ],
        "positiveTrends": ["trend1", "trend2"],
        "risksIdentified": ["risk1", "risk2"]
      }

  llm.dailySummaries: |-
    @@@freemarker
    @@@repeat("${#dailyTimeline}", "day", "${#recipe['templates']['llm.summarizeDay']}")
    @@@set("dailySummaries")
    @@@jsonify

  llm.summarizeDay: |-
    @@@freemarker
    @@@agent("DAILY_SUMMARY_AGENT")
    @@@set("daySummary")
    @@@_spel("${#day.put('llmSummary', #daySummary)}")
    Create a concise Daily Standup summary for ${day.date}:

    [DAY DATA]
    ${@JsonUtils.writeAsJsonString(#day, true)}

    [FORMAT]
    - 3-5 bullet points maximum
    - Focus on: completions, new starts, blockers
    - Mention critical comments if any
    - Highlight anomalies (unusually high/low activity)
    - Professional, action-oriented tone

  llm.blockerRecommendations: |-
    @@@freemarker
    @@@agent("BLOCKER_ANALYST")
    @@@extractMarkdownCode
    @@@objectify
    @@@set("blockerRecommendations")
    @@@jsonify
    Analyze the blocker chain and recommend resolution order:

    [BLOCKERS]
    ${@JsonUtils.writeAsJsonString(#blockerAnalysis, true)}

    [GRAPH CONTEXT]
    You have access to the Neo4j graph. Use the neo4jQuery tool to explore:
    - Issue dependencies (DEPENDS_ON relationships)
    - Cascading impacts (issues blocked by blockers)
    - Historical blocker resolution times

    [OUTPUT]
    For each blocker, provide:
    {
      "issueKey": "...",
      "resolutionPriority": 1-10,
      "suggestedAction": "...",
      "estimatedImpact": "...",
      "alternativePaths": ["..."]
    }

  llm.executiveSummary: |-
    @@@freemarker
    @@@agent("STRATEGY_AGENT")
    @@@set("executiveSummary")
    Create an executive summary for management (200-300 words):

    [PROJECT HEALTH]
    - Overall completion: <#if epicProgress?has_content>${epicProgress?map(e -> e.completionPct)?sum / epicProgress?size}<#else>0</#if>%
    - Active blockers: ${blockerAnalysis?size}
    - Velocity trend: <#if velocityTrends.avgDailyVelocity??>${velocityTrends.avgDailyVelocity}<#else>0</#if> pts/day

    [FULL CONTEXT]
    ${@JsonUtils.writeAsJsonString(#strategyInsights, true)}

    [TONE]
    - Executive-level (CEO/CTO audience)
    - Data-driven, not speculative
    - Include 2-3 specific action items
    - Mention both risks and wins

  generateHTMLReport: |-
    @@@freemarker
    <!DOCTYPE html>
    <html lang="en">
      <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Daily Project Report - ${$api.configs.options.jiraProjectKey}</title>
        <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0"></script>
        <style>
          :root {
            --primary: #0ea5e9;
            --danger: #dc2626;
            --warning: #f59e0b;
            --success: #10b981;
            --bg: #f8fafc;
            --card: #ffffff;
            --text: #1e293b;
            --border: #e2e8f0;
          }

          * {
              margin: 0;
              padding: 0;
              box-sizing: border-box;
          }

          body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
          }

          .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
          }

          header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            border-radius: 16px;
            margin-bottom: 2rem;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
          }

          header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
          }

          header .meta {
            opacity: 0.9;
            font-size: 1.1rem;
          }

          .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
          }

          .card {
            background: var(--card);
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s, box-shadow 0.2s;
          }

          .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
          }

          .card h3 {
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #64748b;
            margin-bottom: 0.5rem;
          }

          .card .metric {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary);
            display: block;
            margin-bottom: 0.5rem;
          }

          .timeline {
            background: var(--card);
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
          }

          .timeline h2 {
            font-size: 1.75rem;
            margin-bottom: 1.5rem;
          }

          .timeline-item {
            position: relative;
            padding-left: 3rem;
            padding-bottom: 2rem;
            border-left: 3px solid var(--border);
          }

          .timeline-item:last-child {
            border-left: none;
          }

          .date-marker {
            position: absolute;
            left: -1.5rem;
            background: var(--primary);
            color: white;
            width: 3rem;
            height: 3rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.875rem;
            box-shadow: 0 4px 12px rgba(14, 165, 233, 0.3);
          }

          .badge {
            display: inline-block;
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 600;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
          }

          .badge.done {
            background: #dcfce7;
            color: #166534;
          }

          .badge.started {
            background: #dbeafe;
            color: #1e40af;
          }

          .badge.blocker {
            background: #fee2e2;
            color: #991b1b;
          }

          table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
          }

          th, td {
            text-align: left;
            padding: 1rem;
            border-bottom: 1px solid var(--border);
          }

          th {
            background: #f8fafc;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.05em;
            color: #64748b;
          }

          tr:hover {
            background: #f8fafc;
          }

          .progress-bar {
            background: #e2e8f0;
            height: 1.5rem;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
          }

          .progress-bar .fill {
            background: linear-gradient(90deg, var(--success) 0%, var(--primary) 100%);
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 0.875rem;
            transition: width 0.5s ease;
          }

          .insight-box {
            background: var(--card);
            padding: 2rem;
            border-radius: 12px;
            margin-bottom: 1.5rem;
            border-left: 4px solid var(--primary);
          }

          footer {
            text-align: center;
            padding: 2rem;
            color: #64748b;
            font-size: 0.875rem;
          }
        </style>
      </head>
      <body>
        <div class="container">
          <header>
            <h1>ðŸ“Š Daily Project Report</h1>
            <div class="meta">
              Project: <strong>${$api.configs.options.jiraProjectKey}</strong> â€¢
              Generated: <strong>${.now?string("yyyy-MM-dd HH:mm")}</strong> â€¢
              Period: <strong>Last ${$api.configs.options.daysBack} days</strong>
            </div>
          </header>

          <section class="grid">
            <div class="card">
              <h3>Avg Velocity (30d)</h3>
              <span class="metric"><#if velocityTrends.avgDailyVelocity??>${velocityTrends.avgDailyVelocity}<#else>0</#if></span>
              <span class="detail">pts/day</span>
            </div>
            <div class="card">
              <h3>Active Blockers</h3>
              <span class="metric">${blockerAnalysis?size}</span>
              <span class="detail">issues blocked</span>
            </div>
            <div class="card">
              <h3>Team Velocity</h3>
              <span class="metric"><#if velocityTrends.totalPoints??>${velocityTrends.totalPoints}<#else>0</#if></span>
              <span class="detail"><#if velocityTrends.totalIssues??>${velocityTrends.totalIssues}<#else>0</#if> issues completed</span>
            </div>
            <div class="card">
              <h3>Avg Epic Progress</h3>
              <#if epicProgress?has_content>
                <#assign avgCompletion = epicProgress?map(e -> e.completionPct)?sum / epicProgress?size>
              <#else>
                <#assign avgCompletion = 0>
              </#if>
              <span class="metric">${avgCompletion?string["0.0"]}%</span>
            </div>
          </section>

          <section class="timeline">
            <h2>ðŸ“… Daily Evolution</h2>
            <#list dailyTimeline as day>
            <div class="timeline-item">
              <div class="date-marker">
                ${day.date?date?string("dd")}
              </div>
              <div class="events">
                <h4>${day.date?date?string("EEEE, MMMM dd, yyyy")}</h4>
                <#if day.llmSummary??>
                <div class="summary">${day.llmSummary}</div>
                </#if>
                <div class="changes">
                  <span class="badge done">âœ… ${day.doneCount} completed</span>
                  <span class="badge started">ðŸš€ ${day.startedCount} started</span>
                  <#if day.blockerCount gt 0>
                  <span class="badge blocker">ðŸš« ${day.blockerCount} blockers</span>
                  </#if>
                </div>
              </div>
            </div>
            </#list>
          </section>

          <section class="card">
            <h2>ðŸŽ¯ Epic Progress</h2>
            <#if epicProgress?has_content>
            <table>
              <thead>
              <tr>
                <th>Epic</th>
                <th>Issues</th>
                <th>Progress</th>
                <th>Story Points</th>
                <th>Health</th>
              </tr>
              </thead>
              <tbody>
              <#list epicProgress as epic>
              <tr>
                <td>
                  <strong>${epic.epicKey}</strong><br>
                  <small>${epic.epicName}</small>
                </td>
                <td>
                  <span class="badge done">${epic.doneCount}</span> / ${epic.totalIssues}
                </td>
                <td>
                  <div class="progress-bar">
                    <div class="fill" style="width: ${epic.completionPct}%">
                      ${epic.completionPct}%
                    </div>
                  </div>
                </td>
                <td>
                  <strong>${epic.donePoints}</strong> / ${epic.totalPoints}
                </td>
                <td>
                  ${epic.healthStatus}
                </td>
              </tr>
              </#list>
              </tbody>
            </table>
            <#else>
            <p>No epic data available</p>
            </#if>
          </section>

          <section>
            <h2>ðŸ’¡ AI-Generated Insights</h2>
            <div class="insight-box">
              <h3>ðŸ“‹ Executive Summary</h3>
              <div>${executiveSummary}</div>
            </div>
            <#if strategyInsights.focusAreas??>
            <div class="insight-box">
              <h3>ðŸŽ¯ Focus Areas</h3>
              <ul>
                <#list strategyInsights.focusAreas as area>
                <li>${area}</li>
                </#list>
              </ul>
            </div>
            </#if>
          </section>

          <footer>
            <p>Generated by Synthesis Engine â€¢ Powered by Neo4j &amp; Azure OpenAI</p>
            <p>Report ID: ${.now?long}</p>
          </footer>
        </div>
      </body>
    </html>
