# ==================================================================
# LMT Jira Daily Report - Knowledge Graph Edition with Chunking
# ==================================================================
#
# ARCHITECTURE:
# Phase 1: Data Collection & Normalization (Jira API + JOLT)
# Phase 2: Chunking Strategy (Divide issues into processable batches)
# Phase 3: Knowledge Graph Extraction (LLM extracts nodes + relationships per chunk)
# Phase 4: Merge & Deduplication (Combine all chunks into unified graph)
# Phase 5: Neo4j Persistence (Persist graph structure)
# Phase 6: Analytics Queries (Aggregate data for reports)
# Phase 7: Multi-Page HTML Reports
# ==================================================================

config:
  fresh: true

  transformDefaultParams:
    jolt:
      - "${#recipe['jolts']['joltNeo4jTableToJson']}"
    neo4j:
      - "http://localhost:7474/db/neo4j/tx/commit"
      - "${@Utils.createBasicAuthHeader('neo4j', 'select-shirt-judge-miguel-antonio-46')}"

  options:
    - name: clearDatabase
      type: BOOLEAN
      label: "Clear 'JiraReports' Nodes in database before anything?"
      defaultValue: false

    - name: jiraProjectKey
      type: TEXT
      label: "Jira Project Key"
      defaultValue: "LMT"

    - name: daysBack
      type: TEXT
      label: "Days to Analyze"
      defaultValue: 14

    - name: chunkSize
      type: TEXT
      label: "Issues per Chunk (for LLM processing)"
      defaultValue: 10

  agents:
    - name: KNOWLEDGE_GRAPH_EXTRACTOR
      provider: azure
      model: gpt-4o
      deploymentName: Chatbot
      temperature: 0.1
      maxTurns: 1

    - name: EXECUTIVE_SUMMARY_AGENT
      provider: azure
      model: gpt-4o
      deploymentName: Chatbot
      temperature: 0.3
      maxTurns: 1

    - name: USER_REPORT_AGENT
      provider: azure
      model: gpt-4o-mini
      deploymentName: Chatbot
      temperature: 0.2
      maxTurns: 1

    - name: EPIC_REPORT_AGENT
      provider: azure
      model: gpt-4o-mini
      deploymentName: Chatbot
      temperature: 0.2
      maxTurns: 1

caches:
  transforms:
    - prompt
    - agent
    - neo4j
    - jolt

executor: ProjectModelExecutor3.java

# ==================================================================
# PROJECT MODEL (Pipeline + Multi-Page Reports)
# ==================================================================
projectModel:
  # --- Phase 1: Data Collection ---
  _clearDatabase: "${$api.configs.options.clearDatabase ? #recipe['templates']['clearDatabase'] : ''}"

  phase1/collectJiraData.json: "${#recipe['templates']['collectJiraIssues']}"
  phase1/enrichChangelogs.json: "${#recipe['templates']['enrichChangelogData']}"

  # --- Phase 2-4: Chunking + Knowledge Graph Extraction + Merge ---
  phase2/prepareChunks.json: "${#recipe['templates']['prepareChunks']}"
  phase3/extractKnowledgeGraphChunked.json: "${#recipe['templates']['extractKnowledgeGraphChunked']}"
  phase4/mergeKnowledgeGraph.json: "${#recipe['templates']['mergeKnowledgeGraph']}"

  # --- Phase 5: Neo4j Persistence ---
  phase5/persistGraph.json: "${#recipe['templates']['persistKnowledgeGraph']}"

  # --- Phase 6: Analytics ---
  phase6/analytics.json: "${#recipe['templates']['runAnalytics']}"

  # --- Phase 7: Generate Reports ---
  reports/index.html: "${#recipe['templates']['generateIndexReport']}"
  reports/executive-summary.html: "${#recipe['templates']['generateExecutiveSummary']}"
  reports/users: "${#allUsers != null && !#allUsers.isEmpty() ? @Utils.createWithAListOfKeys(#allUsers.![#this['userId']], #recipe['templates']['generateUserReport']) : {}}"
  reports/epics: "${#allEpics != null && !#allEpics.isEmpty() ? @Utils.createWithAListOfKeys(#allEpics.![#this['epicKey']], #recipe['templates']['generateEpicReport']) : {}}"
  reports/issues.html: "${#recipe['templates']['generateIssuesReport']}"

# ==================================================================
# JOLT TRANSFORMATIONS
# ==================================================================
jolts:
  joltNeo4jTableToJson: |-
    [
      {
        "operation": "shift",
        "spec": {
          "results": {
            "*": {
              "data": {
                "*": {
                  "row": {
                    "*": "[&2].@(4,columns[&0])"
                  }
                }
              }
            }
          }
        }
      }
    ]

  joltJiraToNormalized: |-
    [
      {
        "operation": "shift",
        "spec": {
          "*": {
            "id": "[&1].issueId",
            "key": "[&1].issueKey",
            "self": "[&1].issueUrl",
            "fields": {
              "summary": "[&2].summary",
              "issuetype": {
                "name": "[&2].issueType"
              },
              "status": {
                "name": "[&2].status",
                "statusCategory": {
                  "name": "[&2].statusCategory"
                }
              },
              "priority": {
                "name": "[&2].priority"
              },
              "created": "[&2].createdDate",
              "updated": "[&2].updatedDate",
              "duedate": "[&2].dueDate",
              "resolutiondate": "[&2].resolvedDate",
              "reporter": {
                "displayName": "[&3].reporter.name",
                "emailAddress": "[&3].reporter.email",
                "accountId": "[&3].reporter.accountId"
              },
              "assignee": {
                "displayName": "[&3].assignee.name",
                "emailAddress": "[&3].assignee.email",
                "accountId": "[&3].assignee.accountId"
              },
              "parent": {
                "key": "[&2].parent.key",
                "fields": {
                  "summary": "[&3].parent.summary",
                  "status": {
                    "name": "[&4].parent.status"
                  },
                  "priority": {
                    "name": "[&4].parent.priority"
                  },
                  "issuetype": {
                    "name": "[&4].parent.issueType"
                  }
                }
              },
              "customfield_10014": "[&2].epicLinkField",
              "customfield_10016": "[&2].storyPoints",
              "description": {
                "content": {
                  "*": {
                    "content": {
                      "*": {
                        "text": "[&5].description[]"
                      }
                    }
                  }
                }
              }
            },
            "changelog": {
              "histories": {
                "*": {
                  "created": "[&4].changeHistory[&1].date",
                  "author": {
                    "displayName": "[&5].changeHistory[&2].author"
                  },
                  "items": {
                    "*": {
                      "field": "[&6].changeHistory[&3].changes[&2].field",
                      "fromString": "[&6].changeHistory[&3].changes[&2].oldValue",
                      "toString": "[&6].changeHistory[&3].changes[&2].newValue"
                    }
                  }
                }
              }
            }
          }
        }
      },
      {
        "operation": "default",
        "spec": {
          "*": {
            "description": [],
            "storyPoints": "0",
            "dueDate": null,
            "resolvedDate": null,
            "assignee": {
              "name": "Unassigned",
              "email": "",
              "accountId": "unassigned"
            },
            "reporter": {
              "name": "Unknown",
              "email": "",
              "accountId": "unknown"
            },
            "parent": null,
            "epicLinkField": null
          }
        }
      },
      {
        "operation": "modify-overwrite-beta",
        "spec": {
          "*": {
            "description": "=join(' ', @(1,description))",
            "storyPoints": "=toInteger(@(1,storyPoints))"
          }
        }
      }
    ]

  joltEnrichChangelog: |-
    [
      {
        "operation": "shift",
        "spec": {
          "*": {
            "@": "[&1]",
            "changeHistory": {
              "*": {
                "changes": {
                  "*": {
                    "field": {
                      "status": {
                        "@(3,date)": "[&6].dailyStatusChanges[&3].date",
                        "@(2,oldValue)": "[&6].dailyStatusChanges[&3].from",
                        "@(2,newValue)": "[&6].dailyStatusChanges[&3].to",
                        "@(3,author)": "[&6].dailyStatusChanges[&3].author"
                      }
                    }
                  }
                }
              }
            }
          }
        }
      },
      {
        "operation": "shift",
        "spec": {
          "*": {
            "*": "[&1].&",
            "dailyStatusChanges": {
              "*": "[&3].dailyStatusChanges[&1]"
            }
          }
        }
      }
    ]

# ==================================================================
# TEMPLATES
# ==================================================================
templates:
  # -----------------------------------------------------------------
  # PHASE 1: DATA COLLECTION
  # -----------------------------------------------------------------

  clearDatabase: |-
    @@@log("#00FF00Clearing Neo4j database...")
    @@@neo4j
    @@@jsonify
    MATCH (n:JiraReport) DETACH DELETE n;

  collectJiraIssues: |-
    @@@log("#FF00FF========================================")
    @@@log("#FF00FFPHASE 1: DATA COLLECTION")
    @@@log("#FF00FF========================================")
    @@@freemarker
    @@@objectify
    @@@set("jqlQuery")
    project = ${$api.configs.options.jiraProjectKey!"LMT"} AND updated >= '-${$api.configs.options.daysBack!14}d' ORDER BY updated DESC
    @@@freemarker
    @@@objectify
    @@@set("jiraPayload")
    {
      "jql": "${jqlQuery}",
      "fields": ["summary","description","status","assignee","reporter","issuetype","priority","created","updated","parent","duedate","resolutiondate","customfield_10016","customfield_10014"],
      "expand": "changelog",
      "maxResults": 100
    }
    @@@spel("${@Utils.getEnvVariable('JIRA_AUTH_HEADER')}")
    @@@set("jiraAuthHeader")
    @@@freemarker
    @@@objectify
    @@@set("jiraHeaders")
    {
      "Authorization": "${jiraAuthHeader}",
      "Content-Type": "application/json"
    }
    @@@freemarker
    @@@objectify
    @@@set("paginationConfig")
    {
      "type": "CURSOR",
      "nextTokenField": "nextPageToken",
      "isLastField": "isLast",
      "itemsPath": "$.issues",
      "pageSize": 100,
      "maxPages": 50
    }
    @@@api("https://ilabs-capco.atlassian.net/rest/api/3/search/jql", "POST", "${#jiraPayload}", "${#jiraHeaders}", "${#paginationConfig}")
    @@@set("rawApiResult")
    @@@log("${'Collected ' + #rawApiResult['totalItems'] + ' issues from Jira'}")
    @@@get("rawApiResult.items")
    @@@jolt("${#recipe['jolts']['joltJiraToNormalized']}")
    @@@set("normalizedIssues")
    @@@log("${'Normalized ' + #normalizedIssues.size() + ' issues'}")
    @@@jsonify

  enrichChangelogData: |-
    @@@log("#00FF00Enriching changelog data...")
    @@@get("normalizedIssues")
    @@@jolt("${#recipe['jolts']['joltEnrichChangelog']}")
    @@@set("enrichedIssues")
    @@@log("${'Enriched ' + #enrichedIssues.size() + ' issues with changelogs'}")
    @@@jsonify

  # -----------------------------------------------------------------
  # PHASE 2: CHUNKING STRATEGY
  # -----------------------------------------------------------------

  prepareChunks: |-
    @@@log("#00FFFF========================================")
    @@@log("#00FFFFPHASE 2: CHUNKING STRATEGY")
    @@@log("#00FFFF========================================")
    @@@freemarker
    <#assign totalIssues = enrichedIssues?size>
    <#assign chunkSize = $api.configs.options.chunkSize!10>
    <#assign totalChunks = (totalIssues / chunkSize)?ceiling>
    {
      "totalIssues": ${totalIssues},
      "chunkSize": ${chunkSize},
      "totalChunks": ${totalChunks},
      "chunks": [
        <#list 0..<totalChunks as chunkIndex>
        {
          "chunkIndex": ${chunkIndex},
          "startIndex": ${chunkIndex * chunkSize},
          "endIndex": ${((chunkIndex + 1) * chunkSize)?min(totalIssues)},
          "size": ${(((chunkIndex + 1) * chunkSize)?min(totalIssues)) - (chunkIndex * chunkSize)}
        }<#if chunkIndex < totalChunks - 1>,</#if>
        </#list>
      ]
    }
    @@@objectify
    @@@set("chunkingConfig")
    @@@_exec("${#recipe['templates']['saveChunksToContext']}")
    @@@log("${'Created ' + #totalChunks + ' chunks of ~' + #chunkingConfig['chunkSize'] + ' issues each'}")
    @@@spel("${'Chunking completed'}")

  saveChunksToContext: |-
    @@@get("chunkingConfig.chunks")
    @@@set("chunks")
    @@@get("chunkingConfig.totalChunks")
    @@@set("totalChunks")

  prepareChunkIssues: |-
    @@@spel("${#enrichedIssues.subList(#chunk['startIndex'], #chunk['endIndex'])}")
    @@@set("chunkIssues")
    @@@get("chunkIssues")
    @@@jsonify
    @@@set("chunkIssuesJson")
    @@@log("${'Chunk ' + (#chunk['chunkIndex'] + 1) + ' contains ' + #chunkIssues.size() + ' issues (~' + (#chunkIssuesJson.length() / 1024) + ' KB)'}")

  # -----------------------------------------------------------------
  # PHASE 3: KNOWLEDGE GRAPH EXTRACTION (CHUNKED)
  # -----------------------------------------------------------------

  extractKnowledgeGraphChunked: |-
    @@@log("#00FFFF========================================")
    @@@log("#00FFFFPHASE 3: CHUNKED KNOWLEDGE GRAPH EXTRACTION")
    @@@log("#00FFFF========================================")
    @@@freemarker
    {"nodes": [], "relationships": []}
    @@@objectify
    @@@set("accumulatedKnowledgeGraph")
    @@@get("chunks")
    @@@repeat("${#content}", "chunk", "${#recipe['templates']['processChunk']}")
    @@@get("accumulatedKnowledgeGraph")
    @@@log("${'Total accumulated - Nodes: ' + #accumulatedKnowledgeGraph['nodes'].size() + ', Relationships: ' + #accumulatedKnowledgeGraph['relationships'].size()}")
    @@@jsonify

  processChunk: |-
    @@@log("${'Processing chunk ' + (#chunk['chunkIndex'] + 1) + '/' + #totalChunks}")
    @@@_exec("${#recipe['templates']['prepareChunkIssues']}")
    @@@freemarker
    @@@agent("KNOWLEDGE_GRAPH_EXTRACTOR")
    @@@extractMarkdownCode
    @@@objectify
    @@@set("chunkKnowledgeGraph")
    @@@log("${'Chunk ' + (#chunk['chunkIndex'] + 1) + ' extracted - Nodes: ' + #chunkKnowledgeGraph['nodes'].size() + ', Relationships: ' + #chunkKnowledgeGraph['relationships'].size()}")
    @@@_spel("${#accumulatedKnowledgeGraph['nodes'].addAll(#chunkKnowledgeGraph['nodes'])}")
    @@@_spel("${#accumulatedKnowledgeGraph['relationships'].addAll(#chunkKnowledgeGraph['relationships'])}")

    You are a Knowledge Graph extraction specialist. Extract entities and relationships from Jira issues.

    # INPUT DATA (${chunk.size} issues in this chunk)
    ```json
    ${chunkIssuesJson}
    ```

    # YOUR TASK

    Create a JSON object with TWO arrays: `nodes` and `relationships`.

    ## STEP 1: Extract ALL Nodes

    For EACH issue, extract:

    1. **User nodes** (from assignee and reporter):
       - id: accountId
       - type: "User"
       - properties: { accountId, name, email }

    2. **Issue nodes**:
       - id: issueKey
       - type: "Issue"
       - properties: { key, summary, description, status, priority, issueType, createdDate, updatedDate, storyPoints }
       - Use defaults: description="" if missing, priority="Medium", storyPoints=0

    3. **Epic nodes** (ONLY if parent.issueType === "Epic"):
       - id: parent.key
       - type: "Epic"
       - properties: { key: parent.key, name: parent.summary, status: parent.status }

    4. **StatusChange nodes** (from dailyStatusChanges):
       - id: issueKey + "|" + date + "|" + from + "->" + to
       - type: "StatusChange"
       - properties: { issueKey, date, from, to, author }

    ## STEP 2: Extract ALL Relationships (MANDATORY!)

    For EACH issue:

    1. **ASSIGNED_TO**: Issue ‚Üí User (assignee)
       - SKIP ONLY if assignee.accountId === "unassigned"

    2. **REPORTED_BY**: Issue ‚Üí User (reporter)
       - Always create

    3. **BELONGS_TO_EPIC**: Issue ‚Üí Epic
       - Create IF parent.issueType === "Epic"
       - source: issueKey, target: parent.key

    4. **STATUS_CHANGED**: StatusChange ‚Üí Issue
       - For each StatusChange node

    # OUTPUT FORMAT

    ```json
    {
      "nodes": [
        { "id": "user-id", "type": "User", "properties": {...} },
        { "id": "epic-id", "type": "Epic", "properties": {...} },
        { "id": "issue-id", "type": "Issue", "properties": {...} }
      ],
      "relationships": [
        { "source": "issue-id", "target": "user-id", "type": "ASSIGNED_TO" },
        { "source": "issue-id", "target": "user-id", "type": "REPORTED_BY" },
        { "source": "issue-id", "target": "epic-id", "type": "BELONGS_TO_EPIC" }
      ]
    }
    ```

    **CRITICAL RULES:**
    - Number of ASSIGNED_TO ‚âà ${chunk.size} (minus unassigned)
    - Number of REPORTED_BY === ${chunk.size}
    - All nodes must have id, type, properties
    - Return ONLY valid JSON - no explanations

  # -----------------------------------------------------------------
  # PHASE 4: MERGE & DEDUPLICATION
  # -----------------------------------------------------------------

  mergeKnowledgeGraph: |-
    @@@log("#00FF00========================================")
    @@@log("#00FF00PHASE 4: MERGE & DEDUPLICATION")
    @@@log("#00FF00========================================")
    @@@get("accumulatedKnowledgeGraph")
    @@@set("accumulatedKG")
    @@@script("deduplicateKnowledgeGraph")
    @@@set("knowledgeGraph")
    @@@log("${'Merge complete - Unique Nodes: ' + #knowledgeGraph['nodes'].size() + ', Unique Relationships: ' + #knowledgeGraph['relationships'].size()}")
    @@@jsonify

  # -----------------------------------------------------------------
  # PHASE 5: NEO4J PERSISTENCE
  # -----------------------------------------------------------------

  persistKnowledgeGraph: |-
    @@@log("#00FF00========================================")
    @@@log("#00FF00PHASE 5: NEO4J PERSISTENCE")
    @@@log("#00FF00========================================")
    @@@_exec("${#recipe['templates']['persistNodes']}")
    @@@_exec("${#recipe['templates']['persistRelationships']}")
    @@@spel("${T(java.util.Map).of('graphPersisted', true)}")
    @@@jsonify

  persistNodes: |-
    @@@log("#00FF00Persisting nodes...")
    @@@get("knowledgeGraph.nodes")
    @@@repeat("${#content}", "node", "${#recipe['templates']['persistSingleNode']}")
    @@@log("${'Persisted ' + #knowledgeGraph['nodes'].size() + ' nodes'}")
    @@@jsonify

  persistSingleNode: |-
    @@@freemarker
    @@@neo4j
    @@@jsonify

    <#assign props = node.properties>
    MERGE (n:${node.type}:JiraReport {id: '${node.id}'})
    SET
      <#if node.type == "User">
      n.name = '${(props.name!'Unknown')?json_string}',
      n.email = '${(props.email!'')?json_string}',
      n.accountId = '${(props.accountId!node.id)?json_string}'
      <#elseif node.type == "Epic">
      n.key = '${node.id}',
      n.name = '${(props.name!'Unknown Epic')?json_string}',
      n.status = '${(props.status!'Unknown')?json_string}'
      <#elseif node.type == "Issue">
      n.key = '${node.id}',
      n.summary = '${(props.summary!'No summary')?json_string}',
      n.description = '${(props.description!'')?json_string}',
      n.status = '${(props.status!'Unknown')?json_string}',
      n.priority = '${(props.priority!'Medium')?json_string}',
      n.issueType = '${(props.issueType!'Task')?json_string}',
      n.createdDate = '${(props.createdDate!'')?json_string}',
      n.updatedDate = '${(props.updatedDate!'')?json_string}',
      n.storyPoints = ${props.storyPoints!0}
      <#elseif node.type == "StatusChange">
      n.key = '${node.id}',
      n.issueKey = '${(props.issueKey!'')?json_string}',
      n.date = '${(props.date!'')?json_string}',
      n.from = '${(props.from!'Unknown')?json_string}',
      n.to = '${(props.to!'Unknown')?json_string}',
      n.author = '${(props.author!'Unknown')?json_string}'
      </#if>
    RETURN n.id AS nodeId

  persistRelationships: |-
    @@@log("#00FF00Persisting relationships...")
    @@@get("knowledgeGraph.relationships")
    @@@repeat("${#content}", "rel", "${#recipe['templates']['persistSingleRelationship']}")
    @@@log("${'Persisted ' + #knowledgeGraph['relationships'].size() + ' relationships'}")
    @@@jsonify

  persistSingleRelationship: |-
    @@@freemarker
    @@@neo4j
    @@@jsonify

    MATCH (source:JiraReport {id: '${rel.source}'})
    MATCH (target:JiraReport {id: '${rel.target}'})
    MERGE (source)-[r:${rel.type}]->(target)
    RETURN type(r) AS relType

  # -----------------------------------------------------------------
  # PHASE 6: ANALYTICS QUERIES
  # -----------------------------------------------------------------

  runAnalytics: |-
    @@@log("#FF00FF========================================")
    @@@log("#FF00FFPHASE 6: ANALYTICS")
    @@@log("#FF00FF========================================")
    @@@_exec("${#recipe['templates']['queryAllUsers']}")
    @@@_exec("${#recipe['templates']['queryAllEpics']}")
    @@@_exec("${#recipe['templates']['queryAllIssues']}")
    @@@_exec("${#recipe['templates']['queryDailyChanges']}")
    @@@_exec("${#recipe['templates']['queryProjectStats']}")
    @@@spel("${T(java.util.Map).of('analyticsCompleted', true)}")
    @@@jsonify

  queryAllUsers: |-
    @@@log("#FF00FFQuerying all users...")
    @@@freemarker
    @@@neo4j
    @@@jolt
    @@@set("allUsers")

    MATCH (u:User:JiraReport)
    WHERE u.accountId <> 'unassigned'
    OPTIONAL MATCH (u)<-[:ASSIGNED_TO]-(i:Issue:JiraReport)
    WITH u,
         count(DISTINCT i) AS totalIssues,
         count(DISTINCT CASE WHEN i.status IN ['Done', 'Closed', 'Resolved'] THEN i END) AS completed
    RETURN u.accountId AS userId,
           u.name AS userName,
           u.email AS userEmail,
           totalIssues,
           completed,
           CASE WHEN totalIssues > 0
                THEN round(100.0 * completed / totalIssues, 1)
                ELSE 0.0 END AS completionRate
    ORDER BY totalIssues DESC

  queryAllEpics: |-
    @@@log("#FF00FFQuerying all epics...")
    @@@freemarker
    @@@neo4j
    @@@jolt
    @@@set("allEpics")

    OPTIONAL MATCH (e:Epic:JiraReport)
    OPTIONAL MATCH (e)<-[:BELONGS_TO_EPIC]-(i:Issue:JiraReport)
    WITH e,
         count(i) AS totalIssues,
         count(CASE WHEN i.status IN ['Done', 'Closed', 'Resolved'] THEN 1 END) AS completed
    WHERE e IS NOT NULL
    RETURN e.key AS epicKey,
           e.name AS epicName,
           e.status AS epicStatus,
           totalIssues,
           completed,
           CASE WHEN totalIssues > 0
                THEN round(100.0 * completed / totalIssues, 1)
                ELSE 0.0 END AS progress
    ORDER BY totalIssues DESC

  queryAllIssues: |-
    @@@log("#FF00FFQuerying all issues...")
    @@@freemarker
    @@@neo4j
    @@@jolt
    @@@set("allIssues")

    MATCH (i:Issue:JiraReport)
    OPTIONAL MATCH (i)-[:ASSIGNED_TO]->(u:User:JiraReport)
    OPTIONAL MATCH (i)-[:BELONGS_TO_EPIC]->(e:Epic:JiraReport)
    RETURN i.key AS issueKey,
           i.summary AS summary,
           i.status AS status,
           i.priority AS priority,
           i.issueType AS issueType,
           COALESCE(i.storyPoints, 0) AS storyPoints,
           COALESCE(u.name, 'Unassigned') AS assigneeName,
           e.key AS epicKey
    ORDER BY i.updatedDate DESC
    LIMIT 100

  queryDailyChanges: |-
    @@@log("#FF00FFQuerying daily status changes...")
    @@@freemarker
    @@@neo4j
    @@@jolt
    @@@set("dailyChanges")

    OPTIONAL MATCH (i:Issue:JiraReport)-[:STATUS_CHANGED]->(sc:StatusChange:JiraReport)
    WITH CASE WHEN sc IS NOT NULL THEN date(sc.date) ELSE null END AS day,
         CASE WHEN sc IS NOT NULL THEN collect({
           issueKey: i.key,
           summary: i.summary,
           from: sc.from,
           to: sc.to,
           author: sc.author
         }) ELSE [] END AS changes
    WHERE day IS NOT NULL
    RETURN toString(day) AS date,
           size([c IN changes WHERE c.to IN ['Done', 'Closed', 'Resolved']]) AS completed,
           size([c IN changes WHERE c.to = 'In Progress']) AS started,
           size([c IN changes WHERE c.to CONTAINS 'Block']) AS blocked,
           changes
    ORDER BY day DESC
    LIMIT ${$api.configs.options.daysBack!14}

  queryProjectStats: |-
    @@@log("#FF00FFQuerying project statistics...")
    @@@neo4j
    @@@jolt
    @@@set("projectStats")

    OPTIONAL MATCH (i:Issue:JiraReport)
    WITH count(i) AS totalIssues,
         count(CASE WHEN i.status IN ['Done', 'Closed'] THEN 1 END) AS completedIssues,
         count(CASE WHEN i.status = 'In Progress' THEN 1 END) AS inProgress,
         count(CASE WHEN i.status CONTAINS 'Block' THEN 1 END) AS blocked,
         COALESCE(sum(i.storyPoints), 0) AS totalPoints,
         COALESCE(sum(CASE WHEN i.status IN ['Done', 'Closed', 'Resolved'] THEN i.storyPoints ELSE 0 END), 0) AS completedPoints
    OPTIONAL MATCH (u:User:JiraReport)
    WHERE u.accountId <> 'unassigned'
    WITH totalIssues, completedIssues, inProgress, blocked, totalPoints, completedPoints, count(u) AS totalUsers
    OPTIONAL MATCH (e:Epic:JiraReport)
    RETURN totalIssues,
           completedIssues,
           inProgress,
           blocked,
           totalPoints,
           completedPoints,
           totalUsers,
           count(e) AS totalEpics,
           CASE WHEN totalIssues > 0
                THEN round(100.0 * completedIssues / totalIssues, 1)
                ELSE 0.0 END AS overallProgress

  # -----------------------------------------------------------------
  # PHASE 7: REPORT GENERATION
  # -----------------------------------------------------------------

  prepareAnalyticsDataForLLM: |-
    @@@log("#00FF00Preparing analytics data for LLM...")
    @@@get("projectStats")
    @@@jsonify
    @@@set("projectStatsJson")
    @@@get("dailyChanges")
    @@@jsonify
    @@@set("dailyChangesJson")
    @@@get("allUsers")
    @@@jsonify
    @@@set("allUsersJson")
    @@@get("allEpics")
    @@@jsonify
    @@@set("allEpicsJson")
    @@@log("${'Analytics data prepared for LLM'}")

  generateIndexReport: |-
    @@@log("#00FFFF========================================")
    @@@log("#00FFFFPHASE 7: GENERATING REPORTS")
    @@@log("#00FFFF========================================")
    @@@freemarker

    <!DOCTYPE html>
    <html lang="en">
    <head>
      <meta charset="UTF-8">
      <title>Jira Daily Report - ${$api.configs.options.jiraProjectKey}</title>
      <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          min-height: 100vh;
          padding: 2rem;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        header {
          background: white;
          padding: 2rem;
          border-radius: 12px;
          margin-bottom: 2rem;
          box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        h1 { color: #667eea; font-size: 2.5rem; margin-bottom: 0.5rem; }
        .meta { color: #64748b; font-size: 1.1rem; }
        .grid {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
          gap: 1.5rem;
          margin-bottom: 2rem;
        }
        .stat-card {
          background: white;
          padding: 1.5rem;
          border-radius: 12px;
          box-shadow: 0 2px 8px rgba(0,0,0,0.05);
          text-align: center;
        }
        .stat-card h3 { font-size: 0.875rem; text-transform: uppercase; color: #64748b; margin-bottom: 0.5rem; }
        .stat-card .number { font-size: 2.5rem; font-weight: 700; color: #667eea; }
        .card {
          background: white;
          padding: 2rem;
          border-radius: 12px;
          box-shadow: 0 2px 8px rgba(0,0,0,0.05);
          margin-bottom: 1.5rem;
        }
        .card h2 { color: #667eea; margin-bottom: 1rem; }
        .link-grid {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
          gap: 1rem;
        }
        .link-card {
          background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
          padding: 1.5rem;
          border-radius: 8px;
          text-decoration: none;
          color: #1e293b;
          transition: transform 0.2s;
          border-left: 4px solid #667eea;
        }
        .link-card:hover { transform: translateY(-4px); box-shadow: 0 8px 16px rgba(0,0,0,0.1); }
        .link-card h3 { font-size: 1.1rem; margin-bottom: 0.5rem; color: #667eea; }
        .link-card p { font-size: 0.875rem; color: #64748b; }
        footer {
          text-align: center;
          color: white;
          margin-top: 2rem;
          opacity: 0.9;
        }
      </style>
    </head>
    <body>
      <div class="container">
        <header>
          <h1>üìä Daily Project Report</h1>
          <div class="meta">
            Project: <strong>${$api.configs.options.jiraProjectKey}</strong> ‚Ä¢
            Generated: <strong>${.now?string("yyyy-MM-dd HH:mm")}</strong> ‚Ä¢
            Period: <strong>Last ${$api.configs.options.daysBack} days</strong>
          </div>
        </header>

        <!-- Project Stats -->
        <div class="grid">
          <#if projectStats?? && projectStats?has_content>
          <#assign stats = projectStats[0]>
          <div class="stat-card">
            <h3>Total Issues</h3>
            <div class="number">${stats.totalIssues!0}</div>
          </div>
          <div class="stat-card">
            <h3>Completed</h3>
            <div class="number">${stats.completedIssues!0}</div>
          </div>
          <div class="stat-card">
            <h3>In Progress</h3>
            <div class="number">${stats.inProgress!0}</div>
          </div>
          <div class="stat-card">
            <h3>Overall Progress</h3>
            <div class="number">${stats.overallProgress!0}%</div>
          </div>
          </#if>
        </div>

        <!-- Navigation Links -->
        <div class="card">
          <h2>üìã Reports</h2>
          <div class="link-grid">
            <a href="executive-summary.html" class="link-card">
              <h3>üìã Executive Summary</h3>
              <p>Daily highlights and key insights</p>
            </a>
            <a href="issues.html" class="link-card">
              <h3>üêõ All Issues</h3>
              <p>Complete issue listing</p>
            </a>
          </div>
        </div>

        <div class="card">
          <h2>üë• By User</h2>
          <div class="link-grid">
            <#if allUsers??>
              <#list allUsers as user>
              <a href="users/${user.userId}.html" class="link-card">
                <h3>${user.userName!"Unknown"}</h3>
                <p>${user.totalIssues!0} issues ‚Ä¢ ${user.completionRate!0}% complete</p>
              </a>
              </#list>
            </#if>
          </div>
        </div>

        <div class="card">
          <h2>üéØ By Epic</h2>
          <div class="link-grid">
            <#if allEpics??>
              <#list allEpics as epic>
              <a href="epics/${epic.epicKey}.html" class="link-card">
                <h3>${epic.epicKey}</h3>
                <p>${epic.totalIssues!0} issues ‚Ä¢ ${epic.progress!0}% complete</p>
              </a>
              </#list>
            </#if>
          </div>
        </div>

        <footer>
          <p>Generated by Synthesis Engine ‚Ä¢ Powered by Neo4j & Azure OpenAI</p>
        </footer>
      </div>
    </body>
    </html>

  generateExecutiveSummary: |-
    @@@_exec("${#recipe['templates']['prepareAnalyticsDataForLLM']}")
    @@@freemarker
    @@@agent("EXECUTIVE_SUMMARY_AGENT")
    @@@set("summaryMarkdown")
    @@@freemarker

    <!DOCTYPE html>
    <html lang="en">
    <head>
      <meta charset="UTF-8">
      <title>Executive Summary</title>
      <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
      <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
          font-family: -apple-system, sans-serif;
          background: #f8fafc;
          padding: 2rem;
        }
        .container { max-width: 1000px; margin: 0 auto; }
        header {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
          padding: 2rem;
          border-radius: 12px;
          margin-bottom: 2rem;
        }
        h1 { font-size: 2.5rem; }
        .card {
          background: white;
          padding: 2rem;
          border-radius: 12px;
          box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .markdown-content { line-height: 1.8; color: #475569; }
        .markdown-content h3 { color: #1e293b; margin-top: 1.5rem; margin-bottom: 0.75rem; }
        .markdown-content ul { padding-left: 1.5rem; }
        .markdown-content li { margin-bottom: 0.5rem; }
        .back { display: inline-block; margin-bottom: 1rem; color: #667eea; text-decoration: none; }
        .back:hover { text-decoration: underline; }
      </style>
    </head>
    <body>
      <div class="container">
        <a href="index.html" class="back">‚Üê Back to Dashboard</a>
        <header>
          <h1>üìã Executive Summary</h1>
          <p>Project: ${$api.configs.options.jiraProjectKey} ‚Ä¢ ${.now?string("yyyy-MM-dd")}</p>
        </header>
        <div class="card">
          <div id="summary" class="markdown-content"></div>
        </div>
      </div>
      <script>
        const markdown = `${summaryMarkdown!'No summary available'}`;
        document.getElementById('summary').innerHTML = marked.parse(markdown);
      </script>
    </body>
    </html>

    Create an executive summary for management (250-300 words):

    [PROJECT DATA]
    Project Stats: ${projectStatsJson}
    Daily Changes: ${dailyChangesJson}
    Users: ${allUsersJson}
    Epics: ${allEpicsJson}

    [REQUIREMENTS]
    - Executive-level (CEO/CTO audience)
    - Highlight key achievements and blockers
    - Identify top performers
    - Flag risks and delays
    - Provide 2-3 actionable recommendations
    - Use markdown formatting

  generateUserReport: |-
    @@@log("${'Generating report for user: ' + #fileName}")
    @@@spel("${#allUsers.?[#this['userId'] == #fileName][0]}")
    @@@set("currentUser")
    @@@freemarker
    @@@agent("USER_REPORT_AGENT")
    @@@set("userSummary")
    @@@freemarker

    <!DOCTYPE html>
    <html lang="en">
    <head>
      <meta charset="UTF-8">
      <title>${currentUser.userName} - User Report</title>
      <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, sans-serif; background: #f8fafc; padding: 2rem; }
        .container { max-width: 1000px; margin: 0 auto; }
        .back { display: inline-block; margin-bottom: 1rem; color: #667eea; text-decoration: none; }
        header {
          background: linear-gradient(135deg, #10b981 0%, #059669 100%);
          color: white;
          padding: 2rem;
          border-radius: 12px;
          margin-bottom: 2rem;
        }
        h1 { font-size: 2rem; }
        .grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 2rem; }
        .stat { background: white; padding: 1.5rem; border-radius: 8px; text-align: center; }
        .stat .number { font-size: 2rem; font-weight: 700; color: #10b981; }
        .stat .label { font-size: 0.875rem; color: #64748b; text-transform: uppercase; }
        .card { background: white; padding: 2rem; border-radius: 12px; margin-bottom: 1.5rem; }
        .card h2 { margin-bottom: 1rem; color: #1e293b; }
        .progress { width: 100%; height: 8px; background: #e2e8f0; border-radius: 4px; overflow: hidden; }
        .progress-bar { height: 100%; background: linear-gradient(90deg, #10b981 0%, #059669 100%); }
      </style>
    </head>
    <body>
      <div class="container">
        <a href="../index.html" class="back">‚Üê Back to Dashboard</a>
        <header>
          <h1>üë§ ${currentUser.userName}</h1>
          <p>${currentUser.userEmail}</p>
        </header>

        <div class="grid">
          <div class="stat">
            <div class="number">${currentUser.totalIssues!0}</div>
            <div class="label">Total Issues</div>
          </div>
          <div class="stat">
            <div class="number">${currentUser.completed!0}</div>
            <div class="label">Completed</div>
          </div>
          <div class="stat">
            <div class="number">${currentUser.completionRate!0}%</div>
            <div class="label">Completion Rate</div>
          </div>
        </div>

        <div class="card">
          <h2>Progress</h2>
          <div class="progress">
            <div class="progress-bar" style="width: ${currentUser.completionRate!0}%"></div>
          </div>
        </div>

        <div class="card">
          <h2>Analysis</h2>
          <p>${userSummary!'No analysis available'}</p>
        </div>
      </div>
    </body>
    </html>

    Analyze this user's performance (100-150 words):

    User: ${currentUser.userName}
    Total Issues: ${currentUser.totalIssues}
    Completed: ${currentUser.completed}
    Completion Rate: ${currentUser.completionRate}%

    Provide brief insights on workload, productivity, and recommendations.

  generateEpicReport: |-
    @@@log("${'Generating report for epic: ' + #fileName}")
    @@@spel("${#allEpics.?[#this['epicKey'] == #fileName][0]}")
    @@@set("currentEpic")
    @@@freemarker
    @@@agent("EPIC_REPORT_AGENT")
    @@@set("epicSummary")
    @@@freemarker

    <!DOCTYPE html>
    <html lang="en">
    <head>
      <meta charset="UTF-8">
      <title>${currentEpic.epicKey} - Epic Report</title>
      <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, sans-serif; background: #f8fafc; padding: 2rem; }
        .container { max-width: 1000px; margin: 0 auto; }
        .back { display: inline-block; margin-bottom: 1rem; color: #667eea; text-decoration: none; }
        header {
          background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
          color: white;
          padding: 2rem;
          border-radius: 12px;
          margin-bottom: 2rem;
        }
        h1 { font-size: 2rem; }
        .grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 2rem; }
        .stat { background: white; padding: 1.5rem; border-radius: 8px; text-align: center; }
        .stat .number { font-size: 2rem; font-weight: 700; color: #f59e0b; }
        .stat .label { font-size: 0.875rem; color: #64748b; text-transform: uppercase; }
        .card { background: white; padding: 2rem; border-radius: 12px; margin-bottom: 1.5rem; }
        .progress { width: 100%; height: 8px; background: #e2e8f0; border-radius: 4px; overflow: hidden; }
        .progress-bar { height: 100%; background: linear-gradient(90deg, #f59e0b 0%, #d97706 100%); }
      </style>
    </head>
    <body>
      <div class="container">
        <a href="../index.html" class="back">‚Üê Back to Dashboard</a>
        <header>
          <h1>üéØ ${currentEpic.epicKey}</h1>
          <p>${currentEpic.epicName}</p>
        </header>

        <div class="grid">
          <div class="stat">
            <div class="number">${currentEpic.totalIssues!0}</div>
            <div class="label">Total Issues</div>
          </div>
          <div class="stat">
            <div class="number">${currentEpic.completed!0}</div>
            <div class="label">Completed</div>
          </div>
          <div class="stat">
            <div class="number">${currentEpic.progress!0}%</div>
            <div class="label">Progress</div>
          </div>
        </div>

        <div class="card">
          <h2>Progress</h2>
          <div class="progress">
            <div class="progress-bar" style="width: ${currentEpic.progress!0}%"></div>
          </div>
        </div>

        <div class="card">
          <h2>Analysis</h2>
          <p>${epicSummary!'No analysis available'}</p>
        </div>
      </div>
    </body>
    </html>

    Analyze this epic's progress (100-150 words):

    Epic: ${currentEpic.epicKey} - ${currentEpic.epicName}
    Total Issues: ${currentEpic.totalIssues}
    Completed: ${currentEpic.completed}
    Progress: ${currentEpic.progress}%

    Provide brief insights on progress, risks, and recommendations.

  generateIssuesReport: |-
    @@@freemarker

    <!DOCTYPE html>
    <html lang="en">
    <head>
      <meta charset="UTF-8">
      <title>All Issues</title>
      <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, sans-serif; background: #f8fafc; padding: 2rem; }
        .container { max-width: 1400px; margin: 0 auto; }
        .back { display: inline-block; margin-bottom: 1rem; color: #667eea; text-decoration: none; }
        header {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
          padding: 2rem;
          border-radius: 12px;
          margin-bottom: 2rem;
        }
        table { width: 100%; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        th, td { padding: 1rem; text-align: left; border-bottom: 1px solid #e2e8f0; }
        th { background: #f8fafc; font-weight: 600; text-transform: uppercase; font-size: 0.75rem; color: #64748b; }
        .badge { padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.75rem; font-weight: 600; }
        .priority-High { background: #fee2e2; color: #991b1b; }
        .priority-Medium { background: #fef3c7; color: #92400e; }
        .priority-Low { background: #dbeafe; color: #1e40af; }
      </style>
    </head>
    <body>
      <div class="container">
        <a href="index.html" class="back">‚Üê Back to Dashboard</a>
        <header>
          <h1>üêõ All Issues</h1>
        </header>
        <table>
          <thead>
            <tr>
              <th>Key</th>
              <th>Summary</th>
              <th>Type</th>
              <th>Priority</th>
              <th>Status</th>
              <th>Assignee</th>
            </tr>
          </thead>
          <tbody>
            <#if allIssues??>
              <#list allIssues as issue>
              <tr>
                <td><code>${issue.issueKey!""}</code></td>
                <td>${issue.summary!"No summary"}</td>
                <td>${issue.issueType!"Unknown"}</td>
                <td><span class="badge priority-${issue.priority!'Medium'}">${issue.priority!"Medium"}</span></td>
                <td>${issue.status!"Unknown"}</td>
                <td>${issue.assigneeName!"Unassigned"}</td>
              </tr>
              </#list>
            </#if>
          </tbody>
        </table>
      </div>
    </body>
    </html>

# ==================================================================
# SCRIPTS
# ==================================================================
scripts:
  deduplicateKnowledgeGraph:
    name: deduplicateKnowledgeGraph
    type: GROOVY
    body: |-
      import com.capco.brsp.synthesisengine.service.IExecutor
      import org.springframework.context.ApplicationContext

      class DeduplicateKnowledgeGraph implements IExecutor {
          @Override
          Object execute(ApplicationContext applicationContext, Map<String, Object> projectContext, Object... params) {
              def accumulatedKG = projectContext['accumulatedKG']

              if (accumulatedKG == null) {
                  return [nodes: [], relationships: []]
              }

              // Ensure nodes and relationships exist and are lists
              def allNodes = accumulatedKG['nodes'] ?: []
              def allRelationships = accumulatedKG['relationships'] ?: []

              // Deduplicate nodes by id
              def nodesById = [:]
              allNodes.each { node ->
                  if (node?.id && !nodesById.containsKey(node.id)) {
                      nodesById[node.id] = node
                  }
              }

              // Deduplicate relationships by source+target+type
              def relationshipsSet = [] as Set
              def uniqueRelationships = []
              allRelationships.each { rel ->
                  if (rel?.source && rel?.target && rel?.type) {
                      def key = "${rel.source}|${rel.target}|${rel.type}"
                      if (!relationshipsSet.contains(key)) {
                          relationshipsSet.add(key)
                          uniqueRelationships.add(rel)
                      }
                  }
              }

              return [
                  nodes: nodesById.values() as List,
                  relationships: uniqueRelationships
              ]
          }
      }

