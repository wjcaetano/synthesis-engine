config:
  name: asset-intelligence-report
  fresh: false  # MantÃ©m contexto entre execuÃ§Ãµes (importante para cache)
  description: "Receita para geraÃ§Ã£o de relatÃ³rios de inteligÃªncia patrimonial baseados em dados CNPJ"
  transformDefaultParams:
    jolt:
      - "${#recipe['templates']['joltNeo4jTableToJson']}"
    neo4j:
      - "${@Utils.getEnvVariable('NEO4J_API_URI')}"
      - "${@Utils.createBasicAuthHeader(@Utils.getEnvVariable('NEO4J_USERNAME'), @Utils.getEnvVariable('NEO4J_PASSWORD'))}"
  options:
    - name: cnpj
      type: TEXT
      label: "CNPJ da empresa (8 dÃ­gitos ou formato completo)"
      required: true
    - name: max_empresas
      type: NUMBER
      label: "MÃ¡ximo de empresas relacionadas"
      defaultValue: 50
    - name: force_refresh
      type: DROPDOWN
      label: "ForÃ§ar atualizaÃ§Ã£o (ignorar cache)?"
      defaultValue: false
      values:
        - label: "NÃ£o - usar cache se disponÃ­vel"
          value: false
        - label: "Sim - processar novamente"
          value: true
  agents:
    - name: DEFAULT
      provider: azure
      model: gpt-4o
      deploymentName: Chatbot
      temperature: 0.7
      maxTurns: 1

executor: ProjectModelExecutor3.java

projectModel:
  _0_cache_check.json: "${#recipe['templates']['checkCache']}"
  _1_duckdb_query.json: "${#recipe['templates']['queryDuckDB']}"
  _2_llm_analysis.json: "${#recipe['templates']['llmAnalysis']}"
  _3_persist_neo4j.json: "${#recipe['templates']['persistNeo4j']}"
  relatorio_asset_intelligence.html: "${#recipe['templates']['generateReport']}"

templates:
  joltNeo4jTableToJson: |-
    [
      {
        "operation": "shift",
        "spec": {
          "results": {
            "*": {
              "data": {
                "*": {
                  "row": {
                    "0": "data"
                  }
                }
              }
            }
          }
        }
      }
    ]

  checkCache: |-
    @@@log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
    @@@log("âš¡ VERIFICANDO CACHE NEO4J")
    @@@log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
    @@@log("CNPJ consultado: ${$api.configs.options.cnpj}")
    @@@log(" ")

    @@@neo4j
    MATCH (e:EmpresaAlvo {cnpj_basico: "${#$api['configs']['options']['cnpj'].replaceAll('[^0-9]', '').substring(0, 8)}"})
    OPTIONAL MATCH (e)<-[:SOCIO_DE]-(s:Socio)
    OPTIONAL MATCH (e)-[:RELACIONADA]->(r:EmpresaRelacionada)
    RETURN
      CASE WHEN count(s) > 0 THEN true ELSE false END as exists,
      count(s) as total_socios,
      count(r) as total_relacionadas,
      e.ultima_atualizacao as last_update

    @@@jolt
    @@@objectify
    @@@set("cache")

    @@@log("${#cache['exists'] ? 'âœ… Cache encontrado! (' + #cache['total_socios'] + ' sÃ³cios, ' + #cache['total_relacionadas'] + ' empresas)' : 'âŒ Cache nÃ£o encontrado - serÃ¡ necessÃ¡rio processar'}")
    @@@log(" ")

    @@@skip("${#cache['exists'] && !#$api['configs']['options']['force_refresh']}")

    ${#cache}

  queryDuckDB: |-
    @@@log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
    @@@log("ğŸ” CONSULTANDO DUCKDB (DADOS PARQUET)")
    @@@log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
    @@@log("Aplicando relevance scoring...")
    @@@log("Limite de empresas: ${$api.configs.options.max_empresas}")
    @@@log(" ")

    @@@script("duckdbQueryOptimized", "${$api.configs.options.cnpj}", "${$api.configs.options.max_empresas}")
    @@@objectify
    @@@set("duckdbResult")

    @@@log("âœ… DuckDB retornou ${#duckdbResult['total_relacionadas']} empresas relacionadas")
    @@@log(" ")

    ${#duckdbResult}

  llmAnalysis: |-
    @@@log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
    @@@log("ğŸ¤– ANÃLISE LLM COM TOONIFY (REDUÃ‡ÃƒO DE TOKENS)")
    @@@log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")

    @@@toonify
    ${#duckdbResult}

    @@@log("ğŸ’° Tokens economizados: ~40% com TOON encoding")
    @@@log(" ")

    @@@prompt
    # Contexto
    VocÃª Ã© um analista sÃªnior de inteligÃªncia patrimonial especializado em anÃ¡lise de redes corporativas no Brasil.

    # Dados (formato TOON - otimizado)
    ${#toon}

    # Tarefa
    Analise a rede de relacionamentos corporativos e retorne um JSON com a seguinte estrutura:

    {
      "risco_score": <nÃºmero de 0-100, onde 100 = altÃ­ssimo risco>,
      "nivel_risco": "<BAIXO|MÃ‰DIO|ALTO|CRÃTICO>",
      "resumo_executivo": "<parÃ¡grafo de 2-3 frases sobre a empresa e seus principais relacionamentos>",
      "principais_socios": [
        {
          "nome": "<nome do sÃ³cio>",
          "cpf_cnpj": "<CPF ou CNPJ>",
          "qualificacao": "<tipo de participaÃ§Ã£o>",
          "relevancia": "<ALTA|MÃ‰DIA|BAIXA>",
          "justificativa": "<por que este sÃ³cio Ã© relevante>"
        }
      ],
      "empresas_chave": [
        {
          "cnpj": "<CNPJ>",
          "nome": "<razÃ£o social>",
          "nome_fantasia": "<nome fantasia>",
          "uf": "<UF>",
          "relevancia_score": <score numÃ©rico>,
          "motivo_relevancia": "<por que Ã© importante>"
        }
      ],
      "red_flags": [
        "<lista de alertas identificados, ex: 'Capital social muito baixo para o porte', 'MÃºltiplas empresas inativas', etc>"
      ],
      "oportunidades": [
        "<insights positivos sobre a rede corporativa>"
      ],
      "recomendacoes": [
        "<aÃ§Ãµes recomendadas para due diligence>"
      ]
    }

    # CritÃ©rios de AvaliaÃ§Ã£o de Risco
    - Alto capital social e empresas ativas = risco menor
    - MÃºltiplas empresas inativas/baixadas = risco elevado
    - ConcentraÃ§Ã£o geogrÃ¡fica vs diversificaÃ§Ã£o
    - Natureza jurÃ­dica das empresas relacionadas
    - PresenÃ§a de sÃ³cios PF em mÃºltiplas empresas (potencial "laranja")

    Retorne APENAS o JSON, sem markdown ou explicaÃ§Ãµes adicionais.

    @@@objectify
    @@@set("llmAnalysis")

    @@@log("âœ… AnÃ¡lise LLM concluÃ­da")
    @@@log("   Risco Score: ${#llmAnalysis['risco_score']}/100 (${#llmAnalysis['nivel_risco']})")
    @@@log("   Red Flags: ${#llmAnalysis['red_flags'].size()}")
    @@@log(" ")

    ${#llmAnalysis}

  persistNeo4j: |-
    @@@log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
    @@@log("ğŸ’¾ PERSISTINDO NO NEO4J (CACHE)")
    @@@log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")

    @@@neo4j
    // Criar nÃ³ da empresa alvo
    MERGE (e:EmpresaAlvo {cnpj_basico: "${#duckdbResult['cnpj_consultado']}"})
    SET e.razao_social = "${#duckdbResult['empresa_alvo']['razao_social']}",
        e.nome_fantasia = "${#duckdbResult['empresa_alvo']['nome_fantasia']}",
        e.capital_social = "${#duckdbResult['empresa_alvo']['capital_social']}",
        e.uf = "${#duckdbResult['empresa_alvo']['uf']}",
        e.municipio = "${#duckdbResult['empresa_alvo']['municipio']}",
        e.risco_score = ${#llmAnalysis['risco_score']},
        e.nivel_risco = "${#llmAnalysis['nivel_risco']}",
        e.ultima_atualizacao = datetime()

    // Criar nÃ³s de sÃ³cios principais
    WITH e
    UNWIND ${@JsonUtils.writeAsJsonString(#llmAnalysis['principais_socios'], false)} AS socio
    MERGE (s:Socio {cpf_cnpj: socio.cpf_cnpj})
    SET s.nome = socio.nome,
        s.qualificacao = socio.qualificacao,
        s.relevancia = socio.relevancia
    MERGE (s)-[:SOCIO_DE {justificativa: socio.justificativa}]->(e)

    // Criar nÃ³s de empresas relacionadas
    WITH e
    UNWIND ${@JsonUtils.writeAsJsonString(#duckdbResult['empresas_relacionadas'], false)} AS rel
    MERGE (r:EmpresaRelacionada {cnpj_basico: rel.cnpj_basico})
    SET r.razao_social = rel.razao_social,
        r.nome_fantasia = rel.nome_fantasia,
        r.capital_social = toString(rel.capital_social),
        r.porte_empresa = rel.porte_empresa,
        r.uf = rel.uf,
        r.municipio = rel.municipio,
        r.relevance_score = rel.relevance_score
    MERGE (e)-[:RELACIONADA {
      shared_partners: rel.shared_partners_count,
      socio_comum: rel.exemplo_socio_comum
    }]->(r)

    RETURN count(e) as empresas_criadas

    @@@jolt
    @@@objectify
    @@@set("neo4jResult")

    @@@log("âœ… Dados persistidos no Neo4j")
    @@@log(" ")

    ${#neo4jResult}

  generateReport: |-
    @@@freemarker
    <!DOCTYPE html>
    <html lang="pt-BR">
    <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>RelatÃ³rio de Asset Intelligence - ${duckdbResult.empresa_alvo.razao_social!"N/A"}</title>

      <!-- Vis.js Network -->
      <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>

      <!-- Chart.js -->
      <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

      <style>
        * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
        }

        body {
          font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
          background: #f5f7fa;
          color: #2d3748;
          line-height: 1.6;
        }

        .header {
          background: linear-gradient(135deg, #1a202c 0%, #2d3748 100%);
          color: white;
          padding: 40px 20px;
          text-align: center;
          box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
          font-size: 32px;
          font-weight: 700;
          margin-bottom: 10px;
        }

        .header .subtitle {
          font-size: 18px;
          opacity: 0.9;
        }

        .risk-badge {
          display: inline-block;
          padding: 12px 24px;
          border-radius: 25px;
          font-weight: bold;
          font-size: 18px;
          margin-top: 20px;
          text-transform: uppercase;
          letter-spacing: 1px;
        }

        .risk-BAIXO { background: #48bb78; color: white; }
        .risk-MÃ‰DIO { background: #ed8936; color: white; }
        .risk-ALTO { background: #f56565; color: white; }
        .risk-CRÃTICO { background: #c53030; color: white; }

        .container {
          max-width: 1400px;
          margin: 0 auto;
          padding: 40px 20px;
        }

        .grid-2 {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
          gap: 30px;
          margin-bottom: 30px;
        }

        .card {
          background: white;
          border-radius: 12px;
          padding: 30px;
          box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
          transition: transform 0.2s, box-shadow 0.2s;
        }

        .card:hover {
          transform: translateY(-4px);
          box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
        }

        .card h2 {
          font-size: 22px;
          color: #1a202c;
          margin-bottom: 20px;
          padding-bottom: 10px;
          border-bottom: 3px solid #4299e1;
        }

        .score-display {
          text-align: center;
          padding: 40px;
        }

        .score-circle {
          width: 200px;
          height: 200px;
          margin: 0 auto;
          border-radius: 50%;
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 64px;
          font-weight: bold;
          color: white;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }

        #network-graph {
          width: 100%;
          height: 600px;
          border: 2px solid #e2e8f0;
          border-radius: 8px;
          background: #ffffff;
        }

        .info-grid {
          display: grid;
          grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
          gap: 15px;
          margin-top: 20px;
        }

        .info-item {
          background: #f7fafc;
          padding: 15px;
          border-radius: 8px;
          border-left: 4px solid #4299e1;
        }

        .info-item strong {
          display: block;
          color: #2d3748;
          font-size: 12px;
          text-transform: uppercase;
          letter-spacing: 0.5px;
          margin-bottom: 5px;
        }

        .info-item span {
          font-size: 16px;
          color: #1a202c;
        }

        .list-group {
          list-style: none;
          margin-top: 15px;
        }

        .list-group li {
          background: #f7fafc;
          padding: 12px 15px;
          margin-bottom: 8px;
          border-radius: 6px;
          border-left: 4px solid #ed8936;
        }

        .red-flag {
          border-left-color: #f56565;
        }

        .opportunity {
          border-left-color: #48bb78;
        }

        table {
          width: 100%;
          border-collapse: collapse;
          margin-top: 15px;
        }

        th {
          background: #2d3748;
          color: white;
          padding: 12px;
          text-align: left;
          font-weight: 600;
        }

        td {
          padding: 10px 12px;
          border-bottom: 1px solid #e2e8f0;
        }

        tr:hover {
          background: #f7fafc;
        }

        .footer {
          text-align: center;
          padding: 30px;
          color: #718096;
          font-size: 14px;
        }
      </style>
    </head>
    <body>
      <div class="header">
        <h1>ğŸ” RelatÃ³rio de Asset Intelligence</h1>
        <div class="subtitle">${duckdbResult.empresa_alvo.razao_social!"Empresa NÃ£o Encontrada"}</div>
        <div class="subtitle" style="font-size: 14px; opacity: 0.7;">CNPJ: ${duckdbResult.cnpj_consultado!"N/A"}</div>
        <span class="risk-badge risk-${llmAnalysis.nivel_risco!"MÃ‰DIO"}">
          Risco: ${llmAnalysis.nivel_risco!"N/A"}
        </span>
      </div>

      <div class="container">
        <!-- Resumo Executivo -->
        <div class="card">
          <h2>ğŸ“‹ Resumo Executivo</h2>
          <p style="font-size: 16px; line-height: 1.8;">${llmAnalysis.resumo_executivo!"AnÃ¡lise nÃ£o disponÃ­vel"}</p>
        </div>

        <!-- Grid: Score + InformaÃ§Ãµes -->
        <div class="grid-2">
          <div class="card">
            <h2>ğŸ“Š Score de Risco</h2>
            <div class="score-display">
              <div class="score-circle">
                ${llmAnalysis.risco_score!0}
              </div>
              <p style="margin-top: 20px; font-size: 18px; color: #718096;">
                <strong>${llmAnalysis.nivel_risco!"N/A"}</strong>
              </p>
            </div>
          </div>

          <div class="card">
            <h2>ğŸ¢ InformaÃ§Ãµes da Empresa</h2>
            <div class="info-grid">
              <div class="info-item">
                <strong>RazÃ£o Social</strong>
                <span>${duckdbResult.empresa_alvo.razao_social!"N/A"}</span>
              </div>
              <div class="info-item">
                <strong>Nome Fantasia</strong>
                <span>${duckdbResult.empresa_alvo.nome_fantasia!"N/A"}</span>
              </div>
              <div class="info-item">
                <strong>UF</strong>
                <span>${duckdbResult.empresa_alvo.uf!"N/A"}</span>
              </div>
              <div class="info-item">
                <strong>MunicÃ­pio</strong>
                <span>${duckdbResult.empresa_alvo.municipio!"N/A"}</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Grafo de Relacionamentos -->
        <div class="card">
          <h2>ğŸŒ Grafo de Relacionamentos (Interativo)</h2>
          <p style="color: #718096; margin-bottom: 15px;">Arraste os nÃ³s, dÃª zoom com a roda do mouse, clique para ver detalhes</p>
          <div id="network-graph"></div>
        </div>

        <!-- Red Flags e Oportunidades -->
        <div class="grid-2">
          <div class="card">
            <h2>ğŸš© Red Flags Identificados</h2>
            <ul class="list-group">
              <#if llmAnalysis.red_flags?? && llmAnalysis.red_flags?size gt 0>
                <#list llmAnalysis.red_flags as flag>
                <li class="red-flag">${flag}</li>
                </#list>
              <#else>
                <li>Nenhum red flag crÃ­tico identificado</li>
              </#if>
            </ul>
          </div>

          <div class="card">
            <h2>âœ… Oportunidades</h2>
            <ul class="list-group">
              <#if llmAnalysis.oportunidades?? && llmAnalysis.oportunidades?size gt 0>
                <#list llmAnalysis.oportunidades as opp>
                <li class="opportunity">${opp}</li>
                </#list>
              <#else>
                <li>AnÃ¡lise de oportunidades nÃ£o disponÃ­vel</li>
              </#if>
            </ul>
          </div>
        </div>

        <!-- Principais SÃ³cios -->
        <div class="card">
          <h2>ğŸ‘¥ Principais SÃ³cios</h2>
          <table>
            <thead>
              <tr>
                <th>Nome</th>
                <th>CPF/CNPJ</th>
                <th>QualificaÃ§Ã£o</th>
                <th>RelevÃ¢ncia</th>
                <th>Justificativa</th>
              </tr>
            </thead>
            <tbody>
              <#if llmAnalysis.principais_socios?? && llmAnalysis.principais_socios?size gt 0>
                <#list llmAnalysis.principais_socios as socio>
                <tr>
                  <td><strong>${socio.nome}</strong></td>
                  <td>${socio.cpf_cnpj}</td>
                  <td>${socio.qualificacao}</td>
                  <td><span style="color: ${socio.relevancia == 'ALTA' ? '#48bb78' : (socio.relevancia == 'MÃ‰DIA' ? '#ed8936' : '#718096')}; font-weight: bold;">${socio.relevancia}</span></td>
                  <td>${socio.justificativa}</td>
                </tr>
                </#list>
              <#else>
                <tr><td colspan="5" style="text-align: center; color: #718096;">Nenhum sÃ³cio identificado</td></tr>
              </#if>
            </tbody>
          </table>
        </div>

        <!-- Empresas Relacionadas -->
        <div class="card">
          <h2>ğŸ­ Empresas Relacionadas (Top ${duckdbResult.total_relacionadas!0})</h2>
          <table>
            <thead>
              <tr>
                <th>CNPJ</th>
                <th>RazÃ£o Social</th>
                <th>UF</th>
                <th>Score</th>
              </tr>
            </thead>
            <tbody>
              <#if duckdbResult.empresas_relacionadas?? && duckdbResult.empresas_relacionadas?size gt 0>
                <#list duckdbResult.empresas_relacionadas as emp>
                <tr>
                  <td>${emp.cnpj_basico!"N/A"}</td>
                  <td><strong>${emp.razao_social!"N/A"}</strong><br/><small style="color: #718096;">${emp.nome_fantasia!"---"}</small></td>
                  <td>${emp.uf!"N/A"}</td>
                  <td><strong>${emp.relevance_score!0}</strong></td>
                </tr>
                </#list>
              <#else>
                <tr><td colspan="4" style="text-align: center; color: #718096;">Nenhuma empresa relacionada encontrada</td></tr>
              </#if>
            </tbody>
          </table>
        </div>

        <!-- RecomendaÃ§Ãµes -->
        <div class="card">
          <h2>ğŸ’¡ RecomendaÃ§Ãµes para Due Diligence</h2>
          <ul class="list-group">
            <#if llmAnalysis.recomendacoes?? && llmAnalysis.recomendacoes?size gt 0>
              <#list llmAnalysis.recomendacoes as rec>
              <li>${rec}</li>
              </#list>
            <#else>
              <li>Nenhuma recomendaÃ§Ã£o especÃ­fica</li>
            </#if>
          </ul>
        </div>
      </div>

      <div class="footer">
        <p><strong>Orchestra-AI</strong> â€¢ Asset Intelligence Platform</p>
        <p>Gerado em ${.now?string["dd/MM/yyyy 'Ã s' HH:mm:ss"]}</p>
      </div>

      <script>
        // ========================================
        // VIS.JS NETWORK GRAPH
        // ========================================
        const nodes = new vis.DataSet([
          // NÃ³ central: Empresa Alvo
          {
            id: 0,
            label: '${duckdbResult.empresa_alvo.razao_social?js_string!"Empresa Alvo"}',
            color: {background: '#667eea', border: '#4c51bf'},
            size: 40,
            font: {size: 16, color: '#fff', face: 'Inter'},
            borderWidth: 3,
            title: 'CNPJ: ${duckdbResult.cnpj_consultado?js_string} | Risco: ${llmAnalysis.nivel_risco?js_string}'
          },
          // NÃ³s de SÃ³cios
          <#if llmAnalysis.principais_socios?? && llmAnalysis.principais_socios?size gt 0>
          <#list llmAnalysis.principais_socios as socio>
          {
            id: 's${socio_index}',
            label: '${socio.nome?js_string}',
            color: {background: '#ed8936', border: '#c05621'},
            size: 25,
            shape: 'diamond',
            font: {size: 12, color: '#fff'},
            title: 'SÃ³cio | RelevÃ¢ncia: ${socio.relevancia?js_string}'
          }<#if socio_has_next>,</#if>
          </#list>
          <#if duckdbResult.empresas_relacionadas?? && duckdbResult.empresas_relacionadas?size gt 0>,</#if>
          </#if>
          // NÃ³s de Empresas Relacionadas (Top 10 para nÃ£o poluir o grafo)
          <#if duckdbResult.empresas_relacionadas?? && duckdbResult.empresas_relacionadas?size gt 0>
          <#list duckdbResult.empresas_relacionadas[0..9] as emp>
          {
            id: 'e${emp_index}',
            label: '${(emp.nome_fantasia!"${emp.razao_social}")?js_string}',
            color: {background: '#48bb78', border: '#2f855a'},
            size: 20,
            font: {size: 10, color: '#fff'},
            title: 'CNPJ: ${emp.cnpj_basico?js_string} | Score: ${emp.relevance_score!0}'
          }<#if emp_has_next>,</#if>
          </#list>
          </#if>
        ]);

        const edges = new vis.DataSet([
          // Arestas: SÃ³cios -> Empresa Alvo
          <#if llmAnalysis.principais_socios?? && llmAnalysis.principais_socios?size gt 0>
          <#list llmAnalysis.principais_socios as socio>
          {from: 's${socio_index}', to: 0, arrows: 'to', color: {color: '#ed8936'}, width: 2, label: 'sÃ³cio'}<#if socio_has_next>,</#if>
          </#list>
          <#if duckdbResult.empresas_relacionadas?? && duckdbResult.empresas_relacionadas?size gt 0>,</#if>
          </#if>
          // Arestas: Empresa Alvo -> Empresas Relacionadas
          <#if duckdbResult.empresas_relacionadas?? && duckdbResult.empresas_relacionadas?size gt 0>
          <#list duckdbResult.empresas_relacionadas[0..9] as emp>
          {from: 0, to: 'e${emp_index}', arrows: 'to', color: {color: '#48bb78'}, width: 1, dashes: true, label: 'relacionada'}<#if emp_has_next>,</#if>
          </#list>
          </#if>
        ]);

        const container = document.getElementById('network-graph');
        const data = { nodes: nodes, edges: edges };
        const options = {
          physics: {
            stabilization: {iterations: 200},
            barnesHut: {
              gravitationalConstant: -3000,
              centralGravity: 0.3,
              springLength: 150,
              springConstant: 0.04
            }
          },
          interaction: {
            hover: true,
            tooltipDelay: 100,
            zoomView: true,
            dragView: true
          },
          nodes: {
            borderWidth: 2,
            font: {
              strokeWidth: 3,
              strokeColor: '#fff'
            }
          }
        };

        const network = new vis.Network(container, data, options);

        // Evento de clique
        network.on('click', function(params) {
          if (params.nodes.length > 0) {
            const nodeId = params.nodes[0];
            const node = nodes.get(nodeId);
            alert('Selecionado: ' + node.label + '\n\n' + (node.title || 'Sem informaÃ§Ãµes adicionais'));
          }
        });
      </script>
    </body>
    </html>

scripts:
  duckdbQueryOptimized: "duckdbQueryOptimized.py"
