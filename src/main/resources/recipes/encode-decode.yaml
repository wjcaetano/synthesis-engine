config:
  fresh: true
  options:
    - name: fromFile
      type: BOOLEAN
      label: "Input from file?"
      defaultValue: false
    - name: input
      type: FILE
      subType: LIST
      label: "File with Content to Translate"
    - name: text
      type: TEXT
      label: "Text to translate"
    - name: pass
      type: TEXT
      label: "Passphrase"
    - name: direction
      type: DROPDOWN
      label: "Encode or Decode?"
      defaultValue: ENCODE
      values:
        - label: ENCODE
          value: ENCODE
        - label: DECODE
          value: DECODE
executor: ProjectModelExecutor3.java
projectModel:
  output.txt: |-
    @@@script("EncodeDecode")
scripts:
  EncodeDecode:
    name: EncodeDecode
    reference: EncodeDecode.groovy
    type: GROOVY
    inject:
      pass: ${#$api['configs']['options']['pass']}
      text: ${#$api['configs']['options']['text']}
      direction: ${#$api['configs']['options']['direction']}
    extract: null
    #body: "${@Utils.decodeBase64ToString(#$api['files']['EncodeDecode.groovy'])}"
    body: |-
      import com.capco.brsp.synthesisengine.service.IExecutor
      import com.capco.brsp.synthesisengine.service.ScriptService2
      import com.capco.brsp.synthesisengine.service.SuperService2
      import com.capco.brsp.synthesisengine.utils.*
      import org.springframework.context.ApplicationContext

      class EncodeDecode implements IExecutor {
          SuperService2 superService = null
          ScriptService2 scriptService = null
          SuperUtils superUtils = SuperUtils.getInstance()

          Object execute(ApplicationContext applicationContext, Map<String, Object> projectContext) {
              this.superService = applicationContext.getBean(SuperService2.class)
              this.scriptService = applicationContext.getBean(ScriptService2.class)

              def text = projectContext['$api'].configs.options.fromFile ? Utils.decodeBase64ToString(projectContext['$api'].configs.options.input as String) : projectContext['$api'].configs.options.text as String
              def pass = projectContext['$api'].configs.options.pass as String
              def direction = projectContext['$api'].configs.options.direction as String

              def key = pass.getBytes('UTF-8')

              def xorBytes = { byte[] inb ->
                  byte[] out = new byte[inb.length]
                  for (int i = 0; i < inb.length; i++) {
                      out[i] = (byte) (inb[i] ^ key[i % key.length])
                  }
                  out
              }

              if (direction == "ENCODE") {
                  byte[] obf = xorBytes(text.getBytes('UTF-8'))
                  return obf.encodeBase64().toString()
              } else { // "DECODE"
                  byte[] obf = text.decodeBase64()       // 'text' holds the Base64 input
                  byte[] plain = xorBytes(obf)
                  return new String(plain, 'UTF-8')
              }
          }
      }