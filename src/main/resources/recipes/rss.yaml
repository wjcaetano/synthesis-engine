config:
  fresh: true
  options:
    - name: links
      type: TEXT
      label: "Links (separated by |)"
      defaultValue: ""
executor: ProjectModelExecutor.java
executorEvents: null
projectsReference: "${#$api['configs']['options']['links'].split('\\|').![{'name': (#parts = #this.split('/'))[#parts.length - 1], 'link': #this}]}"
projectsPrepare: null
projectPrepare: null
projectModel:
  fetchRss.xml: "${#recipe['templates']['fetchRss']}"
  final.json: "${#recipe['templates']['enrichRss']}"
  channelOverview.txt: "${#recipe['templates']['summarizeForChannel']}"
projectSuperModel:
  overview.txt: "${#recipe['templates']['summarizeForOverview']}"
  full.html: "${#recipe['templates']['full']}"
templates:
  jolt: |-
    [
      {
        "operation": "shift",
        "spec": {
          "channel": {
            "title|description|lastBuildDate|language": "channel.&0",
            "link": {
              "*": {
                "_href": "channel.link"
              }
            },
            "updateFrequency|updatePeriod": {
              "__prefix": "channel.&1.period",
              "__text": "channel.&1.text"
            },
            "item": {
              "*": {
                "title|description|link|pubDate|category": "item[&1].&0",
                "creator": {
                  "__cdata": "item[&2].author"
                }
              }
            }
          }
        }
      },
      {
        "operation": "cardinality",
        "spec": {
          "item": {
            "*": {
              "category": "MANY"
            }
          }
        }
      },
      {
        "operation": "com.capco.brsp.synthesisengine.tools.CustomJoltModifier$Overwritr",
        "spec": {
          "channel": {
            "timestamp": "=timestampToDateString(@(1,lastBuildDate))"
          },
          "item": {
            "*": {
              "timestamp": "=timestampToDateString(@(1,pubDate))"
            }
          }
        }
      }
    ]
  fetchRss: |-
    @@@api("${#project['link']}", "GET", null, null)
    @@@objectify(null, "project.rssXml")
    @@@spel("${@JsonUtils.writeAsJsonString(#project['rssXml'], true)}")
    @@@jolt("${#recipe['templates']['jolt']}")
    @@@objectify(null, "project.rssJson")
    @@@spel("${@JsonUtils.writeAsJsonString(#project['rssJson']['item'].?[#this['timestamp'] >= 1750957200000L], true)}")
    @@@objectify(null, "project.rssJson.item")
  enrichRss: |-
    @@@repeat("${#project['rssJson']['item']}", "repeatItem", "${#recipe['templates']['fetchItem']}")
    @@@spel("${@JsonUtils.writeAsJsonString(#project['rssJson'], true)}")@set:fullJsonString
  fetchItem: |-
    @@@api("${#repeatItem['link']}", "GET", null, null)
    @@@extract("REGEX_HTML")
    @@@extract("ANY_TO_MARKDOWN")@set:repeatItem.content
    @@@exec("${#recipe['templates']['itemSummary']}")@set:repeatItem.summary
  itemSummary: |-
    @@@default("${#repeatItem.description}")
    @@@freemarker
    @@@retry(3)
    @@@log("${'Trying to summarize the item: ' + #repeatItem['title']}")
    @@@prompt
    Summarize the content below using up to 50 words! This is aiming a CEO persona, so you should adapt the language to that level as well!
    
    ${repeatItem.content}
  summarizeForChannel: |-
    @@@default("Failed!")
    @@@freemarker
    @@@retry(3)
    @@@prompt@set:project.overviewSummary
    Summarize the content below using up to 500 words! This is aiming a CEO persona, so you should adapt the language to that level as well!
    
    <#list project.rssJson.item as item>
    Item:  ${item.title}
    Summary:  ${item.summary}
    ----
    </#list>
  summarizeForOverview: |-
    @@@default("Failed!")
    @@@freemarker
    @@@retry(3)
    @@@prompt@set:overviewSummary
    Summarize the content below using up to 150 words! This is aiming a CEO persona, so you should adapt the language to that level as well!
    
    <#list projects as prj>
    Channel:  ${prj.rssJson.channel.title}
    Summary:  ${prj.overviewSummary}
    ----
    </#list>
  full: |-
    @@@freemarker
    <!DOCTYPE html>
    <html lang="en">
    <head>
      <meta charset="UTF-8" />
      <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
      <title>RSS Aggregator - Overview</title>
      <style>
        body {
          margin: 0;
          font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
          background-color: #f4f6f9;
        }

        .sidebar {
          position: fixed;
          top: 0;
          left: 0;
          width: 220px;
          height: 100%;
          background-color: #1a1a1a;
          padding-top: 20px;
          box-shadow: 2px 0 5px rgba(0,0,0,0.1);
        }

        .sidebar h2 {
          color: white;
          text-align: center;
          font-size: 1.2rem;
          margin-bottom: 1rem;
        }

        .sidebar a {
          display: block;
          padding: 12px 20px;
          text-decoration: none;
          color: #fff;
          transition: background-color 0.2s;
        }

        .sidebar a:hover {
          background-color: #333;
        }

        main {
          margin-left: 240px;
          padding: 30px 40px;
        }

        section {
          margin-bottom: 50px;
        }

        h1, h2 {
          color: #222;
        }

        .channel-summary {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
          gap: 20px;
          margin-top: 20px;
        }

        .summary-box {
          background: #fff;
          padding: 20px;
          border-radius: 10px;
          box-shadow: 0 3px 6px rgba(0,0,0,0.1);
        }

        .summary-box h3 {
          margin-top: 0;
          color: #007acc;
        }

        .summary-box ul {
          padding-left: 20px;
          margin: 10px 0 0 0;
        }

        .card-grid {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
          gap: 20px;
        }

        .card {
          background-color: white;
          border-radius: 10px;
          padding: 20px;
          box-shadow: 0 3px 6px rgba(0,0,0,0.1);
          display: flex;
          flex-direction: column;
        }

        .card h3 {
          margin-top: 0;
        }

        .card p {
          flex-grow: 1;
        }

        .card a {
          text-decoration: none;
          color: #007acc;
          font-weight: bold;
        }

        .category {
          display: inline-block;
          background-color: #e1ecf4;
          color: #39739d;
          font-size: 0.75rem;
          padding: 4px 8px;
          border-radius: 6px;
          margin-right: 6px;
          margin-top: 10px;
        }

        footer {
          text-align: center;
          font-size: 0.9rem;
          color: #aaa;
          padding: 20px;
        }

      </style>
    </head>
    <body>

      <nav class="sidebar">
        <h2>Feeds</h2>
        <a href="#overview">Overview</a>
        <#list projects as prj>
        <a href="#${prj.rssJson.channel.title?lower_case?replace("[^a-z0-9]", "-", "r")}">${prj.rssJson.channel.title}</a>
        </#list>
      </nav>

      <main>
        <section id="overview">
          <h1>Overview</h1>
          ${overviewSummary}
          <p>This dashboard aggregates the latest articles from selected RSS. Below is a quick snapshot of new content across all sources.</p>

          <div class="channel-summary">
            <#list projects as prj>
            <div class="summary-box">
              <h3>${prj.rssJson.channel.title}</h3>
              <p>${prj.overviewSummary}</p>
            </div>
            </#list>
          </div>
        </section>
        <#list projects as prj>
        <section id="${prj.rssJson.channel.title}">
          <h2>${prj.rssJson.channel.title}</h2>
          <div class="card-grid">
            <#list prj.rssJson.item as item>
            <div class="card">
              <h3>${item.title}</h3>
              <p>${item.summary}</p>
              <a href="${item.link}" target="_blank">Read More</a>
              <div>
                <#list item.category as category>
                <span class="category">${category}</span>
                </#list>
              </div>
            </div>
            </#list>
          </div>
        </section>
        </#list>

      </main>

      <footer>
        &copy; 2025 Synthesis Engine RSS Aggregator Dashboard. All rights reserved.
      </footer>

    </body>
    </html>

