config:
  fresh: true
  transformDefaultParams:
    jolt:
      - "${#recipe['jolts']['joltNeo4jTableToJson']}"
    neo4j:
      - "http://localhost:7474/db/neo4j/tx/commit"
      - "${@Utils.createBasicAuthHeader('neo4j', 'select-shirt-judge-miguel-antonio-46')}"
    api:
      - "https://ilabs-capco.atlassian.net/rest/api/3/search/jql"
      - "POST"
      - "${#content}"
      - "${#jiraHeaders}"
      - "${#paginationConfig}"
  options:
    - name: clearDatabase
      type: BOOLEAN
      label: "Clear 'JiraReports' Nodes in database before anything?"
      defaultValue: false

    - name: jiraProjectKey
      type: TEXT
      label: "Jira Project Key"
      defaultValue: "LMT"

    - name: daysBack
      type: TEXT
      label: "Days to Analyze"
      defaultValue: 14

    - name: epicFilter
      type: TEXT
      label: "Epic Key Filter (optional)"
      defaultValue: ""

    - name: assigneeFilter
      type: TEXT
      label: "Assignee Filter (optional)"
      defaultValue: ""

    - name: maxPages
      type: TEXT
      label: "Max Pages to Fetch"
      defaultValue: 50

    - name: pageSize
      type: TEXT
      label: "Items Per Page"
      defaultValue: 50

    - name: chunkSize
      type: TEXT
      label: "Issues per Chunk (for LLM processing)"
      defaultValue: 10

    - name: enableLLMEnrichment
      type: BOOLEAN
      label: "Enable LLM Enrichment (classification, entities, etc.)?"
      defaultValue: true

    - name: enableAdvancedAnalysis
      type: BOOLEAN
      label: "Enable Advanced LLM Analysis (patterns, dependencies)?"
      defaultValue: true

  agents:
    - name: KNOWLEDGE_GRAPH_EXTRACTOR
      provider: azure
      model: gpt-4o
      deploymentName: Chatbot
      temperature: 0.1
      maxTurns: 1

    - name: EXECUTIVE_SUMMARY_AGENT
      provider: azure
      model: gpt-4o
      deploymentName: Chatbot
      temperature: 0.3
      maxTurns: 1

    - name: USER_REPORT_AGENT
      provider: azure
      model: gpt-4o-mini
      deploymentName: Chatbot
      temperature: 0.5
      maxTurns: 1

    - name: EPIC_REPORT_AGENT
      provider: azure
      model: gpt-4o-mini
      deploymentName: Chatbot
      temperature: 0.5
      maxTurns: 1

caches:
  transforms:
    - prompt
    - agent
    - neo4j
    - jolt

scripts:
  deduplicateKnowledgeGraph:
    reference: DeduplicateKnowledgeGraph.groovy
    name: deduplicateKnowledgeGraph
    type: GROOVY
    body: |-
      import com.capco.brsp.synthesisengine.service.IExecutor
      import org.springframework.context.ApplicationContext
      import com.capco.brsp.synthesisengine.utils.*
      
      class DeduplicateKnowledgeGraph implements IExecutor {
          @Override
          Object execute(ApplicationContext applicationContext, Map<String, Object> projectContext) {
              def accumulatedKG = projectContext.accumulatedKnowledgeGraph
      
              // Deduplicate nodes by id
              def nodesById = [:]
              accumulatedKG.nodes.each { node ->
                  if (!nodesById.containsKey(node.id)) {
                      nodesById[node.id] = node
                  }
              }
      
              // Deduplicate relationships by source+target+type
              def relationshipsSet = [] as Set
              def uniqueRelationships = []
              accumulatedKG.relationships.each { rel ->
                  def key = "${rel.source}|${rel.target}|${rel.type}"
                  if (!relationshipsSet.contains(key)) {
                      relationshipsSet.add(key)
                      uniqueRelationships.add(rel)
                  }
              }
      
              return [
                  nodes: nodesById.values() as List,
                  relationships: uniqueRelationships
              ]
          }
      }
executor: ProjectModelExecutor3.java

projectModel:
  _clearDatabase: ${#recipe['templates']['clearDatabase']}
  temp:
    jiraHeaders.json: ${#recipe['templates']['jiraHeaders']}
    paginationConfig.json: ${#recipe['templates']['jiraPaginationConfig']}
    jqlBuild.json: ${#recipe['templates']['jqlBuild']}
  collectAndEnrichData:
    collectJiraData.json: "${#recipe['templates']['collectJiraIssues']}"
    enrichChangelogs.json: "${#recipe['templates']['enrichChangelogData']}"
  knowledgeGraphExtraction:
    prepareChunks.json: "${#recipe['templates']['prepareChunks']}"
    extractKnowledgeGraphChunked.json: "${#recipe['templates']['extractKnowledgeGraphChunked']}"
    mergeKnowledgeGraph.json: "${#recipe['templates']['mergeKnowledgeGraph']}"
  neo4jPersistence:
    persistGraph.json: "${#recipe['templates']['persistKnowledgeGraph']}"
  analytics:
    analytics.json: "${#recipe['templates']['runAnalytics']}"
  generateReports:
    reports/index.html: "${#recipe['templates']['generateIndexReport']}"
    reports/executive-summary.html: "${#recipe['templates']['generateExecutiveSummary']}"
    reports/users: "${#allUsers != null && !#allUsers.isEmpty() ? @Utils.createWithAListOfKeys(T(java.util.stream.IntStream).range(0, #allUsers.size()).boxed().collect(T(java.util.stream.Collectors).toList()).![T(java.lang.String).format('user_%04d.html', #this)], #recipe['templates']['generateUserReport']) : {}}"
    reports/epics: "${#allEpics != null && !#allEpics.isEmpty() ? @Utils.createWithAListOfKeys(T(java.util.stream.IntStream).range(0, #allEpics.size()).boxed().collect(T(java.util.stream.Collectors).toList()).![T(java.lang.String).format('epic_%04d.html', #this)], #recipe['templates']['generateEpicReport']) : {}}"
    reports/issues.html: "${#recipe['templates']['generateIssuesReport']}"

models:
  JiraUser:
    "": "${#userToSave}"
    labels: ["User", "JiraReport"]
    key: "${#self['accountId'] ?: 'unknown-user'}"
    name: "${#self['name'] ?: 'Unknown'}"
    email: "${#self['email'] ?: ''}"
    relationships: "${#self['relationships']}"

  JiraEpic:
    "": "${#epicToSave}"
    labels: ["Epic", "JiraReport"]
    key: "${#self['key'] ?: 'unknown-epic'}"
    name: "${#self['name'] ?: 'Unknown'}"
    summary: "${#self['summary'] ?: ''}"
    status: "${#self['status'] ?: 'Unknown'}"
    relationships: "${#self['relationships']}"

  JiraIssue:
    "": "${#issueToSave}"
    labels: ["Issue", "JiraReport"]
    key: "${#self['issueKey'] ?: 'unknown-issue'}"
    issueId: "${#self['issueId'] ?: ''}"
    summary: "${#self['summary'] ?: 'No summary'}"
    description: "${#self['description'] ?: ''}"
    status: "${#self['status'] ?: ''}"
    type: "${#self['issueType'] ?: ''}"
    priority: "${#self['priority'] ?: ''}"
    assigneeName: "${#self['assigneeName'] ?: ''}"
    assigneeEmail: "${#self['assigneeEmail'] ?: ''}"
    reporterName: "${#self['reporterName'] ?: ''}"
    createdDate: "${#self['createdDate'] ?: ''}"
    updatedDate: "${#self['updatedDate'] ?: ''}"
    storyPoints: "${#self['storyPoints'] ?: 0}"
    llmTechnicalArea: "${#self['llmTechnicalArea'] ?: ''}"
    llmComplexity: "${#self['llmComplexity'] ?: ''}"
    llmBusinessImpact: "${#self['llmBusinessImpact'] ?: ''}"
    relationships: "${#self['relationships']}"

jolts:
  joltNeo4jTableToJson: |-
    [
      {
        "operation": "shift",
        "spec": {
          "results": {
            "*": {
              "data": {
                "*": {
                  "row": {
                    "*": "[&2].@(4,columns[&0])"
                  }
                }
              }
            }
          }
        }
      }
    ]

  joltJiraToNormalized: |-
    [
      {
        "operation": "shift",
        "spec": {
          "*": {
            "id": "[&1].issueId",
            "key": "[&1].issueKey",
            "self": "[&1].issueUrl",
            "fields": {
              "summary": "[&2].summary",
              "issuetype": {
                "name": "[&2].issueType"
              },
              "status": {
                "name": "[&2].status",
                "statusCategory": {
                  "name": "[&2].statusCategory"
                }
              },
              "priority": {
                "name": "[&2].priority"
              },
              "created": "[&2].createdDate",
              "updated": "[&2].updatedDate",
              "duedate": "[&2].dueDate",
              "resolutiondate": "[&2].resolvedDate",
              "reporter": {
                "displayName": "[&3].reporter.name",
                "emailAddress": "[&3].reporter.email",
                "accountId": "[&3].reporter.accountId"
              },
              "assignee": {
                "displayName": "[&3].assignee.name",
                "emailAddress": "[&3].assignee.email",
                "accountId": "[&3].assignee.accountId"
              },
              "parent": {
                "key": "[&2].parent.key",
                "fields": {
                  "summary": "[&3].parent.summary",
                  "status": {
                    "name": "[&4].parent.status"
                  },
                  "priority": {
                    "name": "[&4].parent.priority"
                  },
                  "issuetype": {
                    "name": "[&4].parent.issueType"
                  }
                }
              },
              "customfield_10014": "[&2].epicLinkField",
              "customfield_10016": "[&2].storyPoints",
              "customfield_12572": "[&2].contributors",
              "description": {
                "content": {
                  "*": {
                    "content": {
                      "*": {
                        "text": "[&5].description[]"
                      }
                    }
                  }
                }
              }
            },
            "changelog": {
              "histories": {
                "*": {
                  "created": "[&4].changeHistory[&1].date",
                  "author": {
                    "displayName": "[&5].changeHistory[&2].author"
                  },
                  "items": {
                    "*": {
                      "field": "[&6].changeHistory[&3].changes[&2].field",
                      "fromString": "[&6].changeHistory[&3].changes[&2].oldValue",
                      "toString": "[&6].changeHistory[&3].changes[&2].newValue"
                    }
                  }
                }
              }
            }
          }
        }
      },
      {
        "operation": "default",
        "spec": {
          "*": {
            "description": [],
            "storyPoints": "0",
            "dueDate": null,
            "resolvedDate": null,
            "assignee": {
              "name": "Unassigned",
              "email": "",
              "accountId": "unassigned"
            },
            "reporter": {
              "name": "Unknown",
              "email": "",
              "accountId": "unknown"
            },
            "parent": null,
            "epicLinkField": null
          }
        }
      },
      {
        "operation": "modify-overwrite-beta",
        "spec": {
          "*": {
            "description": "=join(' ', @(1,description))",
            "storyPoints": "=toInteger(@(1,storyPoints))"
          }
        }
      }
    ]

  joltEnrichChangelog: |-
    [
      {
        "operation": "shift",
        "spec": {
          "*": {
            "@": "[&1]",
            "changeHistory": {
              "*": {
                "changes": {
                  "*": {
                    "field": {
                      "status": {
                        "@(3,date)": "[&6].dailyStatusChanges[&3].date",
                        "@(2,oldValue)": "[&6].dailyStatusChanges[&3].from",
                        "@(2,newValue)": "[&6].dailyStatusChanges[&3].to",
                        "@(3,author)": "[&6].dailyStatusChanges[&3].author"
                      }
                    }
                  }
                }
              }
            }
          }
        }
      },
      {
        "operation": "shift",
        "spec": {
          "*": {
            "*": "[&1].&",
            "dailyStatusChanges": {
              "*": "[&3].dailyStatusChanges[&1]"
            }
          }
        }
      }
    ]
templates:
  clearDatabase: |-
    @@@log("#00FF00Clearing Neo4j database...")
    @@@neo4j
    @@@jsonify
    MATCH (n:JiraReport) DETACH DELETE n;

  jiraHeaders: |-
    @@@log("#00FF00Resolving Jira API headers...")
    @@@set("jiraAuthHeader", "${@Utils.getEnvVariable('JIRA_AUTH_HEADER')}")
    @@@freemarker
    @@@objectify
    @@@set("jiraHeaders")
    @@@jsonify
    {
      "Authorization": "${jiraAuthHeader}",
      "Content-Type": "application/json",
      "Accept": "application/json",
      "X-Atlassian-Token": "no-check"
    }

  jiraPaginationConfig: |-
    @@@log("#00FF00Setting up Jira pagination configuration...")
    @@@freemarker
    @@@objectify
    @@@set("paginationConfig")
    @@@jsonify
    {
      "type": "CURSOR",
      "nextTokenField": "nextPageToken",
      "isLastField": "isLast",
      "itemsPath": "$.issues",
      "pageSize": ${$api.configs.options.pageSize!50},
      "maxPages": ${$api.configs.options.maxPages!50},
      "rateLimitDelaysMs": 200
    }

  jqlBuild: |-
    @@@log("#00FF00Building JQL query...")
    @@@freemarker
    @@@set("jqlQueryParts")
    @@@spel("${#jqlQueryParts.trim()}")
    @@@set("jqlQuery")
    <#assign projectKey = $api.configs.options.jiraProjectKey!"LMT">
    <#assign daysBack = $api.configs.options.daysBack!14>
    <#assign parts = []>
    <#assign parts = parts + ["project = " + projectKey]>
    <#assign parts = parts + ["updated >= '-" + daysBack + "d'"]>
    <#if ($api.configs.options.epicFilter)?? && $api.configs.options.epicFilter?has_content>
    <#assign parts = parts + ["'Epic Link' = " + $api.configs.options.epicFilter]>
    </#if>
    <#if ($api.configs.options.assigneeFilter)?? && $api.configs.options.assigneeFilter?has_content>
    <#assign parts = parts + ["assignee = " + $api.configs.options.assigneeFilter]>
    </#if>
    ${parts?join(" AND ")} ORDER BY updated DESC 

  collectJiraIssues: |-
    @@@log("#FF00FF========================================")
    @@@log("#FF00FFPHASE 1: DATA COLLECTION")
    @@@log("#FF00FF========================================")
    @@@freemarker
    @@@objectify
    @@@api
    @@@set("rawApiResult")
    @@@log("${'Collected ' + #rawApiResult['totalItems'] + ' issues from Jira'}")
    @@@spel("${#rawApiResult['items']}")
    @@@jolt("${#recipe['jolts']['joltJiraToNormalized']}")
    @@@set("normalizedIssues")
    @@@jolt("${#recipe['jolts']['joltEnrichChangelog']}")
    @@@set("enrichedIssues")
    @@@log("${'Normalized and enriched ' + #enrichedIssues.size() + ' issues'}")
    @@@jsonify
    {
      "jql": "${jqlQuery}",
      "fields": [
        "summary",
        "description",
        "status",
        "assignee",
        "project",
        "reporter",
        "issuetype",
        "priority",
        "duedate",
        "resolutiondate",
        "parent",
        "timetracking",
        "issuelinks",
        "created",
        "updated",
        "comment",
        "customfield_10016",
        "customfield_10014"
      ],
      "expand": "names, changelog, renderedFields",
      "maxResults": ${$api.configs.options.pageSize!50}
    }
  
  
  
  
  

  prepareChunks: |-
    @@@log("#00FFFF========================================")
    @@@log("#00FFFFPHASE 2: CHUNKING STRATEGY")
    @@@log("#00FFFF========================================")
    @@@freemarker
    @@@objectify
    @@@set("chunkingConfig")
    @@@_exec("${#recipe['templates']['saveChunksToContext']}")
    @@@jsonify
    <#assign totalIssues = enrichedIssues?size>
    <#assign chunkSize = ($api.configs.options.chunkSize!10)?number>
    <#assign totalChunks = (totalIssues / chunkSize)?ceiling>
    {
      "totalIssues": ${totalIssues},
      "chunkSize": ${chunkSize},
      "totalChunks": ${totalChunks},
      "chunks": [
        <#list 0..<(totalChunks) as chunkIndex>
          <#assign endIndex = ((chunkIndex + 1) * chunkSize < totalIssues)?then((chunkIndex + 1) * chunkSize, totalIssues)>
        {
          "chunkIndex": ${chunkIndex},
          "startIndex": ${chunkIndex * chunkSize},
          "endIndex": ${endIndex},
          "size": ${endIndex - (chunkIndex * chunkSize)}
        }<#if chunkIndex < totalChunks - 1>,</#if>
          </#list>
      ]
    }
  saveChunksToContext: |-
    @@@get("chunkingConfig.chunks")
    @@@set("chunks")
    @@@get("chunkingConfig.totalChunks")
    @@@set("totalChunks")
    @@@log("${'Created ' + #totalChunks + ' chunks of ~' + #chunkingConfig['chunkSize'] + ' issues each'}")
  extractKnowledgeGraphChunked: |-
    @@@log("#00FFFF========================================")
    @@@log("#00FFFFPHASE 3: CHUNKED KNOWLEDGE GRAPH EXTRACTION")
    @@@log("#00FFFF========================================")
    @@@freemarker
    @@@objectify
    @@@set("accumulatedKnowledgeGraph")
    @@@get("chunks")
    @@@repeat("${#content}", "chunk", "${#recipe['templates']['processChunk']}")
    @@@log("${'Total accumulated - Nodes: ' + #accumulatedKnowledgeGraph['nodes'].size() + ', Relationships: ' + #accumulatedKnowledgeGraph['relationships'].size()}")
    @@@jsonify
    {"nodes": [], "relationships": []}
  prepareChunkIssues: |-
    @@@spel("${#enrichedIssues.subList(#chunk['startIndex'], #chunk['endIndex'])}")
    @@@set("chunkIssues")
    @@@get("chunkIssues")
    @@@jsonify
    @@@set("chunkIssuesJson")
    @@@log("${'Chunk ' + (#chunk['chunkIndex'] + 1) + ' contains ' + #chunkIssues.size() + ' issues (~' + (#chunkIssuesJson.length() / 1024) + ' KB)'}")
  processChunk: |-
    @@@spel("${#chunk['chunkIndex'] + 1}")
    @@@set("currentChunkNumber")
    @@@spel("${#chunk['size']}")
    @@@set("currentChunkSize")
    @@@get("totalChunks")
    @@@set("savedTotalChunks")
    @@@log("${'Processing chunk ' + #currentChunkNumber + '/' + #savedTotalChunks}")
    @@@_exec("${#recipe['templates']['prepareChunkIssues']}")
    @@@freemarker
    @@@closellmthread
    @@@agent("KNOWLEDGE_GRAPH_EXTRACTOR")
    @@@extractMarkdownCode
    @@@objectify
    @@@set("chunkKnowledgeGraph")
    @@@log("${'Chunk ' + #currentChunkNumber + ' extracted - Nodes: ' + #chunkKnowledgeGraph['nodes'].size() + ', Relationships: ' + #chunkKnowledgeGraph['relationships'].size()}")
    @@@_spel("${#accumulatedKnowledgeGraph['nodes'].addAll(#chunkKnowledgeGraph['nodes'])}")
    @@@_spel("${#accumulatedKnowledgeGraph['relationships'].addAll(#chunkKnowledgeGraph['relationships'])}")

    You are a Knowledge Graph extraction specialist for Jira data. Extract entities and relationships from the issues below.

    ## INPUT DATA (${currentChunkSize} issues)
    ```json
    ${chunkIssuesJson}
    ```

    ## YOUR TASK

    Extract a JSON knowledge graph with TWO arrays: `nodes` and `relationships`.

    ## NODES TO EXTRACT

    For EACH issue, extract these node types:
    
    ‚ö†Ô∏è **CRITICAL - Status Values**: When extracting status fields (for Issue, Epic, or StatusChange nodes), you MUST preserve the EXACT status value from the input data. DO NOT normalize, standardize, or change status values in any way. If input has "In Progress", use "In Progress" exactly. If "Open", use "Open". Preserve exact strings including spaces and capitalization.

    ### 1. User Nodes (from assignee, reporter, contributors)
    ```json
    {
      "id": "accountId",
      "type": "User",
      "properties": {
        "accountId": "user-123",
        "name": "John Doe",
        "email": "john@example.com",
        "evidence": "Assigned to John Doe"
      }
    }
    ```

    ### 2. Issue Nodes
    ```json
    {
      "id": "issueKey",
      "type": "Issue",
      "properties": {
        "key": "LMT-123",
        "summary": "Fix bug",
        "description": "Full description text",
        "status": "Open",  // ‚ö†Ô∏è CRITICAL: Use EXACT status from input - DO NOT normalize "In Progress" to "Open"!
        "priority": "Medium",
        "issueType": "Bug",
        "createdDate": "2025-01-01",
        "updatedDate": "2025-01-15",
        "storyPoints": 5,
        "evidence": "Fix bug"
      }
    }
    ```

    ### 3. Epic Nodes (ONLY if parent.issueType === "Epic")
    ```json
    {
      "id": "parent.key",
      "type": "Epic",
      "properties": {
        "key": "LMT-100",
        "name": "parent.summary",
        "status": "parent.status",  // ‚ö†Ô∏è Extract EXACT status - DO NOT normalize
        "priority": "parent.priority",
        "evidence": "Epic summary"
      }
    }
    ```

    ### 4. StatusChange Nodes (from dailyStatusChanges array)
    ```json
    {
      "id": "issueKey|date|from->to",
      "type": "StatusChange",
      "properties": {
        "issueKey": "LMT-123",
        "date": "2025-01-15",
        "from": "Open",  // ‚ö†Ô∏è Extract EXACT status - DO NOT normalize
        "to": "In Progress",  // ‚ö†Ô∏è Extract EXACT status - DO NOT normalize
        "author": "John Doe",
        "evidence": "Status changed from Open to In Progress on 2025-01-15 by John Doe"
      }
    }
    ```

    ## RELATIONSHIPS TO EXTRACT

    For EACH issue, create these relationships:

    1. **ASSIGNED_TO**: Issue ‚Üí User (assignee)
       - Skip if assignee.accountId === "unassigned"

    2. **REPORTED_BY**: Issue ‚Üí User (reporter)
       - Always create

    3. **BELONGS_TO_EPIC**: Issue ‚Üí Epic
       - Only if parent.issueType === "Epic"

    4. **CHANGED_STATUS**: Issue ‚Üí StatusChange
       - For each StatusChange node

    5. **PERFORMED_BY**: StatusChange ‚Üí User
       - Who performed the status change

    ## OUTPUT FORMAT

    Return ONLY this JSON structure (NO markdown, NO explanations, NO extra text):

    ```json
    {
      "nodes": [
        { "id": "...", "type": "...", "properties": {...} }
      ],
      "relationships": [
        { "source": "...", "target": "...", "type": "..." }
      ]
    }
    ```

    ## CRITICAL RULES

    1. ‚úÖ ALL nodes must have: id, type, properties
    2. ‚úÖ ALL properties must include "evidence" field
    3. ‚úÖ Use defaults: description="" if missing, priority="Medium", storyPoints=0
    4. ‚úÖ ‚ö†Ô∏è **CRITICAL**: ALL status fields (Issue.status, Epic.status, StatusChange.from, StatusChange.to) MUST be EXACT values from input - DO NOT change "In Progress" to "Open" or normalize in any way
    5. ‚úÖ Number of ASSIGNED_TO ‚âà ${currentChunkSize} (minus unassigned)
    6. ‚úÖ Number of REPORTED_BY === ${currentChunkSize}
    7. ‚ùå Return ONLY valid JSON
    8. ‚ùå NO markdown code blocks (```)
    9. ‚ùå NO explanations or comments
    10. ‚ùå NO text before or after the JSON

    ## EXTRACT NOW

    Return the JSON knowledge graph:

  mergeKnowledgeGraph: |-
    @@@log("#00FF00========================================")
    @@@log("#00FF00PHASE 4: MERGE & DEDUPLICATION")
    @@@log("#00FF00========================================")
    @@@script("deduplicateKnowledgeGraph")
    @@@set("knowledgeGraph")
    @@@jsonify

  persistKnowledgeGraph: |-
    @@@log("#00FF00========================================")
    @@@log("#00FF00PHASE 5: NEO4J PERSISTENCE")
    @@@log("#00FF00========================================")
    @@@_exec("${#recipe['templates']['persistNodes']}")
    @@@_exec("${#recipe['templates']['persistRelationships']}")
    @@@spel("${T(java.util.Map).of('graphPersisted', true)}")
    @@@jsonify
  persistNodes: |-
    @@@log("#00FF00Persisting nodes...")
    @@@get("knowledgeGraph.nodes")
    @@@repeat("${#content}", "node", "${#recipe['templates']['persistSingleNode']}")
    @@@log("${'Persisted ' + #knowledgeGraph['nodes'].size() + ' nodes'}")
    @@@jsonify
  persistSingleNode: |-
    @@@freemarker
    @@@neo4j
    @@@jsonify

    <#assign props = node.properties>
    MERGE (n:${node.type}:JiraReport {id: '${node.id}'})
    SET
      <#if node.type == "User">
      n.name = '${(props.name!'Unknown')?json_string}',
      n.email = '${(props.email!'')?json_string}',
      n.accountId = '${(props.accountId!node.id)?json_string}',
      n.evidence = '${(props.evidence!'')?json_string}'
      <#elseif node.type == "Epic">
      n.key = '${node.id}',
      n.name = '${(props.name!'Unknown Epic')?json_string}',
      n.status = '${(props.status!'Unknown')?json_string}',
      n.priority = '${(props.priority!'Medium')?json_string}',
      n.evidence = '${(props.evidence!'')?json_string}'
      <#elseif node.type == "Issue">
      n.key = '${node.id}',
      n.summary = '${(props.summary!'No summary')?json_string}',
      n.description = '${(props.description!'')?json_string}',
      n.status = '${(props.status!'Unknown')?json_string}',
      n.priority = '${(props.priority!'Medium')?json_string}',
      n.issueType = '${(props.issueType!'Task')?json_string}',
      n.createdDate = '${(props.createdDate!'')?json_string}',
      n.updatedDate = '${(props.updatedDate!'')?json_string}',
      n.storyPoints = ${props.storyPoints!0},
      n.evidence = '${(props.evidence!'')?json_string}'
      <#elseif node.type == "StatusChange">
      n.key = '${node.id}',
      n.issueKey = '${(props.issueKey!'')?json_string}',
      n.date = '${(props.date!'')?json_string}',
      n.from = '${(props.from!'Unknown')?json_string}',
      n.to = '${(props.to!'Unknown')?json_string}',
      n.author = '${(props.author!'Unknown')?json_string}',
      n.evidence = '${(props.evidence!'')?json_string}'
      <#elseif node.type == "Component">
      n.name = '${(props.name!node.id)?json_string}',
      n.evidence = '${(props.evidence!'')?json_string}'
      <#elseif node.type == "Concept">
      n.name = '${(props.name!node.id)?json_string}',
      n.evidence = '${(props.evidence!'')?json_string}'
      <#elseif node.type == "Technology">
      n.name = '${(props.name!node.id)?json_string}',
      n.evidence = '${(props.evidence!'')?json_string}'
      <#elseif node.type == "Label">
      n.name = '${(props.name!node.id)?json_string}',
      n.evidence = '${(props.evidence!'')?json_string}'
      <#else>
      n.name = '${node.id}',
      n.evidence = '${(props.evidence!'')?json_string}'
      </#if>
    RETURN n.id AS nodeIdnodeId
  persistRelationships: |-
    @@@log("#00FF00Persisting relationships...")
    @@@get("knowledgeGraph.relationships")
    @@@repeat("${#content}", "rel", "${#recipe['templates']['persistSingleRelationship']}")
    @@@log("${'Persisted ' + #knowledgeGraph['relationships'].size() + ' relationships'}")
    @@@jsonify

  persistSingleRelationship: |-
    @@@freemarker
    @@@neo4j
    @@@jsonify
    MATCH (source:JiraReport {id: '${rel.source}'})
    MATCH (target:JiraReport {id: '${rel.target}'})
    MERGE (source)-[r:${rel.type}]->(target)
    <#if rel.properties?? && rel.properties?has_content>
    SET
      <#list rel.properties?keys as key>
      r.${key} = '${rel.properties[key]?json_string}'<#if key?has_next>,</#if>
      </#list>
    </#if>
    RETURN type(r) AS relType
  runAnalytics: |-
    @@@log("#FF00FF========================================")
    @@@log("#FF00FFPHASE 6: ANALYTICS")
    @@@log("#FF00FF========================================")
    @@@_exec("${#recipe['templates']['queryAllUsers']}")
    @@@_exec("${#recipe['templates']['queryAllEpics']}")
    @@@_exec("${#recipe['templates']['queryAllIssues']}")
    @@@_exec("${#recipe['templates']['queryDailyChanges']}")
    @@@_exec("${#recipe['templates']['queryProjectStats']}")
    @@@spel("${T(java.util.Map).of('analyticsCompleted', true)}")
    @@@jsonify

  queryAllUsers: |-
    @@@log("#FF00FFQuerying all users...")
    @@@freemarker
    @@@neo4j
    @@@jolt("${#recipe['jolts']['joltNeo4jTableToJson']}")
    @@@set("allUsers")
    
    MATCH (u:User:JiraReport)
    WHERE u.accountId <> 'unassigned'
    OPTIONAL MATCH (u)<-[:ASSIGNED_TO]-(i:Issue:JiraReport)
    WITH u,
         count(DISTINCT i) AS totalIssues,
         count(DISTINCT CASE WHEN i.status IN ['Done', 'Closed', 'Resolved'] THEN i END) AS completed
    RETURN u.accountId AS userId,
           u.name AS userName,
           u.email AS userEmail,
           totalIssues,
           completed,
           CASE WHEN totalIssues > 0
                THEN round(100.0 * completed / totalIssues, 1)
                ELSE 0.0 END AS completionRate
    ORDER BY totalIssues DESC
  queryAllEpics: |-
    @@@log("#FF00FFQuerying all epics...")
    @@@freemarker
    @@@neo4j
    @@@jolt("${#recipe['jolts']['joltNeo4jTableToJson']}")
    @@@set("allEpics")
    
    OPTIONAL MATCH (e:Epic:JiraReport)
    OPTIONAL MATCH (e)<-[:BELONGS_TO_EPIC]-(i:Issue:JiraReport)
    WITH e,
         count(i) AS totalIssues,
         count(CASE WHEN i.status IN ['Done', 'Closed', 'Resolved'] THEN 1 END) AS completed
    WHERE e IS NOT NULL
    RETURN e.key AS epicKey,
           e.name AS epicName,
           e.status AS epicStatus,
           totalIssues,
           completed,
           CASE WHEN totalIssues > 0
                THEN round(100.0 * completed / totalIssues, 1)
                ELSE 0.0 END AS progress
    ORDER BY totalIssues DESC

  queryAllIssues: |-
    @@@log("#FF00FFQuerying all issues...")
    @@@freemarker
    @@@neo4j
    @@@jolt("${#recipe['jolts']['joltNeo4jTableToJson']}")
    @@@set("allIssues")
    
    MATCH (i:Issue:JiraReport)
    OPTIONAL MATCH (i)-[:ASSIGNED_TO]->(u:User:JiraReport)
    OPTIONAL MATCH (i)-[:BELONGS_TO_EPIC]->(e:Epic:JiraReport)
    RETURN i.key AS issueKey,
           i.summary AS summary,
           i.status AS status,
           i.priority AS priority,
           i.issueType AS issueType,
           COALESCE(i.storyPoints, 0) AS storyPoints,
           COALESCE(u.name, 'Unassigned') AS assigneeName,
           COALESCE(u.accountId, 'unassigned') AS assigneeId,
           e.key AS epicKey
    ORDER BY i.updatedDate DESC
  queryDailyChanges: |-
    @@@log("#FF00FFQuerying daily status changes...")
    @@@freemarker
    @@@neo4j
    @@@jolt("${#recipe['jolts']['joltNeo4jTableToJson']}")
    @@@set("dailyChanges")
    
    OPTIONAL MATCH (i:Issue:JiraReport)-[:STATUS_CHANGED]->(sc:StatusChange:JiraReport)
    WITH CASE WHEN sc IS NOT NULL THEN date(sc.date) ELSE null END AS day,
         CASE WHEN sc IS NOT NULL THEN collect({
           issueKey: i.key,
           summary: i.summary,
           from: sc.from,
           to: sc.to,
           author: sc.author
         }) ELSE [] END AS changes
    WHERE day IS NOT NULL
    RETURN toString(day) AS date,
           size([c IN changes WHERE c.to IN ['Done', 'Closed', 'Resolved']]) AS completed,
           size([c IN changes WHERE c.to = 'In Progress']) AS started,
           size([c IN changes WHERE c.to CONTAINS 'Block']) AS blocked,
           changes
    ORDER BY day DESC
    LIMIT ${$api.configs.options.daysBack!14}
  queryProjectStats: |-
    @@@log("#FF00FFQuerying project statistics...")
    @@@neo4j
    @@@jolt("${#recipe['jolts']['joltNeo4jTableToJson']}")
    @@@set("projectStats")
    
    OPTIONAL MATCH (i:Issue:JiraReport)
    WITH count(i) AS totalIssues,
         count(CASE WHEN i.status IN ['Done', 'Closed', 'Resolved'] THEN 1 END) AS completedIssues,
         count(CASE WHEN i.status = 'In Progress' THEN 1 END) AS inProgress,
         count(CASE WHEN i.status = 'Open' THEN 1 END) AS open,
         count(CASE WHEN i.status CONTAINS 'Block' THEN 1 END) AS blocked,
         COALESCE(sum(i.storyPoints), 0) AS totalPoints,
         COALESCE(sum(CASE WHEN i.status IN ['Done', 'Closed', 'Resolved'] THEN i.storyPoints ELSE 0 END), 0) AS completedPoints
    OPTIONAL MATCH (u:User:JiraReport)
    WHERE u.accountId <> 'unassigned'
    WITH totalIssues, completedIssues, inProgress, open, blocked, totalPoints, completedPoints, count(u) AS totalUsers
    OPTIONAL MATCH (e:Epic:JiraReport)
    RETURN totalIssues,
           completedIssues,
           inProgress,
           open,
           blocked,
           totalPoints,
           completedPoints,
           totalUsers,
           count(e) AS totalEpics,
           CASE WHEN totalIssues > 0
                THEN round(100.0 * completedIssues / totalIssues, 1)
                ELSE 0.0 END AS overallProgress

  prepareAnalyticsDataForLLM: |-
    @@@log("#00FF00Preparing analytics data for LLM...")
    @@@get("projectStats")
    @@@jsonify
    @@@set("projectStatsJson")
    @@@get("dailyChanges")
    @@@jsonify
    @@@set("dailyChangesJson")
    @@@get("allUsers")
    @@@jsonify
    @@@set("allUsersJson")
    @@@get("allEpics")
    @@@jsonify
    @@@set("allEpicsJson")
    @@@log("${'Analytics data prepared for LLM'}")
  prepareUserDataForLLM: |-
    @@@log("${'Preparing user data for LLM - file: ' + #fileNameWithoutExtension}")
    @@@spel("${T(java.lang.Integer).parseInt(#fileNameWithoutExtension.replaceAll('[^0-9]', ''))}")
    @@@set("userIndex")
    @@@spel("${#allUsers[#userIndex]}")
    @@@set("currentUser")
    @@@log("${'Processing user: ' + #currentUser['userName'] + ' (' + #currentUser['userId'] + ')'}")
  prepareEpicDataForLLM: |-
    @@@log("${'Preparing epic data for LLM - file: ' + #fileNameWithoutExtension}")
    @@@spel("${T(java.lang.Integer).parseInt(#fileNameWithoutExtension.replaceAll('[^0-9]', ''))}")
    @@@set("epicIndex")
    @@@spel("${#allEpics[#epicIndex]}")
    @@@set("currentEpic")
    @@@log("${'Processing epic: ' + #currentEpic['epicName'] + ' (' + #currentEpic['epicKey'] + ')'}")
  generateIndexReport: |-
    @@@log("#00FFFF========================================")
    @@@log("#00FFFFPHASE 7: GENERATING REPORTS")
    @@@log("#00FFFF========================================")
    @@@freemarker
    
    <!DOCTYPE html>
    <html lang="en">
    <head>
      <meta charset="UTF-8">
      <title>Jira Daily Report - ${$api.configs.options.jiraProjectKey}</title>
      <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          min-height: 100vh;
          padding: 2rem;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        header {
          background: white;
          padding: 2rem;
          border-radius: 12px;
          margin-bottom: 2rem;
          box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        h1 { color: #667eea; font-size: 2.5rem; margin-bottom: 0.5rem; }
        .meta { color: #64748b; font-size: 1.1rem; }
        .grid {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
          gap: 1.5rem;
          margin-bottom: 2rem;
        }
        .stat-card {
          background: white;
          padding: 1.5rem;
          border-radius: 12px;
          box-shadow: 0 2px 8px rgba(0,0,0,0.05);
          text-align: center;
        }
        .stat-card h3 { font-size: 0.875rem; text-transform: uppercase; color: #64748b; margin-bottom: 0.5rem; }
        .stat-card .number { font-size: 2.5rem; font-weight: 700; color: #667eea; }
        .card {
          background: white;
          padding: 2rem;
          border-radius: 12px;
          box-shadow: 0 2px 8px rgba(0,0,0,0.05);
          margin-bottom: 1.5rem;
        }
        .card h2 { color: #667eea; margin-bottom: 1rem; }
        .link-grid {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
          gap: 1rem;
        }
        .link-card {
          background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
          padding: 1.5rem;
          border-radius: 8px;
          text-decoration: none;
          color: #1e293b;
          transition: transform 0.2s;
          border-left: 4px solid #667eea;
        }
        .link-card:hover { transform: translateY(-4px); box-shadow: 0 8px 16px rgba(0,0,0,0.1); }
        .link-card h3 { font-size: 1.1rem; margin-bottom: 0.5rem; color: #667eea; }
        .link-card p { font-size: 0.875rem; color: #64748b; }
        footer {
          text-align: center;
          color: white;
          margin-top: 2rem;
          opacity: 0.9;
        }
      </style>
    </head>
    <body>
      <div class="container">
        <header>
          <h1>üìä Daily Project Report</h1>
          <div class="meta">
            Project: <strong>${$api.configs.options.jiraProjectKey}</strong> ‚Ä¢
            Generated: <strong>${.now?string("yyyy-MM-dd HH:mm")}</strong> ‚Ä¢
            Period: <strong>Last ${$api.configs.options.daysBack} days</strong>
          </div>
        </header>
    
        <!-- Project Stats -->
        <div class="grid">
          <#if projectStats?? && projectStats?has_content>
          <#assign stats = projectStats[0]>
          <div class="stat-card">
            <h3>Total Issues</h3>
            <div class="number">${stats.totalIssues!0}</div>
          </div>
          <div class="stat-card">
            <h3>Completed</h3>
            <div class="number">${stats.completedIssues!0}</div>
          </div>
          <div class="stat-card">
            <h3>In Progress</h3>
            <div class="number">${stats.inProgress!0}</div>
          </div>
          <div class="stat-card">
            <h3>Overall Progress</h3>
            <div class="number">${stats.overallProgress!0}%</div>
          </div>
          </#if>
        </div>
    
        <!-- Navigation Links -->
        <div class="card">
          <h2>üìã Reports</h2>
          <div class="link-grid">
            <a href="executive-summary.html" class="link-card">
              <h3>üìã Executive Summary</h3>
              <p>Daily highlights and key insights</p>
            </a>
            <a href="issues.html" class="link-card">
              <h3>üêõ All Issues</h3>
              <p>Complete issue listing</p>
            </a>
          </div>
        </div>
    
        <div class="card">
          <h2>üë• By User</h2>
          <div class="link-grid">
            <#if allUsers??>
              <#list allUsers as user>
              <a href="users/user_${user?index?string('0000')}.html" class="link-card">
                <h3>${user.userName!"Unknown"}</h3>
                <p>${user.totalIssues!0} issues ‚Ä¢ ${user.completionRate!0}% complete</p>
              </a>
              </#list>
            </#if>
          </div>
        </div>
    
        <div class="card">
          <h2>üéØ By Epic</h2>
          <#if allEpics?? && allEpics?has_content>
          <div class="link-grid">
              <#list allEpics as epic>
              <a href="epics/epic_${epic?index?string('0000')}.html" class="link-card">
                <h3>${epic.epicKey}</h3>
                <p>${epic.totalIssues!0} issues ‚Ä¢ ${epic.progress!0}% complete</p>
              </a>
              </#list>
          </div>
          <#else>
          <div style="padding: 2rem; text-align: center; color: #64748b; background: #f8fafc; border-radius: 8px;">
            <div style="font-size: 2.5rem; margin-bottom: 0.75rem;">üì≠</div>
            <p style="font-weight: 600; color: #475569; margin-bottom: 0.5rem;">No epics found</p>
            <p style="font-size: 0.875rem;">
              Issues may not be linked to epics, or epics have not been updated in the last ${$api.configs.options.daysBack} days.
            </p>
          </div>
          </#if>
        </div>
    
        <footer>
          <p>Generated by Synthesis Engine ‚Ä¢ Powered by Neo4j & Azure OpenAI</p>
        </footer>
      </div>
    </body>
    </html>
  prepareExecutiveSummaryData: |-
    @@@log("#00FF00=== STAGE 1: Preparing Executive Summary Data ===")
    @@@get("projectStats")
    @@@set("execStats")
    @@@get("allUsers")
    @@@set("execUsers")
    @@@get("allEpics")
    @@@set("execEpics")
    @@@get("allIssues")
    @@@set("execIssues")
    @@@freemarker
    @@@set("executiveDataJson")
    
    <#if execStats?? && execStats?has_content>
    <#assign stats = execStats[0]>
    {
      "project": {
        "key": "${$api.configs.options.jiraProjectKey}",
        "name": "Project Analysis",
        "period": "Last ${$api.configs.options.daysBack} days"
      },
      "metrics": {
        "totalIssues": ${stats.totalIssues!0},
        "completedIssues": ${stats.completedIssues!0},
        "inProgress": ${stats.inProgress!0},
        "blocked": ${stats.blocked!0},
        "totalPoints": ${stats.totalPoints!0},
        "completedPoints": ${stats.completedPoints!0},
        "overallProgress": ${stats.overallProgress!0}
      },
      "team": {
        "totalUsers": ${(execUsers?size)!0},
        "activeUsers": [
          <#if execUsers?? && execUsers?has_content>
          <#list execUsers as user>
          {
            "name": "${user.userName!'Unknown'}",
            "email": "${user.userEmail!'N/A'}",
            "totalIssues": ${user.totalIssues!0},
            "completed": ${user.completed!0},
            "completionRate": ${user.completionRate!0}
          }<#if user?has_next>,</#if>
          </#list>
          </#if>
        ]
      },
      "epics": {
        "totalEpics": ${(execEpics?size)!0},
        "epicList": [
          <#if execEpics?? && execEpics?has_content>
          <#list execEpics as epic>
          {
            "key": "${epic.epicKey!'UNKNOWN'}",
            "name": "${epic.epicName!'Unnamed Epic'}",
            "totalIssues": ${epic.totalIssues!0},
            "completed": ${epic.completed!0},
            "progress": ${epic.progress!0}
          }<#if epic?has_next>,</#if>
          </#list>
          </#if>
        ]
      },
      "issues": {
        "total": ${(execIssues?size)!0},
        "byPriority": {
          <#assign highCount = 0>
          <#assign mediumCount = 0>
          <#assign lowCount = 0>
          <#if execIssues?? && execIssues?has_content>
          <#list execIssues as issue>
            <#if issue.priority?? && (issue.priority == 'High' || issue.priority == 'Highest')>
              <#assign highCount = highCount + 1>
            <#elseif issue.priority?? && issue.priority == 'Medium'>
              <#assign mediumCount = mediumCount + 1>
            <#else>
              <#assign lowCount = lowCount + 1>
            </#if>
          </#list>
          </#if>
          "high": ${highCount},
          "medium": ${mediumCount},
          "low": ${lowCount}
        }
      }
    }
    </#if>
  generateExecutiveSummaryAnalysis: |-
    @@@_exec("${#recipe['templates']['prepareExecutiveSummaryData']}")
    @@@freemarker
    @@@closellmthread
    @@@agent("EXECUTIVE_SUMMARY_AGENT")
    @@@set("executiveSummaryAnalysis")
    
     You are a senior executive analyst reviewing a Jira project. Generate a comprehensive, data-driven executive summary for CEO/CTO audience.

    [COMPREHENSIVE PROJECT DATA]
    ${executiveDataJson}

    [ANALYSIS REQUIREMENTS]
    Provide a thorough executive analysis covering:

    1. **Overall Health & Status** (2-3 paragraphs):
       - Current project state and velocity
       - Key performance indicators and trends
       - Resource allocation and team capacity

    2. **Critical Insights** (3-4 paragraphs):
       - Major achievements and completed milestones
       - Identified risks, blockers, and bottlenecks
       - Team performance and collaboration patterns
       - Epic progress and delivery timeline concerns

    3. **Strategic Recommendations** (2-3 paragraphs):
       - Immediate action items (next 1-2 weeks)
       - Medium-term improvements (next month)
       - Resource reallocation suggestions
       - Process optimization opportunities

    [OUTPUT FORMAT]
    Return 7-10 HTML paragraphs (500-700 words total) organized in sections.

    [FORMATTING RULES]
    - Return ONLY <p> tags with content - NO <div>, NO <h2>, NO wrapper elements
    - Use semantic classes:
      * <span class="highlight">text</span> for key metrics
      * <span class="risk">text</span> for risks/concerns/blockers
      * <span class="success">text</span> for achievements/wins
    - Use <strong> for section headers and emphasis
    - Be specific with numbers, names, and data points from the provided JSON data
    - Provide actionable, concrete recommendations

    [EXAMPLE OUTPUT STRUCTURE]
    <p><strong>Overall Project Health:</strong> Analyze the project metrics including completion rates, story points delivered, and overall progress. Highlight strong momentum or areas of concern based on the data.</p>

    <p><strong>Team Performance:</strong> Evaluate team size, workload distribution, and individual performance. Identify top performers and potential bottlenecks based on the user metrics provided.</p>

    <p><strong>Critical Risks:</strong> Identify blocked issues, high-priority pending items, and epic dependencies that require immediate attention.</p>

    <p><strong>Recommendations:</strong> Provide specific, numbered action items to address blockers, redistribute workload, and maintain project momentum.</p>

    Generate the comprehensive executive summary now:
  generateExecutiveSummary: |-
    @@@_exec("${#recipe['templates']['generateExecutiveSummaryAnalysis']}")
    @@@freemarker
    
    <!DOCTYPE html>
    <html lang="en">
    <head>
      <meta charset="UTF-8">
      <title>Executive Summary - ${$api.configs.options.jiraProjectKey}</title>
      <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          min-height: 100vh;
          padding: 2rem;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        .back {
          display: inline-block;
          margin-bottom: 1rem;
          color: white;
          text-decoration: none;
          font-weight: 500;
          opacity: 0.9;
        }
        .back:hover { text-decoration: underline; opacity: 1; }
        header {
          background: white;
          color: #1e293b;
          padding: 2rem;
          border-radius: 12px;
          margin-bottom: 2rem;
          box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        h1 { font-size: 2.5rem; margin-bottom: 0.5rem; color: #667eea; }
        .subtitle { opacity: 0.7; font-size: 1.1rem; color: #64748b; }
    
        .grid {
          display: grid;
          grid-template-columns: repeat(4, 1fr);
          gap: 1rem;
          margin-bottom: 2rem;
        }
        .stat {
          background: white;
          padding: 1.5rem;
          border-radius: 12px;
          text-align: center;
          box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .stat .number { font-size: 2rem; font-weight: 700; color: #667eea; }
        .stat .label {
          font-size: 0.875rem;
          color: #64748b;
          text-transform: uppercase;
          margin-top: 0.5rem;
          letter-spacing: 0.5px;
        }
    
        .card {
          background: white;
          padding: 2.5rem;
          border-radius: 12px;
          box-shadow: 0 2px 8px rgba(0,0,0,0.05);
          margin-bottom: 2rem;
        }
        .card h2 {
          color: #1e293b;
          margin-bottom: 1.5rem;
          font-size: 1.75rem;
          border-bottom: 2px solid #e2e8f0;
          padding-bottom: 0.75rem;
        }
        .card p {
          font-size: 1.05rem;
          line-height: 1.9;
          color: #475569;
          margin-bottom: 1.5rem;
          text-align: justify;
        }
        .card p:last-child {
          margin-bottom: 0;
        }
    
        .highlight {
          background: #fef3c7;
          padding: 0.2rem 0.5rem;
          border-radius: 4px;
          font-weight: 600;
        }
        .risk {
          color: #dc2626;
          font-weight: 700;
          background: #fee2e2;
          padding: 0.2rem 0.5rem;
          border-radius: 4px;
        }
        .success {
          color: #059669;
          font-weight: 700;
          background: #d1fae5;
          padding: 0.2rem 0.5rem;
          border-radius: 4px;
        }
    
        footer {
          text-align: center;
          color: white;
          margin-top: 2rem;
          padding: 1.5rem;
          font-size: 0.875rem;
          opacity: 0.9;
        }
      </style>
    </head>
    <body>
      <div class="container">
        <a href="index.html" class="back">‚Üê Back to Dashboard</a>
        <header>
          <h1>üìã Executive Summary</h1>
          <p class="subtitle">Project: ${$api.configs.options.jiraProjectKey} ‚Ä¢ ${.now?string("yyyy-MM-dd")}</p>
        </header>
    
        <#if projectStats?? && projectStats?has_content>
        <#assign stats = projectStats[0]>
        <div class="grid">
          <div class="stat">
            <div class="number">${stats.totalIssues!0}</div>
            <div class="label">Total Issues</div>
          </div>
          <div class="stat">
            <div class="number">${stats.completedIssues!0}</div>
            <div class="label">Completed</div>
          </div>
          <div class="stat">
            <div class="number">${stats.totalPoints!0}</div>
            <div class="label">Story Points</div>
          </div>
          <div class="stat">
            <div class="number">${stats.overallProgress!0}%</div>
            <div class="label">Overall Progress</div>
          </div>
        </div>
    
        <div class="card">
          <h2>Executive Analysis</h2>
          ${executiveSummaryAnalysis!'<p>No analysis available</p>'}
        </div>
        </#if>
    
        <footer>
          <p>Generated by Synthesis Engine ‚Ä¢ Powered by Neo4j & Azure OpenAI</p>
        </footer>
      </div>
    </body>
    </html>
  prepareUserReportData: |-
    @@@log("${'=== STAGE 1: Preparing User Report Data for ' + #fileNameWithoutExtension + ' ==='}")
    @@@spel("${T(java.lang.Integer).parseInt(#fileNameWithoutExtension.replaceAll('[^0-9]', ''))}")
    @@@set("userIndex")
    @@@spel("${#allUsers[#userIndex]}")
    @@@set("currentUser")
    @@@log("${'Processing user: ' + #currentUser['userName'] + ' (' + #currentUser['userId'] + ')'}")
    @@@get("allIssues")
    @@@set("allUserIssues")
    @@@freemarker
    @@@set("userDataJson")
    
    {
      "user": {
        "name": "${currentUser.userName!'Unknown'}",
        "email": "${currentUser.userEmail!'N/A'}",
        "id": "${currentUser.userId!'unknown'}"
      },
      "metrics": {
        "totalIssues": ${currentUser.totalIssues!0},
        "completed": ${currentUser.completed!0},
        "inProgress": ${currentUser.totalIssues!0 - currentUser.completed!0},
        "completionRate": ${currentUser.completionRate!0}
      },
      "issueDetails": [
        <#if allUserIssues?? && allUserIssues?has_content>
        <#assign userIssueCount = 0>
        <#list allUserIssues as issue>
          <#if issue.assigneeId?? && issue.assigneeId == currentUser.userId>
            <#if userIssueCount gt 0>,</#if>
            {
              "key": "${issue.issueKey!'UNKNOWN'}",
              "summary": "${issue.summary!'No summary'}",
              "type": "${issue.issueType!'Task'}",
              "priority": "${issue.priority!'Medium'}",
              "status": "${issue.status!'Unknown'}",
              "storyPoints": ${issue.storyPoints!0}
            }
            <#assign userIssueCount = userIssueCount + 1>
          </#if>
        </#list>
        </#if>
      ]
    }
  generateUserReportAnalysis: |-
    @@@_exec("${#recipe['templates']['prepareUserReportData']}")
    @@@freemarker
    @@@closellmthread
    @@@agent("USER_REPORT_AGENT")
    @@@set("userAnalysis")
    
    You are a team performance analyst. You MUST analyze ONLY the specific user provided below.

    # USER TO ANALYZE

    **User Name**: ${currentUser.userName}
    **User Email**: ${currentUser.userEmail}
    **User ID**: ${currentUser.userId}

    # FULL USER DATA (JSON)

    ${userDataJson}

    # CRITICAL INSTRUCTIONS

    ‚ö†Ô∏è **MANDATORY**: Analyze ONLY **${currentUser.userName}** (ID: ${currentUser.userId})

    ‚ùå DO NOT analyze any other user
    ‚ùå DO NOT use generic team-wide analysis
    ‚ùå DO NOT mention any user other than **${currentUser.userName}**
    ‚úÖ ONLY reference issues from the issueDetails array above
    ‚úÖ ALWAYS use the user's name **${currentUser.userName}** when referring to them
    ‚úÖ START every paragraph with **${currentUser.userName}** or pronouns referring to them

    # ANALYSIS REQUIREMENTS

    Write a detailed performance analysis (300-400 words) for **${currentUser.userName}** covering:

    ## 1. Performance Overview (2 paragraphs)

    Start with: "**${currentUser.userName}** currently has..."

    - **${currentUser.userName}**'s current workload: ${currentUser.totalIssues} issues
    - **${currentUser.userName}**'s completion rate: ${currentUser.completionRate}%
    - Analysis of **${currentUser.userName}**'s completed vs in-progress tasks

    ## 2. Detailed Insights (2-3 paragraphs)

    - Distribution of **${currentUser.userName}**'s issues (by type, priority, status)
    - **${currentUser.userName}**'s specific strengths based on completed tasks
    - Potential bottlenecks in **${currentUser.userName}**'s workload
    - **${currentUser.userName}**'s work patterns

    ## 3. Actionable Recommendations (1-2 paragraphs)

    - Specific suggestions for **${currentUser.userName}** to improve
    - Workload optimization for **${currentUser.userName}**
    - Skills development needs for **${currentUser.userName}**

    # OUTPUT FORMAT

    Return 5-7 HTML <p> tags (NO wrapper elements).

    # FORMATTING RULES

    - Use <strong> for section headers
    - Use <span class="highlight"> for metrics
    - Use <span class="success"> for strengths
    - Use <span class="risk"> for concerns
    - Reference specific issue keys (e.g., LMT-123) from issueDetails array
    - ALWAYS refer to the user as **${currentUser.userName}** or use pronouns

    # SPECIAL CASE

    If ${currentUser.totalIssues} = 0, write:

    "<p><strong>${currentUser.userName}</strong> has no assigned issues in the current period (last ${$api.configs.options.daysBack} days). This may indicate that they are not actively working on tracked tasks, or their work is not being logged in Jira.</p>"

    # VALIDATION BEFORE RETURNING

    Before you return your analysis, verify:
    - ‚úÖ Did you mention **${currentUser.userName}** by name at least 5 times?
    - ‚úÖ Did you reference their metrics (${currentUser.totalIssues} issues, ${currentUser.completionRate}% completion)?
    - ‚úÖ Did you avoid mentioning any other user's name?

    # GENERATE ANALYSIS NOW

    Analyze **${currentUser.userName}** (${currentUser.userEmail}):
  generateUserReport: |-
    @@@_exec("${#recipe['templates']['generateUserReportAnalysis']}")
    @@@freemarker
    
    <!DOCTYPE html>
    <html lang="en">
    <head>
      <meta charset="UTF-8">
      <title>${currentUser.userName} - User Report</title>
      <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          min-height: 100vh;
          padding: 2rem;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        .back {
          display: inline-block;
          margin-bottom: 1rem;
          color: white;
          text-decoration: none;
          font-weight: 500;
          opacity: 0.9;
        }
        .back:hover { text-decoration: underline; opacity: 1; }
        header {
          background: white;
          color: #1e293b;
          padding: 2rem;
          border-radius: 12px;
          margin-bottom: 2rem;
          box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        h1 { font-size: 2.5rem; margin-bottom: 0.5rem; color: #10b981; }
        header p { opacity: 0.7; font-size: 1.1rem; color: #64748b; }
    
        .grid {
          display: grid;
          grid-template-columns: repeat(3, 1fr);
          gap: 1rem;
          margin-bottom: 2rem;
        }
        .stat {
          background: white;
          padding: 1.5rem;
          border-radius: 12px;
          text-align: center;
          box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .stat .number { font-size: 2rem; font-weight: 700; color: #10b981; }
        .stat .label {
          font-size: 0.875rem;
          color: #64748b;
          text-transform: uppercase;
          margin-top: 0.5rem;
          letter-spacing: 0.5px;
        }
    
        .card {
          background: white;
          padding: 2.5rem;
          border-radius: 12px;
          box-shadow: 0 2px 8px rgba(0,0,0,0.05);
          margin-bottom: 2rem;
        }
        .card h2 {
          color: #1e293b;
          margin-bottom: 1.5rem;
          font-size: 1.5rem;
          border-bottom: 2px solid #e2e8f0;
          padding-bottom: 0.75rem;
        }
        .card p {
          font-size: 1.05rem;
          line-height: 1.9;
          color: #475569;
          margin-bottom: 1.5rem;
          text-align: justify;
        }
        .card p:last-child {
          margin-bottom: 0;
        }
    
        .highlight {
          background: #fef3c7;
          padding: 0.2rem 0.5rem;
          border-radius: 4px;
          font-weight: 600;
        }
        .risk {
          color: #dc2626;
          font-weight: 700;
          background: #fee2e2;
          padding: 0.2rem 0.5rem;
          border-radius: 4px;
        }
        .success {
          color: #059669;
          font-weight: 700;
          background: #d1fae5;
          padding: 0.2rem 0.5rem;
          border-radius: 4px;
        }
    
        .progress {
          width: 100%;
          height: 12px;
          background: #e2e8f0;
          border-radius: 6px;
          overflow: hidden;
          box-shadow: inset 0 2px 4px rgba(0,0,0,0.06);
        }
        .progress-bar {
          height: 100%;
          background: linear-gradient(90deg, #10b981 0%, #059669 100%);
          transition: width 0.3s ease;
          box-shadow: 0 0 10px rgba(16, 185, 129, 0.5);
        }
    
        footer {
          text-align: center;
          color: white;
          margin-top: 2rem;
          padding: 1.5rem;
          font-size: 0.875rem;
          opacity: 0.9;
        }
      </style>
    </head>
    <body>
      <div class="container">
        <a href="../index.html" class="back">‚Üê Back to Dashboard</a>
        <header>
          <h1>üë§ ${currentUser.userName}</h1>
          <p>${currentUser.userEmail}</p>
        </header>
    
        <div class="grid">
          <div class="stat">
            <div class="number">${currentUser.totalIssues!0}</div>
            <div class="label">Total Issues</div>
          </div>
          <div class="stat">
            <div class="number">${currentUser.completed!0}</div>
            <div class="label">Completed</div>
          </div>
          <div class="stat">
            <div class="number">${currentUser.completionRate!0}%</div>
            <div class="label">Completion Rate</div>
          </div>
        </div>
    
        <div class="card">
          <h2>Progress Overview</h2>
          <div class="progress">
            <div class="progress-bar" style="width: ${currentUser.completionRate!0}%"></div>
          </div>
        </div>
    
        <div class="card">
          <h2>Performance Analysis</h2>
          ${userAnalysis!'<p>No analysis available</p>'}
        </div>
    
        <footer>
          <p>Generated by Synthesis Engine ‚Ä¢ Powered by Neo4j & Azure OpenAI</p>
        </footer>
      </div>
    </body>
    </html>

  prepareEpicReportData: |-
    @@@log("${'=== STAGE 1: Preparing Epic Report Data for ' + #fileNameWithoutExtension + ' ==='}")
    @@@spel("${T(java.lang.Integer).parseInt(#fileNameWithoutExtension.replaceAll('[^0-9]', ''))}")
    @@@set("epicIndex")
    @@@spel("${#allEpics[#epicIndex]}")
    @@@set("currentEpic")
    @@@log("${'Processing epic: ' + #currentEpic['epicName'] + ' (' + #currentEpic['epicKey'] + ')'}")
    @@@get("allIssues")
    @@@set("allEpicIssues")
    @@@freemarker
    @@@set("epicDataJson")
    
    {
      "epic": {
        "key": "${currentEpic.epicKey!'UNKNOWN'}",
        "name": "${currentEpic.epicName!'Unnamed Epic'}"
      },
      "metrics": {
        "totalIssues": ${currentEpic.totalIssues!0},
        "completed": ${currentEpic.completed!0},
        "inProgress": ${currentEpic.totalIssues!0 - currentEpic.completed!0},
        "progress": ${currentEpic.progress!0}
      },
      "issueDetails": [
        <#if allEpicIssues?? && allEpicIssues?has_content>
        <#assign epicIssueCount = 0>
        <#list allEpicIssues as issue>
          <#if issue.epicKey?? && issue.epicKey == currentEpic.epicKey>
            <#if epicIssueCount gt 0>,</#if>
            {
              "key": "${issue.issueKey!'UNKNOWN'}",
              "summary": "${issue.summary!'No summary'}",
              "type": "${issue.issueType!'Task'}",
              "priority": "${issue.priority!'Medium'}",
              "status": "${issue.status!'Unknown'}",
              "assignee": "${issue.assigneeName!'Unassigned'}",
              "storyPoints": ${issue.storyPoints!0}
            }
            <#assign epicIssueCount = epicIssueCount + 1>
          </#if>
        </#list>
        </#if>
      ]
    }
  generateEpicReportAnalysis: |-
    @@@_exec("${#recipe['templates']['prepareEpicReportData']}")
    @@@freemarker
    @@@closellmthread
    @@@agent("EPIC_REPORT_AGENT")
    @@@set("epicAnalysis")
    
    You are a project delivery analyst. You MUST analyze ONLY the specific epic provided below.

    # EPIC TO ANALYZE

    **Epic Key**: ${currentEpic.epicKey}
    **Epic Name**: ${currentEpic.epicName}

    # FULL EPIC DATA (JSON)

    ${epicDataJson}

    # CRITICAL INSTRUCTIONS

    ‚ö†Ô∏è **MANDATORY**: Analyze ONLY **${currentEpic.epicKey}** (${currentEpic.epicName})

    ‚ùå DO NOT analyze any other epic
    ‚ùå DO NOT use generic project-wide analysis
    ‚ùå DO NOT mention any epic other than **${currentEpic.epicKey}**
    ‚úÖ ONLY reference issues from the issueDetails array above
    ‚úÖ ALWAYS use the epic key **${currentEpic.epicKey}** or name **${currentEpic.epicName}** when referring to it
    ‚úÖ START every paragraph with **${currentEpic.epicKey}** or pronouns referring to it

    # ANALYSIS REQUIREMENTS

    Write a detailed delivery analysis (300-400 words) for **${currentEpic.epicKey}** covering:

    ## 1. Delivery Status (2 paragraphs)

    Start with: "**${currentEpic.epicKey}** (${currentEpic.epicName}) currently has..."

    - **${currentEpic.epicKey}**'s total issues: ${currentEpic.totalIssues}
    - **${currentEpic.epicKey}**'s progress: ${currentEpic.progress}%
    - Analysis of **${currentEpic.epicKey}**'s completed vs in-progress issues

    ## 2. Risk & Dependency Analysis (2-3 paragraphs)

    - Distribution of **${currentEpic.epicKey}**'s issues (by type, priority, status)
    - Blocked or at-risk items within **${currentEpic.epicKey}**
    - Team members working on **${currentEpic.epicKey}**
    - Dependencies within **${currentEpic.epicKey}**'s issue list

    ## 3. Strategic Recommendations (1-2 paragraphs)

    - Actions to accelerate **${currentEpic.epicKey}**'s delivery
    - Risk mitigation strategies for **${currentEpic.epicKey}**
    - Resource reallocation needs for **${currentEpic.epicKey}**

    # OUTPUT FORMAT

    Return 5-7 HTML <p> tags (NO wrapper elements).

    # FORMATTING RULES

    - Use <strong> for section headers
    - Use <span class="highlight"> for metrics
    - Use <span class="success"> for achievements
    - Use <span class="risk"> for risks/blockers
    - Reference specific issue keys (e.g., LMT-123) from issueDetails array
    - Reference specific assignees working on this epic
    - ALWAYS refer to the epic as **${currentEpic.epicKey}** or use pronouns

    # SPECIAL CASE

    If ${currentEpic.totalIssues} = 0, write:

    "<p><strong>${currentEpic.epicKey}</strong> (${currentEpic.epicName}) has no associated issues in the current period (last ${$api.configs.options.daysBack} days). This may indicate that issues are not linked to this epic, or no work has been logged recently.</p>"

    # VALIDATION BEFORE RETURNING

    Before you return your analysis, verify:
    - ‚úÖ Did you mention **${currentEpic.epicKey}** or **${currentEpic.epicName}** by name at least 5 times?
    - ‚úÖ Did you reference the epic's metrics (${currentEpic.totalIssues} issues, ${currentEpic.progress}% progress)?
    - ‚úÖ Did you avoid mentioning any other epic?

    # GENERATE ANALYSIS NOW

    Analyze **${currentEpic.epicKey}** (${currentEpic.epicName}):
  generateEpicReport: |-
    @@@_exec("${#recipe['templates']['generateEpicReportAnalysis']}")
    @@@freemarker
    
    <!DOCTYPE html>
    <html lang="en">
    <head>
      <meta charset="UTF-8">
      <title>${currentEpic.epicKey} - Epic Report</title>
      <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          min-height: 100vh;
          padding: 2rem;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        .back {
          display: inline-block;
          margin-bottom: 1rem;
          color: white;
          text-decoration: none;
          font-weight: 500;
          opacity: 0.9;
        }
        .back:hover { text-decoration: underline; opacity: 1; }
        header {
          background: white;
          color: #1e293b;
          padding: 2rem;
          border-radius: 12px;
          margin-bottom: 2rem;
          box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        h1 { font-size: 2.5rem; margin-bottom: 0.5rem; color: #f59e0b; }
        header p { opacity: 0.7; font-size: 1.1rem; color: #64748b; }
    
        .grid {
          display: grid;
          grid-template-columns: repeat(3, 1fr);
          gap: 1rem;
          margin-bottom: 2rem;
        }
        .stat {
          background: white;
          padding: 1.5rem;
          border-radius: 12px;
          text-align: center;
          box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .stat .number { font-size: 2rem; font-weight: 700; color: #f59e0b; }
        .stat .label {
          font-size: 0.875rem;
          color: #64748b;
          text-transform: uppercase;
          margin-top: 0.5rem;
          letter-spacing: 0.5px;
        }
    
        .card {
          background: white;
          padding: 2.5rem;
          border-radius: 12px;
          box-shadow: 0 2px 8px rgba(0,0,0,0.05);
          margin-bottom: 2rem;
        }
        .card h2 {
          color: #1e293b;
          margin-bottom: 1.5rem;
          font-size: 1.5rem;
          border-bottom: 2px solid #e2e8f0;
          padding-bottom: 0.75rem;
        }
        .card p {
          font-size: 1.05rem;
          line-height: 1.9;
          color: #475569;
          margin-bottom: 1.5rem;
          text-align: justify;
        }
        .card p:last-child {
          margin-bottom: 0;
        }
    
        .highlight {
          background: #fef3c7;
          padding: 0.2rem 0.5rem;
          border-radius: 4px;
          font-weight: 600;
        }
        .risk {
          color: #dc2626;
          font-weight: 700;
          background: #fee2e2;
          padding: 0.2rem 0.5rem;
          border-radius: 4px;
        }
        .success {
          color: #059669;
          font-weight: 700;
          background: #d1fae5;
          padding: 0.2rem 0.5rem;
          border-radius: 4px;
        }
    
        .progress {
          width: 100%;
          height: 12px;
          background: #e2e8f0;
          border-radius: 6px;
          overflow: hidden;
          box-shadow: inset 0 2px 4px rgba(0,0,0,0.06);
        }
        .progress-bar {
          height: 100%;
          background: linear-gradient(90deg, #f59e0b 0%, #d97706 100%);
          transition: width 0.3s ease;
          box-shadow: 0 0 10px rgba(245, 158, 11, 0.5);
        }
    
        footer {
          text-align: center;
          color: white;
          margin-top: 2rem;
          padding: 1.5rem;
          font-size: 0.875rem;
          opacity: 0.9;
        }
      </style>
    </head>
    <body>
      <div class="container">
        <a href="../index.html" class="back">‚Üê Back to Dashboard</a>
        <header>
          <h1>üéØ ${currentEpic.epicKey}</h1>
          <p>${currentEpic.epicName}</p>
        </header>
    
        <div class="grid">
          <div class="stat">
            <div class="number">${currentEpic.totalIssues!0}</div>
            <div class="label">Total Issues</div>
          </div>
          <div class="stat">
            <div class="number">${currentEpic.completed!0}</div>
            <div class="label">Completed</div>
          </div>
          <div class="stat">
            <div class="number">${currentEpic.progress!0}%</div>
            <div class="label">Progress</div>
          </div>
        </div>
    
        <div class="card">
          <h2>Progress Overview</h2>
          <div class="progress">
            <div class="progress-bar" style="width: ${currentEpic.progress!0}%"></div>
          </div>
        </div>
    
        <div class="card">
          <h2>Epic Analysis</h2>
          ${epicAnalysis!'<p>No analysis available</p>'}
        </div>
    
        <footer>
          <p>Generated by Synthesis Engine ‚Ä¢ Powered by Neo4j & Azure OpenAI</p>
        </footer>
      </div>
    </body>
    </html>
  generateIssuesReport: |-
    @@@freemarker
    
    <!DOCTYPE html>
    <html lang="en">
    <head>
      <meta charset="UTF-8">
      <title>All Issues</title>
      <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          min-height: 100vh;
          padding: 2rem;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        .back {
          display: inline-block;
          margin-bottom: 1rem;
          color: white;
          text-decoration: none;
          font-weight: 500;
          opacity: 0.9;
        }
        .back:hover { text-decoration: underline; opacity: 1; }
    
        header {
          background: white;
          color: #1e293b;
          padding: 2rem;
          border-radius: 12px;
          margin-bottom: 2rem;
          box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        h1 { font-size: 2.5rem; margin-bottom: 0.5rem; color: #667eea; }
        header p { opacity: 0.7; font-size: 1.1rem; color: #64748b; }
    
        .table-wrapper {
          background: white;
          border-radius: 12px;
          overflow: hidden;
          box-shadow: 0 2px 8px rgba(0,0,0,0.05);
          margin-bottom: 2rem;
        }
    
        table {
          width: 100%;
          border-collapse: collapse;
        }
    
        th, td {
          padding: 1.25rem 1rem;
          text-align: left;
          border-bottom: 1px solid #e2e8f0;
        }
    
        th {
          background: #f8fafc;
          font-weight: 600;
          text-transform: uppercase;
          font-size: 0.75rem;
          color: #64748b;
          letter-spacing: 0.5px;
        }
    
        tbody tr {
          transition: background-color 0.15s ease;
        }
    
        tbody tr:hover {
          background-color: #f8fafc;
        }
    
        tbody tr:last-child td {
          border-bottom: none;
        }
    
        td {
          color: #475569;
          font-size: 0.95rem;
        }
    
        code {
          background: #f1f5f9;
          padding: 0.25rem 0.5rem;
          border-radius: 4px;
          font-size: 0.875rem;
          color: #667eea;
          font-weight: 600;
        }
    
        .badge {
          display: inline-block;
          padding: 0.35rem 0.85rem;
          border-radius: 12px;
          font-size: 0.75rem;
          font-weight: 600;
          text-transform: uppercase;
          letter-spacing: 0.3px;
        }
    
        .priority-High, .priority-Highest {
          background: #fee2e2;
          color: #991b1b;
        }
        .priority-Medium {
          background: #fef3c7;
          color: #92400e;
        }
        .priority-Low, .priority-Lowest {
          background: #dbeafe;
          color: #1e40af;
        }
    
        .status-Done, .status-Closed {
          color: #059669;
          font-weight: 600;
        }
    
        .status-In.Progress, .status-InProgress {
          color: #2563eb;
          font-weight: 600;
        }
    
        .status-Blocked {
          color: #dc2626;
          font-weight: 600;
        }
    
        footer {
          text-align: center;
          color: white;
          margin-top: 2rem;
          padding: 1.5rem;
          font-size: 0.875rem;
          opacity: 0.9;
        }
      </style>
    </head>
    <body>
      <div class="container">
        <a href="index.html" class="back">‚Üê Back to Dashboard</a>
        <header>
          <h1>üêõ All Issues</h1>
          <p>Complete list of project issues</p>
        </header>
    
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>Key</th>
                <th>Summary</th>
                <th>Type</th>
                <th>Priority</th>
                <th>Status</th>
                <th>Assignee</th>
              </tr>
            </thead>
            <tbody>
              <#if allIssues??>
                <#list allIssues as issue>
                <tr>
                  <td><code>${issue.issueKey!""}</code></td>
                  <td>${issue.summary!"No summary"}</td>
                  <td>${issue.issueType!"Unknown"}</td>
                  <td><span class="badge priority-${issue.priority!'Medium'}">${issue.priority!"Medium"}</span></td>
                  <td class="status-${(issue.status!'Unknown')?replace(' ', '.')}">${issue.status!"Unknown"}</td>
                  <td>${issue.assigneeName!"Unassigned"}</td>
                </tr>
                </#list>
              </#if>
            </tbody>
          </table>
        </div>
    
        <footer>
          <p>Generated by Synthesis Engine ‚Ä¢ Powered by Neo4j & Azure OpenAI</p>
        </footer>
      </div>
    </body>
    </html>