# This recipe generates the data-matrix.csv respecting the same logic of business-taxonomy
# task https://ilabs-capco.atlassian.net/browse/LMT-710
# data-matrix.csv is an input for monolith decomposition service to create the blue-print.json
# Data Matrix description:
#   For each paragraph of a certain Cobol program, it is indicated whether there is (1) or not (0) a relationship with any
#   component (e.g. cursor, table, variable) of the cobol program.
#   Rows represent paragraphs and columns represent the components.
#   The last column indicates which community the paragraph belongs to according to the elements and components with
#   which it has some relationship (direct or indirect).
# requirements:
#   pandas==2.3.3
#   networkx==3.5
#   numpy==2.3.3
#   sympy==1.14.0
# inputs:
# callgraph.txt - file generated by tech-files.yaml or tech-files-2.yaml
config:
  fresh: true
  transformDefaultParams:
    jolt:
      - "${#recipe['templates']['joltNeo4jTableToJson']}"
    neo4j:
      - "${@Utils.getEnvVariable('NEO4J_API_URI')}"
      - "${@Utils.createBasicAuthHeader(@Utils.getEnvVariable('NEO4J_USERNAME'), @Utils.getEnvVariable('NEO4J_PASSWORD'))}"
executor: ProjectModelExecutor3.java
projectModel:
  context:
    saveCallgraph:  "${#recipe['templates']['saveCallgraph']}"
  data_matrix.csv: |-
    @@@script("dataMatrixLegacy")
templates:
  saveCallgraph: |-
    @@@freemarker
    @@@decodeBase64
    @@@set("callgraphContent")
    ${$api.files['callgraph.txt']}
  joltNeo4jTableToJson: |-
    [
      {
        "operation": "shift",
        "spec": {
          "results": {
            "*": {
              "data": {
                "*": {
                  "row": {
                    "*": "[&2].@(4,columns[&0])"
                  }
                }
              }
            }
          }
        }
      }
    ]
scripts:
  dataMatrixLegacy:
    name: dataMatrixLegacy
    reference: dataMatrixLegacy.py
    type: PYTHON
    inject:
      callgraph_content: ${@Utils.nvl(#callgraphContent)}